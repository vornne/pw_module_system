from header_common import *
from header_presentations import *
from header_mission_templates import *
from header_operations import *
from header_triggers import *
from header_items import *
from module_constants import *
import header_debug as dbg
import header_lazy_evaluation as lazy

####################################################################################################################
#  Each presentation record contains the following fields:
#  1) Presentation id: used for referencing presentations in other files. The prefix prsnt_ is automatically added before each presentation id.
#  2) Presentation flags. See header_presentations.py for a list of available flags
#  3) Presentation background mesh: See module_meshes.py for a list of available background meshes
#  4) Triggers: Simple triggers that are associated with the presentation
####################################################################################################################

presentations = []
presentations.extend([

  ("game_credits",prsntf_read_only,"mesh_load_window",
   [(ti_on_presentation_load,
     [(assign, "$g_presentation_credits_obj_0", -1),
      (assign, "$g_presentation_credits_obj_1", -1),
      (assign, "$g_presentation_credits_obj_2", -1),
      (assign, "$g_presentation_credits_obj_3", -1),
      (assign, "$g_presentation_credits_obj_4", -1),
      (assign, "$g_presentation_credits_obj_5", -1),
      (assign, "$g_presentation_credits_obj_6", -1),
      (assign, "$g_presentation_credits_obj_7", -1),
      (assign, "$g_presentation_credits_obj_8", -1),
      (assign, "$g_presentation_credits_obj_9", -1),
      (assign, "$g_presentation_credits_obj_10", -1),
      (assign, "$g_presentation_credits_obj_11", -1),
      (assign, "$g_presentation_credits_obj_12", -1),
      (assign, "$g_presentation_credits_obj_0_alpha", 0),
      (assign, "$g_presentation_credits_obj_1_alpha", 0),
      (assign, "$g_presentation_credits_obj_2_alpha", 0),
      (assign, "$g_presentation_credits_obj_3_alpha", 0),
      (assign, "$g_presentation_credits_obj_4_alpha", 0),
      (assign, "$g_presentation_credits_obj_5_alpha", 0),
      (assign, "$g_presentation_credits_obj_6_alpha", 0),
      (assign, "$g_presentation_credits_obj_7_alpha", 0),
      (assign, "$g_presentation_credits_obj_8_alpha", 0),
      (assign, "$g_presentation_credits_obj_9_alpha", 0),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":cur_time"),
      (set_fixed_point_multiplier, 1000),
      (presentation_set_duration, 1000000),
      (try_begin),
        (this_or_next|key_clicked, key_space),
        (this_or_next|key_clicked, key_enter),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_back_space),
        (this_or_next|key_clicked, key_left_mouse_button),
        (key_clicked, key_right_mouse_button),
        (presentation_set_duration, 0),
      (try_end),
      (try_begin),
        (lt, "$g_presentation_credits_obj_0", 0),
        (str_store_string, s1, "str_credits_0"),
        (create_text_overlay, "$g_presentation_credits_obj_0", s1, tf_center_justify|tf_double_space|tf_vertical_align_center),
        (overlay_set_color, "$g_presentation_credits_obj_0", 0),
        (overlay_set_alpha, "$g_presentation_credits_obj_0", 0),
        (position_set_x, pos1, 1500),
        (position_set_y, pos1, 1500),
        (overlay_set_size, "$g_presentation_credits_obj_0", pos1),
        (position_set_x, pos1, 500),
        (position_set_y, pos1, 375),
        (overlay_set_position, "$g_presentation_credits_obj_0", pos1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_0", 1000, 0xFF),
      (else_try),
        (gt, ":cur_time", 2000),
        (eq, "$g_presentation_credits_obj_0_alpha", 0),
        (assign, "$g_presentation_credits_obj_0_alpha", 1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_0", 1000, 0x00),
      (else_try),
        (gt, ":cur_time", 2000 + 1500),
        (lt, "$g_presentation_credits_obj_1", 0),
        (str_store_string, s1, "str_credits_1"),
        (create_text_overlay, "$g_presentation_credits_obj_1", s1, tf_center_justify|tf_double_space|tf_vertical_align_center),
        (overlay_set_color, "$g_presentation_credits_obj_1", 0),
        (overlay_set_alpha, "$g_presentation_credits_obj_1", 0),
        (position_set_x, pos1, 1500),
        (position_set_y, pos1, 1500),
        (overlay_set_size, "$g_presentation_credits_obj_1", pos1),
        (position_set_x, pos1, 500),
        (position_set_y, pos1, 375),
        (overlay_set_position, "$g_presentation_credits_obj_1", pos1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_1", 1000, 0xFF),
      (else_try),
        (gt, ":cur_time", 2 * 2000 + 1500),
        (eq, "$g_presentation_credits_obj_1_alpha", 0),
        (assign, "$g_presentation_credits_obj_1_alpha", 1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_1", 1000, 0x00),
      (else_try),
        (gt, ":cur_time", 2 * 2000 + 2 * 1500),
        (lt, "$g_presentation_credits_obj_2", 0),
        (str_store_string, s1, "str_credits_2"),
        (create_text_overlay, "$g_presentation_credits_obj_2", s1, tf_center_justify|tf_double_space|tf_vertical_align_center),
        (overlay_set_color, "$g_presentation_credits_obj_2", 0),
        (overlay_set_alpha, "$g_presentation_credits_obj_2", 0),
        (position_set_x, pos1, 1750),
        (position_set_y, pos1, 1750),
        (overlay_set_size, "$g_presentation_credits_obj_2", pos1),
        (position_set_x, pos1, 500),
        (position_set_y, pos1, 375),
        (overlay_set_position, "$g_presentation_credits_obj_2", pos1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_2", 1000, 0xFF),
      (else_try),
        (gt, ":cur_time", 3 * 2000 + 2 * 1500),
        (eq, "$g_presentation_credits_obj_2_alpha", 0),
        (assign, "$g_presentation_credits_obj_2_alpha", 1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_2", 1000, 0x00),
      (else_try),
        (gt, ":cur_time", 3 * 2000 + 3 * 1500),
        (lt, "$g_presentation_credits_obj_3", 0),
        (str_store_string, s1, "str_credits_3"),
        (create_text_overlay, "$g_presentation_credits_obj_3", s1, tf_center_justify|tf_double_space|tf_vertical_align_center),
        (overlay_set_color, "$g_presentation_credits_obj_3", 0),
        (overlay_set_alpha, "$g_presentation_credits_obj_3", 0),
        (position_set_x, pos1, 1750),
        (position_set_y, pos1, 1750),
        (overlay_set_size, "$g_presentation_credits_obj_3", pos1),
        (position_set_x, pos1, 500),
        (position_set_y, pos1, 375),
        (overlay_set_position, "$g_presentation_credits_obj_3", pos1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_3", 1000, 0xFF),
      (else_try),
        (gt, ":cur_time", 4 * 2000 + 3 * 1500),
        (eq, "$g_presentation_credits_obj_3_alpha", 0),
        (assign, "$g_presentation_credits_obj_3_alpha", 1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_3", 1000, 0),
      (else_try),
        (gt, ":cur_time", 4 * 2000 + 4 * 1500),
        (lt, "$g_presentation_credits_obj_4", 0),
        (str_store_string, s1, "str_credits_4"),
        (create_text_overlay, "$g_presentation_credits_obj_4", s1, tf_center_justify|tf_double_space|tf_vertical_align_center),
        (overlay_set_color, "$g_presentation_credits_obj_4", 0),
        (overlay_set_alpha, "$g_presentation_credits_obj_4", 0),
        (position_set_x, pos1, 1750),
        (position_set_y, pos1, 1750),
        (overlay_set_size, "$g_presentation_credits_obj_4", pos1),
        (position_set_x, pos1, 500),
        (position_set_y, pos1, 375),
        (overlay_set_position, "$g_presentation_credits_obj_4", pos1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_4", 1000, 0xFF),
      (else_try),
        (gt, ":cur_time", 5 * 2000 + 4 * 1500),
        (eq, "$g_presentation_credits_obj_4_alpha", 0),
        (assign, "$g_presentation_credits_obj_4_alpha", 1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_4", 1000, 0),
      (else_try),
        (gt, ":cur_time", 5 * 2000 + 5 * 1500),
        (lt, "$g_presentation_credits_obj_5", 0),
        (str_store_string, s1, "str_credits_5"),
        (create_text_overlay, "$g_presentation_credits_obj_5", s1, tf_center_justify|tf_double_space|tf_vertical_align_center),
        (overlay_set_color, "$g_presentation_credits_obj_5", 0),
        (overlay_set_alpha, "$g_presentation_credits_obj_5", 0),
        (position_set_x, pos1, 1750),
        (position_set_y, pos1, 1750),
        (overlay_set_size, "$g_presentation_credits_obj_5", pos1),
        (position_set_x, pos1, 500),
        (position_set_y, pos1, 375),
        (overlay_set_position, "$g_presentation_credits_obj_5", pos1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_5", 1000, 0xFF),
      (else_try),
        (gt, ":cur_time", 6 * 2000 + 5 * 1500),
        (eq, "$g_presentation_credits_obj_5_alpha", 0),
        (assign, "$g_presentation_credits_obj_5_alpha", 1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_5", 1000, 0),
      (else_try),
        (gt, ":cur_time", 6 * 2000 + 6 * 1500),
        (lt, "$g_presentation_credits_obj_6", 0),
        (str_store_string, s1, "str_credits_6"),
        (create_text_overlay, "$g_presentation_credits_obj_6", s1, tf_center_justify|tf_double_space|tf_vertical_align_center),
        (overlay_set_color, "$g_presentation_credits_obj_6", 0),
        (overlay_set_alpha, "$g_presentation_credits_obj_6", 0),
        (position_set_x, pos1, 1750),
        (position_set_y, pos1, 1750),
        (overlay_set_size, "$g_presentation_credits_obj_6", pos1),
        (position_set_x, pos1, 500),
        (position_set_y, pos1, 375),
        (overlay_set_position, "$g_presentation_credits_obj_6", pos1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_6", 1000, 0xFF),
      (else_try),
        (gt, ":cur_time", 7 * 2000 + 6 * 1500),
        (eq, "$g_presentation_credits_obj_6_alpha", 0),
        (assign, "$g_presentation_credits_obj_6_alpha", 1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_6", 1000, 0),
      (else_try),
        (gt, ":cur_time", 7 * 2000 + 7 * 1500),
        (lt, "$g_presentation_credits_obj_7", 0),
        (str_store_string, s1, "str_credits_7"),
        (create_text_overlay, "$g_presentation_credits_obj_7", s1, tf_center_justify|tf_double_space|tf_vertical_align_center),
        (overlay_set_color, "$g_presentation_credits_obj_7", 0),
        (overlay_set_alpha, "$g_presentation_credits_obj_7", 0),
        (position_set_x, pos1, 1750),
        (position_set_y, pos1, 1750),
        (overlay_set_size, "$g_presentation_credits_obj_7", pos1),
        (position_set_x, pos1, 500),
        (position_set_y, pos1, 375),
        (overlay_set_position, "$g_presentation_credits_obj_7", pos1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_7", 1000, 0xFF),
      (else_try),
        (gt, ":cur_time", 8 * 2000 + 7 * 1500),
        (eq, "$g_presentation_credits_obj_7_alpha", 0),
        (assign, "$g_presentation_credits_obj_7_alpha", 1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_7", 1000, 0),
      (else_try),
        (gt, ":cur_time", 8 * 2000 + 8 * 1500),
        (lt, "$g_presentation_credits_obj_8", 0),
        (str_store_string, s1, "str_credits_8"),
        (create_text_overlay, "$g_presentation_credits_obj_8", s1, tf_center_justify|tf_double_space|tf_vertical_align_center),
        (overlay_set_color, "$g_presentation_credits_obj_8", 0),
        (overlay_set_alpha, "$g_presentation_credits_obj_8", 0),
        (position_set_x, pos1, 1750),
        (position_set_y, pos1, 1750),
        (overlay_set_size, "$g_presentation_credits_obj_8", pos1),
        (position_set_x, pos1, 500),
        (position_set_y, pos1, 375),
        (overlay_set_position, "$g_presentation_credits_obj_8", pos1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_8", 1000, 0xFF),
      (else_try),
        (gt, ":cur_time", 9 * 2000 + 8 * 1500),
        (eq, "$g_presentation_credits_obj_8_alpha", 0),
        (assign, "$g_presentation_credits_obj_8_alpha", 1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_8", 1000, 0),
      (else_try),
        (gt, ":cur_time", 9 * 2000 + 9 * 1500),
        (lt, "$g_presentation_credits_obj_9", 0),
        (str_store_string, s1, "str_credits_10"),
        (create_text_overlay, "$g_presentation_credits_obj_9", s1, tf_center_justify|tf_double_space|tf_vertical_align_center),
        (overlay_set_color, "$g_presentation_credits_obj_9", 0),
        (overlay_set_alpha, "$g_presentation_credits_obj_9", 0),
        (position_set_x, pos1, 750),
        (position_set_y, pos1, 750),
        (overlay_set_size, "$g_presentation_credits_obj_9", pos1),
        (position_set_x, pos1, 250),
        (position_set_y, pos1, 485),
        (overlay_set_position, "$g_presentation_credits_obj_9", pos1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_9", 1000, 0xFF),

        (str_store_string, s1, "str_credits_11"),
        (create_text_overlay, "$g_presentation_credits_obj_10", s1, tf_center_justify|tf_double_space|tf_vertical_align_center),
        (overlay_set_color, "$g_presentation_credits_obj_10", 0),
        (overlay_set_alpha, "$g_presentation_credits_obj_10", 0),
        (position_set_x, pos1, 750),
        (position_set_y, pos1, 750),
        (overlay_set_size, "$g_presentation_credits_obj_10", pos1),
        (position_set_x, pos1, 750),
        (position_set_y, pos1, 470),
        (overlay_set_position, "$g_presentation_credits_obj_10", pos1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_10", 1000, 0xFF),

        (str_store_string, s1, "str_credits_12"),
        (create_text_overlay, "$g_presentation_credits_obj_11", s1, tf_center_justify|tf_double_space|tf_vertical_align_center),
        (overlay_set_color, "$g_presentation_credits_obj_11", 0),
        (overlay_set_alpha, "$g_presentation_credits_obj_11", 0),
        (position_set_x, pos1, 750),
        (position_set_y, pos1, 750),
        (overlay_set_size, "$g_presentation_credits_obj_11", pos1),
        (position_set_x, pos1, 500),
        (position_set_y, pos1, 105),
        (overlay_set_position, "$g_presentation_credits_obj_11", pos1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_11", 1000, 0xFF),
      (else_try),
        (gt, ":cur_time", 12 * 2000 + 9 * 1500),
        (eq, "$g_presentation_credits_obj_9_alpha", 0),
        (assign, "$g_presentation_credits_obj_9_alpha", 1),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_9", 1000, 0),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_10", 1000, 0),
        (overlay_animate_to_alpha, "$g_presentation_credits_obj_11", 1000, 0),
      (else_try),
        (gt, ":cur_time", 12 * 2000 + 10 * 1500),
        (lt, "$g_presentation_credits_obj_12", 0),
        (str_store_string, s1, "str_credits_9"),
        (create_text_overlay, "$g_presentation_credits_obj_12", s1, tf_center_justify|tf_double_space),
        (overlay_set_color, "$g_presentation_credits_obj_12", 0),
        (overlay_set_alpha, "$g_presentation_credits_obj_12", 0xFF),
        (position_set_x, pos1, 1000),
        (position_set_y, pos1, 1000),
        (overlay_set_size, "$g_presentation_credits_obj_12", pos1),
        (position_set_x, pos1, 500),
        (position_set_y, pos1, -4800),
        (overlay_set_position, "$g_presentation_credits_obj_12", pos1),
        (position_set_x, pos1, 500),
        (position_set_y, pos1, 760),
        (overlay_animate_to_position, "$g_presentation_credits_obj_12", 70000, pos1),
      (else_try),
        (gt, ":cur_time", 12 * 2000 + 10 * 1500 + 70000),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    ]),
  ])

def prsnt_create_profile_options_overlays():
  block = []
  for i, option in enumerate(profile_options):
    overlay_var = "$g_presentation_obj_profile_options_" + option[3:]
    block.extend([(create_text_overlay, reg0, lazy.add(profile_option_strings_begin, i, opmask_string), 0),
      (position_set_y, pos1, ":label_y"),
      (overlay_set_position, reg0, pos1),
      (val_sub, ":label_y", admin_panel_item_height),

      (create_check_box_overlay, overlay_var, "mesh_checkbox_off", "mesh_checkbox_on"),
      (position_set_y, pos2, ":checkbox_y"),
      (overlay_set_position, overlay_var, pos2),
      (overlay_set_val, overlay_var, option),
      (val_sub, ":checkbox_y", admin_panel_item_height),
      ])
  return lazy.block(block)

def prsnt_check_profile_options_overlays():
  block = []
  for option in profile_options:
    overlay_var = "$g_presentation_obj_profile_options_" + option[3:]
    block.extend([(else_try),
      (eq, ":object", overlay_var),
      (assign, option, ":value"),
      ])
  return lazy.block(block)

presentations.extend([

  ("game_profile_banner_selection", 0, "mesh_load_window", # converted to a profile options selection
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),

      (call_script, "script_load_profile_options"),
      (create_button_overlay, "$g_presentation_obj_profile_options_done", "str_done", tf_center_justify),
      (position_set_x, pos1, 500),
      (position_set_y, pos1, 50),
      (overlay_set_position, "$g_presentation_obj_profile_options_done", pos1),
      (position_set_x, pos1, 1500),
      (position_set_y, pos1, 1500),
      (overlay_set_size, "$g_presentation_obj_profile_options_done", pos1),

      (str_clear, s0),
      (create_text_overlay, reg0, s0, tf_scrollable),
      (position_set_x, pos1, 50),
      (position_set_y, pos1, 75),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos1, 900),
      (position_set_y, pos1, 625),
      (overlay_set_area_size, reg0, pos1),
      (set_container_overlay, reg0),

      (assign, ":label_y", 20 + (len(profile_options) * admin_panel_item_height)),
      (assign, ":checkbox_y", 27 + (len(profile_options) * admin_panel_item_height)),
      (position_set_x, pos1, 30),
      (position_set_x, pos2, 7),

      prsnt_create_profile_options_overlays(),

      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_event_state_change,
     [(store_trigger_param_1, ":object"),
      (store_trigger_param_2, ":value"),
      (try_begin),
        (eq, ":object", "$g_presentation_obj_profile_options_done"),
        (presentation_set_duration, 0),
        (call_script, "script_store_profile_options"),

        prsnt_check_profile_options_overlays(),

      (try_end),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":cur_time"),
      (try_begin),
        (key_clicked, key_escape),
        (gt, ":cur_time", 200),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    ]),

  ("game_custom_battle_designer", prsntf_manual_end_only, 0, []),

  ("game_multiplayer_admin_panel", prsntf_manual_end_only, 0, # called by the game both when hosting a server from the client (scene editing mode in PW) and the admin panel
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),
      (multiplayer_get_my_player, ":my_player_id"),
      (try_begin), # if no player, hosting a client server must have been selected, so give a list of scenes to edit
        (le, ":my_player_id", 0),

        (store_sub, ":num_scenes", scenes_end, scenes_begin),
        (try_begin),
          (gt, ":num_scenes", 20),
          (create_combo_label_overlay, "$g_presentation_obj_edit_mode_choose_scene"),
        (else_try),
          (create_combo_button_overlay, "$g_presentation_obj_edit_mode_choose_scene"),
        (try_end),
        (position_set_x, pos1, 800),
        (position_set_y, pos1, 800),
        (overlay_set_size, "$g_presentation_obj_edit_mode_choose_scene", pos1),
        (position_set_x, pos1, 500),
        (position_set_y, pos1, 600),
        (overlay_set_position, "$g_presentation_obj_edit_mode_choose_scene", pos1),
        (try_for_range_backwards, ":scene_id", scenes_begin, scenes_end), # add to the list from the end so the scenes are in the correct order
          (store_sub, ":name_string_id", ":scene_id", scenes_begin),
          (val_add, ":name_string_id", scene_names_begin),
          (str_store_string, s0, ":name_string_id"),
          (overlay_add_item, "$g_presentation_obj_edit_mode_choose_scene", s0),
        (try_end),
        (val_clamp, "$g_selected_scene", scenes_begin, scenes_end),
        (store_sub, ":scene_index", scenes_end, "$g_selected_scene"),
        (val_sub, ":scene_index", 1),
        (overlay_set_val, "$g_presentation_obj_edit_mode_choose_scene", ":scene_index"),

        (create_button_overlay, "$g_presentation_obj_edit_mode_start_scene", "str_edit_scene", tf_center_justify),
        (position_set_x, pos1, 480),
        (position_set_y, pos1, 200),
        (overlay_set_position, "$g_presentation_obj_edit_mode_start_scene", pos1),
        (position_set_x, pos1, 1500),
        (position_set_y, pos1, 1500),
        (overlay_set_size, "$g_presentation_obj_edit_mode_start_scene", pos1),

        (presentation_set_duration, 999999),
      (else_try),
        (assign, "$g_presentation_obj_edit_mode_choose_scene", -1),
        (assign, "$g_presentation_obj_edit_mode_start_scene", -1),
      (try_end),
      (gt, ":my_player_id", 0), # otherwise when connected to a server, show the admin panel

      (create_mesh_overlay, reg0, "mesh_mp_ui_host_maps_randomp"),
      (position_set_x, pos1, -1),
      (position_set_y, pos1, 550),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos1, 1002),
      (position_set_y, pos1, 1002),
      (overlay_set_size, reg0, pos1),

      (create_mesh_overlay, reg0, "mesh_mp_ui_host_main"),
      (position_set_x, pos1, -1),
      (position_set_y, pos1, -1),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos1, 1002),
      (position_set_y, pos1, 1002),
      (overlay_set_size, reg0, pos1),

      (assign, ":cur_y", 20 + (22 * admin_panel_item_height)), # fixed offset plus the number of panel items multiplied by the height

      (str_clear, s0),
      (create_text_overlay, reg0, s0, tf_scrollable),
      (position_set_x, pos1, 59),
      (position_set_y, pos1, 50),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos1, 640),
      (position_set_y, pos1, 520),
      (overlay_set_area_size, reg0, pos1),
      (set_container_overlay, reg0),

      (create_text_overlay, reg0, "str_add_to_game_servers_list", 0),
      (position_set_x, pos1, 30),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_check_box_overlay, "$g_presentation_obj_admin_panel_add_to_servers_list", "mesh_checkbox_off", "mesh_checkbox_on"),
      (position_set_x, pos1, 7),
      (store_add, ":special_cur_y", ":cur_y", 7),
      (position_set_y, pos1, ":special_cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_add_to_servers_list", pos1),
      (server_get_add_to_game_servers_list, ":add_to_servers_list"),
      (overlay_set_val, "$g_presentation_obj_admin_panel_add_to_servers_list", ":add_to_servers_list"),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_anti_cheat", 0),
      (position_set_x, pos1, 30),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_check_box_overlay, "$g_presentation_obj_admin_panel_anti_cheat", "mesh_checkbox_off", "mesh_checkbox_on"),
      (position_set_x, pos1, 7),
      (store_add, ":special_cur_y", ":cur_y", 7),
      (position_set_y, pos1, ":special_cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_anti_cheat", pos1),
      (server_get_anti_cheat, ":server_anti_cheat"),
      (overlay_set_val, "$g_presentation_obj_admin_panel_anti_cheat", ":server_anti_cheat"),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_server_name", 0),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (str_store_server_name, s0),
      (try_begin),
        (eq, "$g_renaming_server_allowed", 1),
        (create_simple_text_box_overlay, "$g_presentation_obj_admin_panel_server_name"),
        (position_set_x, pos1, 390),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, "$g_presentation_obj_admin_panel_server_name", pos1),
        (overlay_set_text, "$g_presentation_obj_admin_panel_server_name", s0),
      (else_try),
        (assign, "$g_presentation_obj_admin_panel_server_name", -1),
        (create_text_overlay, reg0, s0, 0),
        (position_set_x, pos1, 385),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
      (try_end),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_game_password", 0),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_simple_text_box_overlay, "$g_presentation_obj_admin_panel_password"),
      (position_set_x, pos1, 390),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_password", pos1),
      (str_store_server_password, s0),
      (overlay_set_text, "$g_presentation_obj_admin_panel_password", s0),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_welcome_message", 0),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_simple_text_box_overlay, "$g_presentation_obj_admin_panel_welcome_message"),
      (position_set_x, pos1, 390),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_welcome_message", pos1),
      (str_store_welcome_message, s0),
      (overlay_set_text, "$g_presentation_obj_admin_panel_welcome_message", s0),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_game_type", 0),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_combo_button_overlay, "$g_presentation_obj_admin_panel_game_type"),
      (position_set_x, pos1, 800),
      (position_set_y, pos1, 800),
      (overlay_set_size, "$g_presentation_obj_admin_panel_game_type", pos1),
      (position_set_x, pos1, 490),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_game_type", pos1),
      (assign, ":name_string_id", game_type_names_end),
      (try_for_range_backwards, ":unused", game_type_mission_templates_begin, game_type_mission_templates_end),
        (val_sub, ":name_string_id", 1),
        (str_store_string, s0, ":name_string_id"),
        (overlay_add_item, "$g_presentation_obj_admin_panel_game_type", s0),
      (try_end),
      (assign, "$g_selected_game_type", "$g_game_type"),
      (val_clamp, "$g_selected_game_type", game_type_mission_templates_begin, game_type_mission_templates_end),
      (store_sub, ":game_type_index", lazy.sub(game_type_mission_templates_end, 1), "$g_selected_game_type"),
      (overlay_set_val, "$g_presentation_obj_admin_panel_game_type", ":game_type_index"),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_scene", 0),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (store_sub, ":num_scenes", scenes_end, scenes_begin),
      (try_begin),
        (gt, ":num_scenes", 20),
        (create_combo_label_overlay, "$g_presentation_obj_admin_panel_scene"),
      (else_try),
        (create_combo_button_overlay, "$g_presentation_obj_admin_panel_scene"),
      (try_end),
      (position_set_x, pos1, 800),
      (position_set_y, pos1, 800),
      (overlay_set_size, "$g_presentation_obj_admin_panel_scene", pos1),
      (position_set_x, pos1, 490),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_scene", pos1),
      (try_for_range_backwards, ":scene_id", scenes_begin, scenes_end),
        (store_sub, ":name_string_id", ":scene_id", scenes_begin),
        (val_add, ":name_string_id", scene_names_begin),
        (str_store_string, s0, ":name_string_id"),
        (overlay_add_item, "$g_presentation_obj_admin_panel_scene", s0),
      (try_end),
      (store_current_scene, "$g_selected_scene"),
      (store_sub, ":scene_index", lazy.sub(scenes_end, 1), "$g_selected_scene"),
      (overlay_set_val, "$g_presentation_obj_admin_panel_scene", ":scene_index"),

      (val_sub, ":cur_y", admin_panel_item_height),
      (assign, reg1, 1),
      (create_text_overlay, reg0, "str_max_players", 0),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_number_box_overlay, "$g_presentation_obj_admin_panel_max_players", min_num_players, max_num_players),
      (position_set_x, pos1, 390),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_max_players", pos1),
      (server_get_max_num_players, ":max_players"),
      (overlay_set_val, "$g_presentation_obj_admin_panel_max_players", ":max_players"),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_ghost_mode", 0),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_combo_button_overlay, "$g_presentation_obj_admin_panel_ghost_mode"),
      (position_set_x, pos1, 800),
      (position_set_y, pos1, 800),
      (overlay_set_size, "$g_presentation_obj_admin_panel_ghost_mode", pos1),
      (position_set_x, pos1, 490),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_ghost_mode", pos1),
      (overlay_add_item, "$g_presentation_obj_admin_panel_ghost_mode", "str_free"),
      (overlay_add_item, "$g_presentation_obj_admin_panel_ghost_mode", "str_stick_to_any_player"),
      (overlay_add_item, "$g_presentation_obj_admin_panel_ghost_mode", "str_stick_to_team_members"),
      (overlay_add_item, "$g_presentation_obj_admin_panel_ghost_mode", "str_stick_to_team_members_view"),
      (server_get_ghost_mode, ":server_ghost_mode"),
      (overlay_set_val, "$g_presentation_obj_admin_panel_ghost_mode", ":server_ghost_mode"),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_control_block_direction", 0),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_combo_button_overlay, "$g_presentation_obj_admin_panel_block_dir"),
      (position_set_x, pos1, 800),
      (position_set_y, pos1, 800),
      (overlay_set_size, "$g_presentation_obj_admin_panel_block_dir", pos1),
      (position_set_x, pos1, 490),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_block_dir", pos1),
      (overlay_add_item, "$g_presentation_obj_admin_panel_block_dir", "str_automatic"),
      (overlay_add_item, "$g_presentation_obj_admin_panel_block_dir", "str_by_mouse_movement"),
      (server_get_control_block_dir, ":server_control_block_dir"),
      (overlay_set_val, "$g_presentation_obj_admin_panel_block_dir", ":server_control_block_dir"),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_combat_speed", 0),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_combo_button_overlay, "$g_presentation_obj_admin_panel_combat_speed"),
      (position_set_x, pos1, 800),
      (position_set_y, pos1, 800),
      (overlay_set_size, "$g_presentation_obj_admin_panel_combat_speed", pos1),
      (position_set_x, pos1, 490),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_combat_speed", pos1),
      (overlay_add_item, "$g_presentation_obj_admin_panel_combat_speed", "str_combat_speed_0"),
      (overlay_add_item, "$g_presentation_obj_admin_panel_combat_speed", "str_combat_speed_1"),
      (overlay_add_item, "$g_presentation_obj_admin_panel_combat_speed", "str_combat_speed_2"),
      (overlay_add_item, "$g_presentation_obj_admin_panel_combat_speed", "str_combat_speed_3"),
      (overlay_add_item, "$g_presentation_obj_admin_panel_combat_speed", "str_combat_speed_4"),
      (server_get_combat_speed, ":server_combat_speed"),
      (overlay_set_val, "$g_presentation_obj_admin_panel_combat_speed", ":server_combat_speed"),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_game_time_limit", 0),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_number_box_overlay, "$g_presentation_obj_admin_panel_time_limit", 5, 40321),
      (position_set_x, pos1, 390),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_time_limit", pos1),
      (overlay_set_val, "$g_presentation_obj_admin_panel_time_limit", "$g_game_time_limit"),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_respawn_period", 0),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_number_box_overlay, "$g_presentation_obj_admin_panel_respawn_period", min_respawn_period, max_respawn_period),
      (position_set_x, pos1, 390),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_respawn_period", pos1),
      (overlay_set_val, "$g_presentation_obj_admin_panel_respawn_period", "$g_respawn_period"),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_starting_gold", 0),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_number_box_overlay, "$g_presentation_obj_admin_panel_starting_gold", 0, 10001),
      (position_set_x, pos1, 390),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_starting_gold", pos1),
      (overlay_set_val, "$g_presentation_obj_admin_panel_starting_gold", "$g_starting_gold_multiplier"),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_combat_gold_bonus", 0),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_number_box_overlay, "$g_presentation_obj_admin_panel_combat_gold", 0, 10001),
      (position_set_x, pos1, 390),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_combat_gold", pos1),
      (overlay_set_val, "$g_presentation_obj_admin_panel_combat_gold", "$g_combat_gold_multiplier"),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_kick_voteable", 0),
      (position_set_x, pos1, 30),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_check_box_overlay, "$g_presentation_obj_admin_panel_kick_voteable", "mesh_checkbox_off", "mesh_checkbox_on"),
      (position_set_x, pos1, 7),
      (store_add, ":special_cur_y", ":cur_y", 7),
      (position_set_y, pos1, ":special_cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_kick_voteable", pos1),
      (overlay_set_val, "$g_presentation_obj_admin_panel_kick_voteable", "$g_kick_voteable"),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_ban_voteable", 0),
      (position_set_x, pos1, 30),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_check_box_overlay, "$g_presentation_obj_admin_panel_ban_voteable", "mesh_checkbox_off", "mesh_checkbox_on"),
      (position_set_x, pos1, 7),
      (store_add, ":special_cur_y", ":cur_y", 7),
      (position_set_y, pos1, ":special_cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_ban_voteable", pos1),
      (overlay_set_val, "$g_presentation_obj_admin_panel_ban_voteable", "$g_ban_voteable"),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_scenes_voteable", 0),
      (position_set_x, pos1, 30),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_check_box_overlay, "$g_presentation_obj_admin_panel_scenes_voteable", "mesh_checkbox_off", "mesh_checkbox_on"),
      (position_set_x, pos1, 7),
      (store_add, ":special_cur_y", ":cur_y", 7),
      (position_set_y, pos1, ":special_cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_scenes_voteable", pos1),
      (overlay_set_val, "$g_presentation_obj_admin_panel_scenes_voteable", "$g_scenes_voteable"),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_valid_vote_ratio", 0),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_number_box_overlay, "$g_presentation_obj_admin_panel_vote_ratio", 50, 101),
      (position_set_x, pos1, 390),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_vote_ratio", pos1),
      (overlay_set_val, "$g_presentation_obj_admin_panel_vote_ratio", "$g_valid_vote_ratio"),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_team_point_limit", 0),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_number_box_overlay, "$g_presentation_obj_admin_panel_victory_condition", 0, 1441),
      (position_set_x, pos1, 390),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_victory_condition", pos1),
      (overlay_set_val, "$g_presentation_obj_admin_panel_victory_condition", "$g_victory_condition"),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_num_bots_voteable", 0),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_number_box_overlay, "$g_presentation_obj_admin_panel_max_herd_animals", 0, 1001),
      (position_set_x, pos1, 390),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_max_herd_animals", pos1),
      (overlay_set_val, "$g_presentation_obj_admin_panel_max_herd_animals", "$g_max_herd_animal_count"),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_bot_count", 0),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_number_box_overlay, "$g_presentation_obj_admin_panel_bot_count", 0, 101),
      (position_set_x, pos1, 390),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_bot_count", pos1),
      (overlay_set_val, "$g_presentation_obj_admin_panel_bot_count", "$g_bot_count"),

      (val_sub, ":cur_y", admin_panel_item_height),
      (create_text_overlay, reg0, "str_force_default_armor", 0),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (create_combo_button_overlay, "$g_presentation_obj_admin_panel_weather"),
      (position_set_x, pos1, 800),
      (position_set_y, pos1, 800),
      (overlay_set_size, "$g_presentation_obj_admin_panel_weather", pos1),
      (position_set_x, pos1, 490),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_admin_panel_weather", pos1),
      (overlay_add_item, "$g_presentation_obj_admin_panel_weather", "str_always_fine"),
      (overlay_add_item, "$g_presentation_obj_admin_panel_weather", "str_always_raining"),
      (overlay_add_item, "$g_presentation_obj_admin_panel_weather", "str_dynamic"),
      (overlay_set_val, "$g_presentation_obj_admin_panel_weather", "$g_force_weather"),

      (set_container_overlay, -1),

      (create_button_overlay, "$g_presentation_obj_admin_panel_done", "str_done", tf_center_justify),
      (position_set_x, pos1, 825),
      (position_set_y, pos1, 50),
      (overlay_set_position, "$g_presentation_obj_admin_panel_done", pos1),
      (position_set_x, pos1, 1500),
      (position_set_y, pos1, 1500),
      (overlay_set_size, "$g_presentation_obj_admin_panel_done", pos1),

      (create_button_overlay, "$g_presentation_obj_admin_panel_start_scene", "str_start_scene", tf_center_justify),
      (position_set_x, pos1, 825),
      (position_set_y, pos1, 90),
      (overlay_set_position, "$g_presentation_obj_admin_panel_start_scene", pos1),
      (position_set_x, pos1, 1500),
      (position_set_y, pos1, 1500),
      (overlay_set_size, "$g_presentation_obj_admin_panel_start_scene", pos1),

      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_event_state_change,
     [(store_trigger_param_1, ":object"),
      (store_trigger_param_2, ":value"),
      (try_begin), # edit scene mode
        (gt, "$g_presentation_obj_edit_mode_choose_scene", -1),
        (try_begin),
          (eq, ":object", "$g_presentation_obj_edit_mode_choose_scene"),
          (store_sub, "$g_selected_scene", scenes_end, ":value"),
          (val_sub, "$g_selected_scene", 1),
        (else_try),
          (eq, ":object", "$g_presentation_obj_edit_mode_start_scene"),
          (team_set_faction, 0, 0),
          (team_set_faction, 1, 0),
          (start_multiplayer_mission, "mt_edit_scene", "$g_selected_scene", 1),
        (try_end),
      (try_end),
      (eq, "$g_presentation_obj_edit_mode_choose_scene", -1),
      (try_begin), # admin panel
        (eq, ":object", "$g_presentation_obj_admin_panel_add_to_servers_list"),
        (multiplayer_send_2_int_to_server, client_event_admin_set_game_rule, command_set_add_to_game_servers_list, ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_anti_cheat"),
        (multiplayer_send_2_int_to_server, client_event_admin_set_game_rule, command_set_anti_cheat, ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_server_name"),
        (multiplayer_send_string_to_server, client_event_admin_set_server_name, s0),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_password"),
        (multiplayer_send_string_to_server, client_event_admin_set_password, s0),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_welcome_message"),
        (server_set_welcome_message, s0),
        (multiplayer_send_string_to_server, client_event_admin_set_welcome_message, s0),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_game_type"),
        (store_sub, "$g_selected_game_type", lazy.sub(game_type_mission_templates_end, 1), ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_scene"),
        (store_sub, "$g_selected_scene", lazy.sub(scenes_end, 1), ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_start_scene"),
        (multiplayer_send_3_int_to_server, client_event_admin_set_game_rule, command_start_scene, "$g_selected_scene", "$g_selected_game_type"),
        (presentation_set_duration, 0),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_max_players"),
        (multiplayer_send_2_int_to_server, client_event_admin_set_game_rule, command_set_max_players, ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_ghost_mode"),
        (multiplayer_send_2_int_to_server, client_event_admin_set_game_rule, command_set_ghost_mode, ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_block_dir"),
        (multiplayer_send_2_int_to_server, client_event_admin_set_game_rule, command_set_control_block_direction, ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_combat_speed"),
        (multiplayer_send_2_int_to_server, client_event_admin_set_game_rule, command_set_combat_speed, ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_time_limit"),
        (multiplayer_send_2_int_to_server, client_event_admin_set_game_rule, command_set_map_time_limit, ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_respawn_period"),
        (multiplayer_send_2_int_to_server, client_event_admin_set_game_rule, command_set_respawn_period, ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_time_limit"),
        (multiplayer_send_2_int_to_server, client_event_admin_set_game_rule, command_set_map_time_limit, ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_starting_gold"),
        (multiplayer_send_2_int_to_server, client_event_admin_set_game_rule, command_set_starting_gold, ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_combat_gold"),
        (multiplayer_send_2_int_to_server, client_event_admin_set_game_rule, command_set_combat_gold_bonus, ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_kick_voteable"),
        (multiplayer_send_2_int_to_server, client_event_admin_set_game_rule, command_set_kick_voteable, ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_ban_voteable"),
        (multiplayer_send_2_int_to_server, client_event_admin_set_game_rule, command_set_ban_voteable, ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_scenes_voteable"),
        (multiplayer_send_2_int_to_server, client_event_admin_set_game_rule, command_set_maps_voteable, ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_vote_ratio"),
        (multiplayer_send_2_int_to_server, client_event_admin_set_game_rule, command_set_valid_vote_ratio, ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_victory_condition"),
        (multiplayer_send_2_int_to_server, client_event_admin_set_game_rule, command_set_team_point_limit, ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_max_herd_animals"),
        (multiplayer_send_2_int_to_server, client_event_admin_set_game_rule, command_set_num_bots_voteable, ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_bot_count"),
        (multiplayer_send_2_int_to_server, client_event_admin_set_game_rule, command_set_bot_count, ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_weather"),
        (multiplayer_send_2_int_to_server, client_event_admin_set_game_rule, command_set_force_default_armor, ":value"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_panel_done"),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":cur_time"),
      (try_begin),
        (key_clicked, key_escape),
        (gt, ":cur_time", 200),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    ]),

  ("game_before_quit", 0, "mesh_load_window", []),

  ("game_rules", prsntf_manual_end_only, 0, # lists server settings
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),
      (create_mesh_overlay, reg0, "mesh_mp_ui_welcome_panel"),
      (position_set_x, pos1, 200),
      (position_set_y, pos1, 400),
      (overlay_set_position, reg0, pos1),

      (str_store_welcome_message, s0),
      (try_begin),
        (neg|str_is_empty, s0),
        (str_clear, s3),
        (str_store_string, s2, s0),
        (str_store_string, s2, "str_s2_s3"),
        (str_store_string, s2, "str_s2_s3"),
      (else_try),
        (str_clear, s2),
      (try_end),

      (str_store_string, s3, "str_game_rules"),
      (str_store_string, s2, "str_s2_s3"),

      (str_store_string, s0, "str_server_name"),
      (str_store_server_name, s1),
      (str_store_string, s3, "str_s0_s1"),
      (str_store_string, s2, "str_s2_s3"),

      (store_current_scene, ":current_scene"),
      (val_sub, ":current_scene", scenes_begin),
      (val_add, ":current_scene", scene_names_begin),
      (str_store_string, s0, "str_scene_name"),
      (str_store_string, s1, ":current_scene"),
      (str_store_string, s3, "str_s0_s1"),
      (str_store_string, s2, "str_s2_s3"),

      (store_mission_timer_a, ":mission_timer"),
      (val_add, ":mission_timer", "$g_server_mission_timer_when_player_joined"),
      (store_mul, ":remaining_seconds", "$g_game_time_limit", 60),
      (val_sub, ":remaining_seconds", ":mission_timer"),
      (store_div, reg0, ":remaining_seconds", 3600),
      (val_mod, ":remaining_seconds", 3600),
      (store_div, reg1, ":remaining_seconds", 60),
      (store_mod, reg2, ":remaining_seconds", 60),
      (try_begin),
        (ge, reg1, 10),
        (str_clear, s0),
      (else_try),
        (str_store_string, s0, "str_zero"),
      (try_end),
      (try_begin),
        (ge, reg2, 10),
        (str_clear, s1),
      (else_try),
        (str_store_string, s1, "str_zero"),
      (try_end),
      (str_store_string, s3, "str_remaining_time_reg0_s0reg1_s1reg2"),
      (str_store_string, s2, "str_s2_s3"),

      (assign, ":loop_end", 100),
      (try_for_range, ":current_option", 0, ":loop_end"),
        (assign, reg0, -12345),
        (call_script, "script_game_get_multiplayer_server_option_for_mission_template", 0, ":current_option"),
        (try_begin),
          (eq, reg0, -12345),
          (assign, ":loop_end", 0),
        (else_try),
          (call_script, "script_game_multiplayer_server_option_for_mission_template_to_string", 0, ":current_option", reg0),
          (str_store_string, s3, s0),
          (str_store_string, s2, "str_s2_s3"),
        (try_end),
      (try_end),

      (create_text_overlay, reg0, s2, tf_scrollable),
      (overlay_set_color, reg0, 0xFFFFFF),
      (position_set_x, pos1, 230),
      (position_set_y, pos1, 425),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos1, 900),
      (position_set_y, pos1, 900),
      (overlay_set_size, reg0, pos1),
      (position_set_x, pos1, 540),
      (position_set_y, pos1, 150),
      (overlay_set_area_size, reg0, pos1),

      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":cur_time"),
      (try_begin),
        (key_clicked, key_escape),
        (gt, ":cur_time", 200),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    ]),

  ("escape_menu", prsntf_manual_end_only, 0,
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),

      (create_mesh_overlay, reg0, "mesh_mp_ingame_menu"),
      (position_set_x, pos1, 250),
      (position_set_y, pos1, 80),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos1, 1000),
      (position_set_y, pos1, 1000),
      (overlay_set_size, reg0, pos1),

      (str_clear, s0),
      (create_text_overlay, reg0, s0, tf_scrollable_style_2),
      (position_set_x, pos1, 285),
      (position_set_y, pos1, 125),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos1, 405),
      (position_set_y, pos1, 500),
      (overlay_set_area_size, reg0, pos1),
      (set_container_overlay, reg0),

      (init_position, pos2),
      (position_set_x, pos2, 900),
      (position_set_y, pos2, 900),
      (assign, ":cur_y", 10),

      (multiplayer_get_my_player, ":my_player_id"),
      (player_get_team_no, ":my_team", ":my_player_id"),
      (try_begin),
        (this_or_next|eq, "$g_player_has_spawned_after_connecting", 0),
        (eq, ":my_team", team_spectators),
        (assign, ":string_id", "str_join_game"),
      (else_try),
        (assign, ":string_id", "str_spectate"),
      (try_end),
      (create_button_overlay, reg0, ":string_id", 0),
      (assign, "$g_presentation_obj_escape_menu_spectate", reg0),
      (overlay_set_color, reg0, 0xFFFFFF),
      (overlay_set_size, reg0, pos2),
      (val_add, ":cur_y", escape_menu_item_height),

      (create_button_overlay, reg0, "str_change_options", 0),
      (assign, "$g_presentation_obj_escape_menu_options", reg0),
      (overlay_set_color, reg0, 0xFFFFFF),
      (overlay_set_size, reg0, pos2),
      (val_add, ":cur_y", escape_menu_item_height),

      (create_button_overlay, reg0, "str_change_controls", 0),
      (assign, "$g_presentation_obj_escape_menu_controls", reg0),
      (overlay_set_color, reg0, 0xFFFFFF),
      (overlay_set_size, reg0, pos2),
      (val_add, ":cur_y", escape_menu_item_height),

      (create_button_overlay, reg0, "str_show_rules", 0),
      (assign, "$g_presentation_obj_escape_menu_show_rules", reg0),
      (overlay_set_color, reg0, 0xFFFFFF),
      (overlay_set_size, reg0, pos2),
      (val_add, ":cur_y", escape_menu_item_height),

      (create_button_overlay, reg0, "str_show_info", 0),
      (assign, "$g_presentation_obj_escape_menu_show_info", reg0),
      (overlay_set_color, reg0, 0xFFFFFF),
      (overlay_set_size, reg0, pos2),
      (val_add, ":cur_y", escape_menu_item_height),

      (create_button_overlay, reg0, "str_request_poll", 0),
      (assign, "$g_presentation_obj_escape_menu_request_poll", reg0),
      (overlay_set_color, reg0, 0xFFFFFF),
      (overlay_set_size, reg0, pos2),
      (val_add, ":cur_y", escape_menu_item_height),

      (assign, "$g_presentation_obj_escape_menu_admin_panel", -1),
      (assign, "$g_presentation_obj_escape_menu_admin_tools", -1),
      (assign, "$g_presentation_obj_escape_menu_admin_items", -1),
      (try_begin),
        (ge, ":my_player_id", 0),
        (player_is_admin, ":my_player_id"),
        (try_begin),
          (player_slot_eq, ":my_player_id", slot_player_admin_no_panel, 0),
          (create_button_overlay, reg0, "str_admin_panel", 0),
          (assign, "$g_presentation_obj_escape_menu_admin_panel", reg0),
          (overlay_set_color, reg0, 0xFFFFFF),
          (overlay_set_size, reg0, pos2),
          (val_add, ":cur_y", escape_menu_item_height),
        (try_end),

        (create_button_overlay, reg0, "str_admin_tools", 0),
        (assign, "$g_presentation_obj_escape_menu_admin_tools", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (val_add, ":cur_y", escape_menu_item_height),

        (try_begin),
          (player_slot_eq, ":my_player_id", slot_player_admin_no_all_items, 0),
          (create_button_overlay, reg0, "str_admin_items", 0),
          (assign, "$g_presentation_obj_escape_menu_admin_items", reg0),
          (overlay_set_color, reg0, 0xFFFFFF),
          (overlay_set_size, reg0, pos2),
          (val_add, ":cur_y", escape_menu_item_height),
        (try_end),
      (try_end),

      (try_begin),
        (player_slot_eq, ":my_player_id", slot_player_is_lord, 1),
        (create_button_overlay, reg0, "str_faction_admin", 0),
        (assign, "$g_presentation_obj_escape_menu_faction_admin", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (val_add, ":cur_y", escape_menu_item_height),
      (else_try),
        (assign, "$g_presentation_obj_escape_menu_faction_admin", -1),
      (try_end),

      (create_button_overlay, reg0, "str_quit", 0),
      (assign, "$g_presentation_obj_escape_menu_quit", reg0),
      (overlay_set_color, reg0, 0xFFFFFF),
      (overlay_set_size, reg0, pos2),
      (val_add, ":cur_y", escape_menu_item_height),

      (create_text_overlay, reg0, "str_choose_an_option", 0),
      (overlay_set_color, reg0, 0xFFFFFF),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),
      (overlay_set_size, reg0, pos2),

      (position_set_x, pos1, 130),
      (val_sub, ":cur_y", escape_menu_item_height),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_escape_menu_spectate", pos1),

      (val_sub, ":cur_y", escape_menu_item_height),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_escape_menu_options", pos1),

      (val_sub, ":cur_y", escape_menu_item_height),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_escape_menu_controls", pos1),

      (val_sub, ":cur_y", escape_menu_item_height),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_escape_menu_show_rules", pos1),

      (val_sub, ":cur_y", escape_menu_item_height),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_escape_menu_show_info", pos1),

      (val_sub, ":cur_y", escape_menu_item_height),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_escape_menu_request_poll", pos1),

      (try_begin),
        (gt, "$g_presentation_obj_escape_menu_admin_panel", -1),
        (val_sub, ":cur_y", escape_menu_item_height),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, "$g_presentation_obj_escape_menu_admin_panel", pos1),
      (try_end),

      (try_begin),
        (gt, "$g_presentation_obj_escape_menu_admin_tools", -1),
        (val_sub, ":cur_y", escape_menu_item_height),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, "$g_presentation_obj_escape_menu_admin_tools", pos1),
      (try_end),

      (try_begin),
        (gt, "$g_presentation_obj_escape_menu_admin_items", -1),
        (val_sub, ":cur_y", escape_menu_item_height),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, "$g_presentation_obj_escape_menu_admin_items", pos1),
      (try_end),

      (try_begin),
        (gt, "$g_presentation_obj_escape_menu_faction_admin", -1),
        (val_sub, ":cur_y", escape_menu_item_height),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, "$g_presentation_obj_escape_menu_faction_admin", pos1),
      (try_end),

      (val_sub, ":cur_y", escape_menu_item_height),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_escape_menu_quit", pos1),

      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_event_state_change,
     [(store_trigger_param_1, ":object"),
      (try_begin),
        (eq, ":object", "$g_presentation_obj_escape_menu_spectate"),
        (presentation_set_duration, 0),
        (multiplayer_send_message_to_server, client_event_request_spawn_point),
        (assign, "$g_player_has_spawned_after_connecting", 1),
      (else_try),
        (eq, ":object", "$g_presentation_obj_escape_menu_options"),
        (presentation_set_duration, 0),
        (change_screen_options),
      (else_try),
        (eq, ":object", "$g_presentation_obj_escape_menu_controls"),
        (presentation_set_duration, 0),
        (change_screen_controls),
      (else_try),
        (eq, ":object", "$g_presentation_obj_escape_menu_show_rules"),
        (presentation_set_duration, 0),
        (multiplayer_send_message_to_server, client_event_request_game_rules),
      (else_try),
        (eq, ":object", "$g_presentation_obj_escape_menu_show_info"),
        (presentation_set_duration, 0),
        (call_script, "script_show_welcome_message"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_escape_menu_request_poll"),
        (presentation_set_duration, 0),
        (start_presentation, "prsnt_poll_menu"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_escape_menu_admin_panel"),
        (presentation_set_duration, 0),
        (multiplayer_send_int_to_server, client_event_request_game_rules, 1),
      (else_try),
        (eq, ":object", "$g_presentation_obj_escape_menu_admin_tools"),
        (presentation_set_duration, 0),
        (start_presentation, "prsnt_admin_menu"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_escape_menu_admin_items"),
        (presentation_set_duration, 0),
        (start_presentation, "prsnt_admin_item_select"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_escape_menu_faction_admin"),
        (presentation_set_duration, 0),
        (start_presentation, "prsnt_faction_admin_menu"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_escape_menu_quit"),
        (presentation_set_duration, 0),
        (finish_mission, 0),
      (try_end),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":cur_time"),
      (try_begin),
        (key_clicked, key_escape),
        (gt, ":cur_time", 200),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    ]),

  ("poll_menu", prsntf_manual_end_only, 0,
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),

      (create_mesh_overlay, reg0, "mesh_mp_ingame_menu"),
      (position_set_x, pos1, 250),
      (position_set_y, pos1, 80),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos1, 1000),
      (position_set_y, pos1, 1000),
      (overlay_set_size, reg0, pos1),

      (str_clear, s0),
      (create_text_overlay, reg0, s0, tf_scrollable_style_2),
      (position_set_x, pos1, 285),
      (position_set_y, pos1, 125),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos1, 405),
      (position_set_y, pos1, 500),
      (overlay_set_area_size, reg0, pos1),
      (set_container_overlay, reg0),

      (init_position, pos2),
      (position_set_x, pos2, 900),
      (position_set_y, pos2, 900),
      (assign, ":cur_y", 10),
      (position_set_x, pos1, 200),

      (assign, reg0, 0),
      (multiplayer_get_my_player, ":my_player_id"),
      (try_begin),
        (player_get_slot, ":faction_id", ":my_player_id"),
        (is_between, ":faction_id", castle_factions_begin, factions_end),
        (faction_slot_eq, ":faction_id", slot_faction_is_locked, 0),
        (try_begin),
          (neq, "$g_game_type", "mt_no_money"),
          (assign, reg0, poll_cost_faction_lord),
        (try_end),
        (str_store_string, s0, "str_choose_poll_faction_lord"),
        (create_button_overlay, "$g_presentation_obj_poll_menu_faction_lord", "str_s0__reg0_", tf_center_justify),
        (overlay_set_color, "$g_presentation_obj_poll_menu_faction_lord", 0xFFFFFF),
        (overlay_set_size, "$g_presentation_obj_poll_menu_faction_lord", pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, "$g_presentation_obj_poll_menu_faction_lord", pos1),
        (val_add, ":cur_y", escape_menu_item_height),
      (else_try),
        (assign, "$g_presentation_obj_poll_menu_faction_lord", -1),
      (try_end),

      (try_begin),
        (eq, "$g_ban_voteable", 1),
        (try_begin),
          (neq, "$g_game_type", "mt_no_money"),
          (assign, reg0, poll_cost_ban_player),
        (try_end),
        (str_store_string, s0, "str_choose_poll_ban"),
        (create_button_overlay, "$g_presentation_obj_poll_menu_ban", "str_s0__reg0_", tf_center_justify),
        (overlay_set_color, "$g_presentation_obj_poll_menu_ban", 0xFFFFFF),
        (overlay_set_size, "$g_presentation_obj_poll_menu_ban", pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, "$g_presentation_obj_poll_menu_ban", pos1),
        (val_add, ":cur_y", escape_menu_item_height),
      (else_try),
        (assign, "$g_presentation_obj_poll_menu_ban", -1),
      (try_end),

      (try_begin),
        (eq, "$g_kick_voteable", 1),
        (try_begin),
          (neq, "$g_game_type", "mt_no_money"),
          (assign, reg0, poll_cost_kick_player),
        (try_end),
        (str_store_string, s0, "str_choose_poll_kick"),
        (create_button_overlay, "$g_presentation_obj_poll_menu_kick", "str_s0__reg0_", tf_center_justify),
        (overlay_set_color, "$g_presentation_obj_poll_menu_kick", 0xFFFFFF),
        (overlay_set_size, "$g_presentation_obj_poll_menu_kick", pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, "$g_presentation_obj_poll_menu_kick", pos1),
        (val_add, ":cur_y", escape_menu_item_height),
      (else_try),
        (assign, "$g_presentation_obj_poll_menu_kick", -1),
      (try_end),

      (try_begin),
        (eq, "$g_scenes_voteable", 1),
        (try_begin),
          (neq, "$g_game_type", "mt_no_money"),
          (assign, reg0, poll_cost_change_scene),
        (try_end),
        (str_store_string, s0, "str_choose_poll_scene"),
        (create_button_overlay, "$g_presentation_obj_poll_menu_scene", "str_s0__reg0_", tf_center_justify),
        (overlay_set_color, "$g_presentation_obj_poll_menu_scene", 0xFFFFFF),
        (overlay_set_size, "$g_presentation_obj_poll_menu_scene", pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, "$g_presentation_obj_poll_menu_scene", pos1),
        (val_add, ":cur_y", escape_menu_item_height),
      (else_try),
        (assign, "$g_presentation_obj_poll_menu_scene", -1),
      (try_end),

      (create_text_overlay, reg0, "str_choose_a_poll_type", 0),
      (overlay_set_color, reg0, 0xFFFFFF),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),
      (overlay_set_size, reg0, pos2),

      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_event_state_change,
     [(store_trigger_param_1, ":object"),
      (try_begin),
        (eq, ":object", "$g_presentation_obj_poll_menu_scene"),
        (presentation_set_duration, 0),
        (start_presentation, "prsnt_list_scenes"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_poll_menu_kick"),
        (presentation_set_duration, 0),
        (assign, "$g_list_players_action_string_id", "str_kick"),
        (assign, "$g_list_players_event", client_event_request_poll),
        (assign, "$g_list_players_event_value", poll_type_kick_player),
        (start_presentation, "prsnt_list_players"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_poll_menu_ban"),
        (presentation_set_duration, 0),
        (assign, "$g_list_players_action_string_id", "str_ban_temp"),
        (assign, "$g_list_players_event", client_event_request_poll),
        (assign, "$g_list_players_event_value", poll_type_ban_player),
        (start_presentation, "prsnt_list_players"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_poll_menu_faction_lord"),
        (presentation_set_duration, 0),
        (assign, "$g_list_players_action_string_id", "str_propose_as_lord"),
        (assign, "$g_list_players_event", client_event_request_poll),
        (assign, "$g_list_players_event_value", poll_type_faction_lord),
        (start_presentation, "prsnt_list_players"),
      (try_end),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":cur_time"),
      (try_begin),
        (key_clicked, key_escape),
        (gt, ":cur_time", 200),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    ]),

  # $g_list_players_action_string_id: string for ending "Choose a player to ", describing the action
  # $g_list_players_event: network event number to send to the server with the player id
  # $g_list_players_event_value: extra value to send with the network event above
  # $g_list_players_keep_open: 1 = don't end the presentation after selecting a player
  # $g_list_players_return_presentation: the presentation to return to after player selection or pressing escape
  ("list_players", prsntf_manual_end_only, 0,
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),

      (create_mesh_overlay, reg0, "mesh_mp_ingame_menu"),
      (position_set_x, pos1, 250),
      (position_set_y, pos1, 80),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos1, 1000),
      (position_set_y, pos1, 1000),
      (overlay_set_size, reg0, pos1),

      (str_clear, s0),
      (create_text_overlay, reg0, s0, tf_scrollable_style_2),
      (position_set_x, pos1, 285),
      (position_set_y, pos1, 125),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos1, 405),
      (position_set_y, pos1, 500),
      (overlay_set_area_size, reg0, pos1),
      (set_container_overlay, reg0),

      (multiplayer_get_my_player, ":my_player_id"),
      (player_get_slot, "$g_list_players_faction_id", ":my_player_id", slot_player_faction_id),
      (try_begin),
        (eq, "$g_list_players_event", client_event_request_poll),
        (eq, "$g_list_players_event_value", poll_type_faction_lord),
        (try_begin),
          (player_is_admin, ":my_player_id"),
          (player_slot_eq, ":my_player_id", slot_player_admin_no_factions, 0),
          (assign, ":my_player_id", 0), # only add the requesting player to a lord poll list if an admin with permission
        (try_end),
      (else_try),
        (eq, "$g_list_players_event", client_event_faction_admin_action),
      (else_try),
        (assign, "$g_list_players_faction_id", -1), # show players from all factions for admin tools
        (this_or_next|eq, "$g_list_players_event_value", admin_action_fade_player_out),
        (eq, "$g_list_players_event_value", admin_action_freeze_player),
        (assign, ":my_player_id", 0), # only add the requesting player to the list for fade out and freeze tools
      (try_end),

      (val_max, "$g_list_players_action_string_id", 0),
      (str_store_string, s0, "$g_list_players_action_string_id"),
      (create_text_overlay, ":prompt_overlay_id", "str_choose_a_player_to_s0", 0),
      (overlay_set_color, ":prompt_overlay_id", 0xFFFFFF),
      (position_set_x, pos2, 900),
      (position_set_y, pos2, 900),
      (overlay_set_size, ":prompt_overlay_id", pos2),

      (position_set_x, pos2, 750),
      (position_set_y, pos2, 750),
      (assign, ":cur_y", 5),
      (assign, ":overlay_id", -1),
      (get_max_players, ":max_players"),
      (try_begin), # loop over all factions
        (eq, "$g_list_players_faction_id", -1),
        (assign, ":factions_end", factions_end),
      (else_try), # only one iteration of the loop, for the targeted faction
        (store_add, ":factions_end", factions_begin, 1),
      (try_end),
      (try_for_range, ":current_faction_id", factions_begin, ":factions_end"),
        (faction_slot_eq, ":current_faction_id", slot_faction_is_active, 1),
        (try_for_range, ":player_id", 1, ":max_players"), # loop over factions one by one, grouping their members together in the list
          (player_is_active, ":player_id"),
          (this_or_next|neq, "$g_list_players_faction_id", -1),
          (player_slot_eq, ":player_id", slot_player_faction_id, ":current_faction_id"),
          (try_begin),
            (neq, ":player_id", ":my_player_id"),
            (this_or_next|eq, "$g_list_players_faction_id", -1),
            (player_slot_eq, ":player_id", slot_player_faction_id, "$g_list_players_faction_id"),
            (str_store_player_username, s0, ":player_id"),
            (create_button_overlay, ":overlay_id", s0, 0),
            (overlay_set_size, ":overlay_id", pos2),
            (player_set_slot, ":player_id", slot_player_list_button_id, ":overlay_id"), # save the associated overlay id, for checking that the player hasn't disconnected and the id reused
            (val_add, ":cur_y", player_list_item_height),
          (else_try),
            (player_set_slot, ":player_id", slot_player_list_button_id, -1),
          (try_end),
        (try_end),
      (try_end),

      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, ":prompt_overlay_id", pos1),
      (val_sub, ":cur_y", 5),
      (val_add, ":prompt_overlay_id", 1),
      (store_add, ":overlay_id_end", ":overlay_id", 1),
      (try_for_range, ":overlay_id", ":prompt_overlay_id", ":overlay_id_end"),
        (val_sub, ":cur_y", player_list_item_height),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, ":overlay_id", pos1),
      (try_end),

      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_event_state_change,
     [(store_trigger_param_1, ":object"),
      (get_max_players, ":num_players"),
      (try_for_range, ":player_id", 1, ":num_players"),
        (player_is_active, ":player_id"),
        (player_slot_eq, ":player_id", slot_player_list_button_id, ":object"), # ensure that the player id represents the same one selected in the list
        (try_begin),
          (is_between, "$g_list_players_event", 0, 128),
          (multiplayer_send_2_int_to_server, "$g_list_players_event", "$g_list_players_event_value", ":player_id"),
        (try_end),
        (assign, ":num_players", 0),
        (try_begin),
          (eq, "$g_list_players_keep_open", 0), # target the selected player for other use by other functions
          (assign, "$g_target_player_id", ":player_id"),
          (assign, "$g_target_player_overlay_id", ":object"),
          (try_begin),
            (gt, "$g_list_players_return_presentation", 0),
            (neg|is_presentation_active, "$g_list_players_return_presentation"),
            (start_presentation, "$g_list_players_return_presentation"),
          (try_end),
          (assign, "$g_list_players_return_presentation", 0),
          (presentation_set_duration, 0),
        (try_end),
      (try_end),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":cur_time"),
      (try_begin),
        (key_clicked, key_escape),
        (gt, ":cur_time", 200),
        (assign, "$g_target_player_id", 0),
        (assign, "$g_target_player_overlay_id", 0),
        (try_begin),
          (gt, "$g_list_players_return_presentation", 0),
          (neg|is_presentation_active, "$g_list_players_return_presentation"),
          (start_presentation, "$g_list_players_return_presentation"),
        (try_end),
        (assign, "$g_list_players_return_presentation", 0),
        (assign, "$g_list_players_keep_open", 0),
        (presentation_set_duration, 0),
      (else_try), # continuously update list entry colors
        (get_max_players, ":max_players"),
        (try_for_range, ":player_id", 1, ":max_players"),
          (player_is_active, ":player_id"),
          (player_get_slot, ":overlay_id", ":player_id", slot_player_list_button_id),
          (gt, ":overlay_id", -1),
          (assign, ":color", 0xFFFFFF),
          (try_begin), # for player slot toggling, update the player name color with the current setting
            (eq, "$g_list_players_event", client_event_faction_admin_action),
            (try_begin),
              (eq, "$g_list_players_event_value", faction_admin_action_toggle_player_door_key),
              (player_slot_eq, ":player_id", slot_player_has_faction_door_key, 1),
            (else_try),
              (eq, "$g_list_players_event_value", faction_admin_action_toggle_player_money_key),
              (player_slot_eq, ":player_id", slot_player_has_faction_money_key, 1),
            (else_try),
              (eq, "$g_list_players_event_value", faction_admin_action_toggle_player_item_key),
              (player_slot_eq, ":player_id", slot_player_has_faction_item_key, 1),
            (else_try),
              (eq, "$g_list_players_event_value", faction_admin_action_toggle_player_announce),
              (player_slot_eq, ":player_id", slot_player_can_faction_announce, 1),
            (else_try),
              (eq, "$g_list_players_event_value", faction_admin_action_mute_player),
              (player_slot_eq, ":player_id", slot_player_faction_chat_muted, 0),
            (else_try),
              (assign, ":color", 0xFF3333),
            (try_end),
          (else_try), # when including multiple factions, set to the player faction's color
            (eq, "$g_list_players_faction_id", -1),
            (player_get_slot, ":faction_id", ":player_id", slot_player_faction_id),
            (is_between, ":faction_id", factions_begin, factions_end),
            (faction_get_color, ":color", ":faction_id"),
          (try_end),
          (overlay_set_color, ":overlay_id", ":color"),
        (try_end),
      (try_end),
      ]),
    ]),

  ("list_scenes", prsntf_manual_end_only, 0,
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),

      (create_mesh_overlay, reg0, "mesh_mp_ingame_menu"),
      (position_set_x, pos1, 250),
      (position_set_y, pos1, 80),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos1, 1000),
      (position_set_y, pos1, 1000),
      (overlay_set_size, reg0, pos1),

      (str_clear, s0),
      (create_text_overlay, reg0, s0, tf_scrollable_style_2),
      (position_set_x, pos1, 285),
      (position_set_y, pos1, 125),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos1, 405),
      (position_set_y, pos1, 500),
      (overlay_set_area_size, reg0, pos1),
      (set_container_overlay, reg0),

      (init_position, pos2),
      (position_set_x, pos2, 900),
      (position_set_y, pos2, 900),
      (store_sub, ":num_scenes", scenes_end, scenes_begin),
      (store_mul, ":cur_y", ":num_scenes", escape_menu_item_height),
      (val_add, ":cur_y", 10),

      (create_text_overlay, reg0, "str_choose_a_scene", 0),
      (overlay_set_color, reg0, 0xFFFFFF),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),
      (overlay_set_size, reg0, pos2),
      (val_sub, ":cur_y", escape_menu_item_height),

      (store_add, "$g_presentation_obj_list_scenes_begin", reg0, 1),
      (position_set_x, pos1, 130),
      (assign, ":scene_string_id", scene_names_begin),
      (try_for_range, ":unused", scenes_begin, scenes_end),
        (create_button_overlay, ":overlay_id", ":scene_string_id", tf_center_justify),
        (overlay_set_color, ":overlay_id", 0xFFFFFF),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, ":overlay_id", pos1),
        (overlay_set_size, ":overlay_id", pos2),
        (val_sub, ":cur_y", escape_menu_item_height),
        (val_add, ":scene_string_id", 1),
      (try_end),

      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_event_state_change,
     [(store_trigger_param_1, ":object"),
      (try_begin),
        (ge, ":object", "$g_presentation_obj_list_scenes_begin"),
        (store_sub, ":scene_id", ":object", "$g_presentation_obj_list_scenes_begin"),
        (val_add, ":scene_id", scenes_begin),
        (lt, ":scene_id", scenes_end),
        (multiplayer_send_2_int_to_server, client_event_request_poll, poll_type_change_scene, ":scene_id"),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":cur_time"),
      (try_begin),
        (key_clicked, key_escape),
        (gt, ":cur_time", 200),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    ]),

  # $g_list_faction_event: network event number to send to the server with the faction id
  # $g_list_faction_event_value: extra value to send with the network event above
  # $g_list_faction_return_presentation: the presentation to return to after faction selection or pressing escape
  ("list_factions", prsntf_manual_end_only, 0,
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),

      (create_mesh_overlay, reg1, "mesh_mp_ingame_menu"),
      (position_set_x, pos1, 250),
      (position_set_y, pos1, 80),
      (overlay_set_position, reg1, pos1),
      (position_set_x, pos1, 1000),
      (position_set_y, pos1, 1000),
      (overlay_set_size, reg1, pos1),

      (str_clear, s0),
      (create_text_overlay, reg1, s0, tf_scrollable_style_2),
      (position_set_x, pos1, 285),
      (position_set_y, pos1, 125),
      (overlay_set_position, reg1, pos1),
      (position_set_x, pos1, 405),
      (position_set_y, pos1, 500),
      (overlay_set_area_size, reg1, pos1),
      (set_container_overlay, reg1),

      (assign, ":num_factions", 0),
      (multiplayer_get_my_player, ":my_player_id"),
      (player_get_slot, ":my_faction_id", ":my_player_id", slot_player_faction_id),
      (try_for_range, ":faction_id", castle_factions_begin, factions_end),
        (faction_set_slot, ":faction_id", slot_faction_list_button_id, -1),
        (faction_slot_eq, ":faction_id", slot_faction_is_active, 1),
        (neq, ":faction_id", ":my_faction_id"),
        (store_add, ":relation_slot", ":faction_id", slot_faction_relations_begin),
        (assign, ":show", 1),
        (try_begin),
          (eq, "$g_list_factions_event_value", faction_admin_action_set_relation_hostile),
          (faction_slot_ge, ":my_faction_id", ":relation_slot", 1),
        (else_try),
          (eq, "$g_list_factions_event_value", faction_admin_action_set_relation_peaceful),
          (neg|faction_slot_ge, ":my_faction_id", ":relation_slot", 1),
        (else_try),
          (assign, ":show", 0),
        (try_end),
        (eq, ":show", 1),
        (faction_set_slot, ":faction_id", slot_faction_list_button_id, 1),
        (val_add, ":num_factions", 1),
      (try_end),

      (store_mul, ":cur_y", ":num_factions", faction_menu_item_height),
      (val_add, ":cur_y", 10),
      (position_set_x, pos11, 900),
      (position_set_y, pos11, 900),

      (create_text_overlay, reg1, "str_choose_a_faction", 0),
      (overlay_set_color, reg1, 0xFFFFFF),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg1, pos1),
      (overlay_set_size, reg1, pos11),
      (val_sub, ":cur_y", (faction_menu_item_height / 2) + 10),

      (position_set_x, pos12, 50),
      (position_set_y, pos12, 50),
      (store_add, ":banner_y", ":cur_y", faction_menu_item_height / 2),
      (position_set_x, pos2, 25),
      (position_set_x, pos1, 50),
      (try_for_range, ":faction_id", castle_factions_begin, factions_end),
        (faction_slot_ge, ":faction_id", slot_faction_list_button_id, 1),
        (faction_get_slot, ":banner_mesh", ":faction_id", slot_faction_banner_mesh),
        (create_image_button_overlay, reg1, ":banner_mesh", ":banner_mesh"),
        (position_set_y, pos2, ":banner_y"),
        (overlay_set_position, reg1, pos2),
        (overlay_set_size, reg1, pos12),
        (val_sub, ":banner_y", faction_menu_item_height),

        (str_store_faction_name, s0, ":faction_id"),
        (create_button_overlay, reg1, s0),
        (faction_get_color, ":color", ":faction_id"),
        (overlay_set_color, reg1, ":color"),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg1, pos1),
        (overlay_set_size, reg1, pos11),
        (val_sub, ":cur_y", faction_menu_item_height),
        (faction_set_slot, ":faction_id", slot_faction_list_button_id, reg1),
      (try_end),

      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_event_state_change,
     [(store_trigger_param_1, ":overlay_id"),
      (store_add, ":other_overlay_id", ":overlay_id", 1),
      (assign, ":loop_end", factions_end),
      (try_for_range, ":faction_id", castle_factions_begin, ":loop_end"),
        (this_or_next|faction_slot_eq, ":faction_id", slot_faction_list_button_id, ":overlay_id"),
        (faction_slot_eq, ":faction_id", slot_faction_list_button_id, ":other_overlay_id"),
        (presentation_set_duration, 0),
        (assign, ":loop_end", 0),
        (try_begin),
          (is_between, "$g_list_factions_event", 0, 128),
          (multiplayer_send_2_int_to_server, "$g_list_factions_event", "$g_list_factions_event_value", ":faction_id"),
        (try_end),
        (try_begin),
          (gt, "$g_list_factions_return_presentation", 0),
          (neg|is_presentation_active, "$g_list_factions_return_presentation"),
          (start_presentation, "$g_list_factions_return_presentation"),
        (try_end),
        (assign, "$g_list_factions_return_presentation", 0),
      (try_end),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":cur_time"),
      (try_begin),
        (key_clicked, key_escape),
        (gt, ":cur_time", 200),
        (try_begin),
          (gt, "$g_list_factions_return_presentation", 0),
          (neg|is_presentation_active, "$g_list_factions_return_presentation"),
          (start_presentation, "$g_list_factions_return_presentation"),
        (try_end),
        (assign, "$g_list_factions_return_presentation", 0),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    ]),

  ("show_poll", prsntf_read_only|prsntf_manual_end_only, 0,
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),

      (create_mesh_overlay, reg1, "mesh_white_plane"),
      (overlay_set_color, reg1, 0x110000),
      (overlay_set_alpha, reg1, 0x44),
      (position_set_x, pos1, 10),
      (position_set_y, pos1, 10),
      (overlay_set_position, reg1, pos1),
      (position_set_x, pos10, 40500),
      (position_set_y, pos10, 2500),
      (overlay_set_size, reg1, pos10),

      (position_set_x, pos10, 850),
      (position_set_y, pos10, 850),

      (try_begin),
        (player_is_active, "$g_poll_requester_player_id"),
        (str_store_player_username, s1, "$g_poll_requester_player_id"),
      (else_try),
        (str_store_string, s1, "str_departed_player"),
      (try_end),
      (create_text_overlay, reg1, "str_poll_requester_keys", tf_center_justify|tf_with_outline),
      (overlay_set_color, reg1, 0xFFFFFF),
      (position_set_x, pos1, 350),
      (position_set_y, pos1, 15),
      (overlay_set_position, reg1, pos1),
      (overlay_set_size, reg1, pos10),

      (try_begin),
        (this_or_next|eq, "$g_poll_type", poll_type_kick_player),
        (this_or_next|eq, "$g_poll_type", poll_type_ban_player),
        (eq, "$g_poll_type", poll_type_faction_lord),
        (try_begin),
          (player_is_active, "$g_poll_value_1"),
          (str_store_player_username, s1, "$g_poll_value_1"),
        (else_try),
          (str_store_string, s1, "str_departed_player"),
          (multiplayer_get_my_player, "$g_poll_value_1"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$g_poll_type", poll_type_change_scene),
        (store_sub, ":string_id", "$g_poll_value_1", scenes_begin),
        (val_add, ":string_id", scene_names_begin),
        (str_store_string, s1, ":string_id"),
        (assign, ":string_id", "str_poll_change_scene"),
      (else_try),
        (eq, "$g_poll_type", poll_type_kick_player),
        (assign, ":string_id", "str_poll_kick_player"),
      (else_try),
        (eq, "$g_poll_type", poll_type_ban_player),
        (assign, ":string_id", "str_poll_ban_player"),
      (else_try),
        (eq, "$g_poll_type", poll_type_faction_lord),
        (player_get_slot, ":faction_id", "$g_poll_value_1", slot_player_faction_id),
        (str_store_faction_name, s2, ":faction_id"),
        (assign, ":string_id", "str_poll_faction_lord"),
      (try_end),
      (create_text_overlay, reg1, ":string_id", tf_center_justify|tf_with_outline),
      (overlay_set_color, reg1, 0xFFFFFF),
      (position_set_x, pos1, 415),
      (position_set_y, pos1, 35),
      (overlay_set_position, reg1, pos1),
      (overlay_set_size, reg1, pos10),

      (store_mission_timer_a, ":current_time"),
      (store_sub, "$g_poll_displayed_seconds", "$g_poll_end_time", ":current_time"),
      (assign, reg0,  "$g_poll_displayed_seconds"),
      (create_text_overlay, "$g_presentation_obj_poll_seconds", "str_poll_time_left", tf_right_align|tf_single_line|tf_with_outline),
      (overlay_set_color, "$g_presentation_obj_poll_seconds", 0xFFFFFF),
      (position_set_x, pos1, 860),
      (position_set_y, pos1, 15),
      (overlay_set_position, "$g_presentation_obj_poll_seconds", pos1),
      (overlay_set_size, "$g_presentation_obj_poll_seconds", pos10),

      (omit_key_once, key_f7),
      (omit_key_once, key_f8),
      (omit_key_once, key_f9),
      (assign, "$g_hide_poll", 0),
      (presentation_set_duration, poll_time_duration * 100 + 200),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":current_time"),
      (try_begin),
        (gt, ":current_time", 100),
        (assign, ":vote", -9999),
        (try_begin),
          (key_clicked, key_f7),
          (assign, ":vote", poll_vote_abstain),
        (else_try),
          (key_is_down, key_right_shift),
          (multiplayer_get_my_player, ":player_id"),
          (player_is_admin, ":player_id"),
          (player_slot_eq, ":player_id", slot_player_admin_no_override_poll, 0),
          (try_begin),
            (key_clicked, key_f9),
            (assign, ":vote", poll_vote_admin_yes),
          (else_try),
            (key_clicked, key_f8),
            (assign, ":vote", poll_vote_admin_no),
          (try_end),
        (else_try),
          (key_clicked, key_f9),
          (assign, ":vote", poll_vote_yes),
        (else_try),
          (key_clicked, key_f8),
          (assign, ":vote", poll_vote_no),
        (try_end),
        (neq, ":vote", -9999),
        (multiplayer_send_int_to_server, client_event_poll_vote, ":vote"),
        (clear_omitted_keys),
        (presentation_set_duration, 0),
      (try_end),
      (store_mission_timer_a, ":mission_timer"),
      (store_sub, reg0, "$g_poll_end_time", ":mission_timer"),
      (try_begin),
        (this_or_next|eq, "$g_hide_poll", 1),
        (lt, reg0, 0),
        (clear_omitted_keys),
        (presentation_set_duration, 0),
      (else_try),
        (neq, reg0, "$g_poll_displayed_seconds"),
        (overlay_set_text, "$g_presentation_obj_poll_seconds", "str_poll_time_left"),
        (assign, "$g_poll_displayed_seconds", reg0),
      (try_end),
      ]),
    ]),

  ("admin_menu", prsntf_manual_end_only, 0,
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),

      (multiplayer_get_my_player, ":my_player_id"),
      (player_is_admin, ":my_player_id"),

      (create_mesh_overlay, reg0, "mesh_mp_ingame_menu"),
      (position_set_x, pos1, 250),
      (position_set_y, pos1, 80),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos1, 1000),
      (position_set_y, pos1, 1000),
      (overlay_set_size, reg0, pos1),

      (str_clear, s0),
      (create_text_overlay, reg0, s0, tf_scrollable_style_2),
      (position_set_x, pos1, 285),
      (position_set_y, pos1, 125),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos1, 405),
      (position_set_y, pos1, 500),
      (overlay_set_area_size, reg0, pos1),
      (set_container_overlay, reg0),

      (init_position, pos2),
      (position_set_x, pos2, 900),
      (position_set_y, pos2, 900),
      (assign, ":cur_y", 10),
      (position_set_x, pos1, 130),

      (try_begin),
        (player_slot_eq, ":my_player_id", slot_player_admin_no_factions, 0),
        (player_get_slot, ":faction_id", ":my_player_id"),
        (is_between, ":faction_id", castle_factions_begin, factions_end),
        (try_begin),
          (faction_slot_eq, ":faction_id", slot_faction_is_locked, 0),
          (create_button_overlay, reg0, "str_lock_current_faction"),
        (else_try),
          (create_button_overlay, reg0, "str_unlock_current_faction"),
        (try_end),
        (assign, "$g_presentation_obj_admin_menu_lock_faction", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", escape_menu_item_height),
      (else_try),
        (assign, "$g_presentation_obj_admin_menu_lock_faction", -1),
      (try_end),

      (try_begin),
        (player_slot_eq, ":my_player_id", slot_player_admin_no_ships, 0),
        (create_button_overlay, reg0, "str_reset_sunken_ships"),
        (assign, "$g_presentation_obj_admin_menu_reset_ships", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", escape_menu_item_height),

        (create_button_overlay, reg0, "str_teleport_to_ships"),
        (assign, "$g_presentation_obj_admin_menu_teleport_to_ships", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", escape_menu_item_height),
      (else_try),
        (assign, "$g_presentation_obj_admin_menu_reset_ships", -1),
        (assign, "$g_presentation_obj_admin_menu_teleport_to_ships", -1),
      (try_end),

      (try_begin),
        (player_slot_eq, ":my_player_id", slot_player_admin_no_animals, 0),
        (create_button_overlay, reg0, "str_remove_stray_horses"),
        (assign, "$g_presentation_obj_admin_menu_remove_stray_horses", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", escape_menu_item_height),
      (else_try),
        (assign, "$g_presentation_obj_admin_menu_remove_stray_horses", -1),
      (try_end),

      (try_begin),
        (player_slot_eq, ":my_player_id", slot_player_admin_no_admin_items, 0),
        (create_button_overlay, reg0, "str_remove_admin_horses"),
        (assign, "$g_presentation_obj_admin_menu_remove_horses", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", escape_menu_item_height),

        (create_button_overlay, reg0, "str_spawn_admin_horse"),
        (assign, "$g_presentation_obj_admin_menu_admin_horse", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", escape_menu_item_height),
      (else_try),
        (assign, "$g_presentation_obj_admin_menu_remove_horses", -1),
        (assign, "$g_presentation_obj_admin_menu_admin_horse", -1),
      (try_end),

      (try_begin),
        (player_slot_eq, ":my_player_id", slot_player_admin_no_godlike_troop, 0),
        (create_button_overlay, reg0, "str_become_godlike"),
        (assign, "$g_presentation_obj_admin_menu_become_godlike", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", escape_menu_item_height),
      (else_try),
        (assign, "$g_presentation_obj_admin_menu_become_godlike", -1),
      (try_end),

      (try_begin),
        (player_slot_eq, ":my_player_id", slot_player_admin_no_heal_self, 0),
        (create_button_overlay, reg0, "str_refill_health"),
        (assign, "$g_presentation_obj_admin_menu_refill_health", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", escape_menu_item_height),
      (else_try),
        (assign, "$g_presentation_obj_admin_menu_refill_health", -1),
      (try_end),

      (try_begin),
        (player_slot_eq, ":my_player_id", slot_player_admin_no_admin_items, 0),
        (create_button_overlay, reg0, "str_become_invisible"),
        (assign, "$g_presentation_obj_admin_menu_become_invisible", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", escape_menu_item_height),

        (create_button_overlay, reg0, "str_equip_admin_armor"),
        (assign, "$g_presentation_obj_admin_menu_admin_armor", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", escape_menu_item_height),
      (else_try),
        (assign, "$g_presentation_obj_admin_menu_become_invisible", -1),
        (assign, "$g_presentation_obj_admin_menu_admin_armor", -1),
      (try_end),

      (try_begin),
        (player_slot_eq, ":my_player_id", slot_player_admin_no_teleport_self, 0),
        (create_button_overlay, reg0, "str_teleport_forwards"),
        (assign, "$g_presentation_obj_admin_menu_teleport_forwards", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", escape_menu_item_height),

        (create_button_overlay, reg0, "str_teleport_behind_player"),
        (assign, "$g_presentation_obj_admin_menu_teleport_behind_player", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", escape_menu_item_height),

        (create_button_overlay, reg0, "str_teleport_to_player"),
        (assign, "$g_presentation_obj_admin_menu_teleport_to_player", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", escape_menu_item_height),
      (else_try),
        (assign, "$g_presentation_obj_admin_menu_teleport_forwards", -1),
        (assign, "$g_presentation_obj_admin_menu_teleport_behind_player", -1),
        (assign, "$g_presentation_obj_admin_menu_teleport_to_player", -1),
      (try_end),

      (try_begin),
        (player_slot_eq, ":my_player_id", slot_player_admin_no_freeze, 0),
        (create_button_overlay, reg0, "str_freeze_player"),
        (assign, "$g_presentation_obj_admin_menu_freeze_player", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", escape_menu_item_height),
      (else_try),
        (assign, "$g_presentation_obj_admin_menu_freeze_player", -1),
      (try_end),

      (try_begin),
        (player_slot_eq, ":my_player_id", slot_player_admin_no_kill_fade, 0),
        (create_button_overlay, reg0, "str_fade_player_out"),
        (assign, "$g_presentation_obj_admin_menu_fade_player_out", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", escape_menu_item_height),

        (create_button_overlay, reg0, "str_kill_player"),
        (assign, "$g_presentation_obj_admin_menu_kill_player", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", escape_menu_item_height),
      (else_try),
        (assign, "$g_presentation_obj_admin_menu_fade_player_out", -1),
        (assign, "$g_presentation_obj_admin_menu_kill_player", -1),
      (try_end),

      (try_begin),
        (player_slot_eq, ":my_player_id", slot_player_admin_no_mute, 0),
        (create_button_overlay, reg0, "str_mute_player"),
        (assign, "$g_presentation_obj_admin_menu_mute_player", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", escape_menu_item_height),
      (else_try),
        (assign, "$g_presentation_obj_admin_menu_mute_player", -1),
      (try_end),

      (try_begin),
        (player_slot_eq, ":my_player_id", slot_player_admin_no_permanent_ban, 0),
        (create_button_overlay, reg0, "str_ban_player_perm"),
        (assign, "$g_presentation_obj_admin_menu_ban_player_perm", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", escape_menu_item_height),
      (else_try),
        (assign, "$g_presentation_obj_admin_menu_ban_player_perm", -1),
      (try_end),

      (try_begin),
        (player_slot_eq, ":my_player_id", slot_player_admin_no_temporary_ban, 0),
        (create_button_overlay, reg0, "str_ban_player_temp", 0),
        (assign, "$g_presentation_obj_admin_menu_ban_player_temp", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", escape_menu_item_height),
      (else_try),
        (assign, "$g_presentation_obj_admin_menu_ban_player_temp", -1),
      (try_end),

      (try_begin),
        (player_slot_eq, ":my_player_id", slot_player_admin_no_kick, 0),
        (create_button_overlay, reg0, "str_kick_player", 0),
        (assign, "$g_presentation_obj_admin_menu_kick_player", reg0),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", escape_menu_item_height),
      (else_try),
        (assign, "$g_presentation_obj_admin_menu_kick_player", -1),
      (try_end),

      (try_begin),
        (player_is_active, "$g_target_player_id"),
        (player_slot_eq, "$g_target_player_id", slot_player_list_button_id, -1),
        (str_store_player_username, s1, "$g_target_player_id"),
        (str_store_string, s0, "str_choose_an_option_targeting_s1"),
      (else_try),
        (str_store_string, s0, "str_choose_an_option"),
      (try_end),
      (create_text_overlay, reg0, s0, 0),
      (overlay_set_color, reg0, 0xFFFFFF),
      (overlay_set_size, reg0, pos2),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),

      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_event_state_change,
     [(store_trigger_param_1, ":object"),
      (try_begin),
        (eq, ":object", "$g_presentation_obj_admin_menu_kick_player"),
        (assign, ":action", admin_action_kick_player),
        (assign, "$g_list_players_action_string_id", "str_kick"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_menu_ban_player_temp"),
        (assign, ":action", admin_action_ban_player_temp),
        (assign, "$g_list_players_action_string_id", "str_ban_temp"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_menu_ban_player_perm"),
        (assign, ":action", admin_action_ban_player_perm),
        (assign, "$g_list_players_action_string_id", "str_ban_perm"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_menu_mute_player"),
        (assign, ":action", admin_action_mute_player),
        (assign, "$g_list_players_action_string_id", "str_mute"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_menu_kill_player"),
        (assign, ":action", admin_action_kill_player),
        (assign, "$g_list_players_action_string_id", "str_kill"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_menu_fade_player_out"),
        (assign, ":action", admin_action_fade_player_out),
        (assign, "$g_list_players_action_string_id", "str_fade_out"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_menu_freeze_player"),
        (assign, ":action", admin_action_freeze_player),
        (assign, "$g_list_players_action_string_id", "str_freeze"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_menu_teleport_to_player"),
        (assign, ":action", admin_action_teleport_to_player),
        (assign, "$g_list_players_action_string_id", "str_teleport_to"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_menu_teleport_behind_player"),
        (assign, ":action", admin_action_teleport_behind_player),
        (assign, "$g_list_players_action_string_id", "str_teleport_behind"),
      (else_try),
        (assign, ":action", -1),
        (eq, ":object", "$g_presentation_obj_admin_menu_teleport_forwards"),
        (multiplayer_send_int_to_server, client_event_admin_action, admin_action_teleport_forwards),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_menu_admin_armor"),
        (multiplayer_send_int_to_server, client_event_admin_action, admin_action_get_armor),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_menu_become_invisible"),
        (multiplayer_send_int_to_server, client_event_admin_action, admin_action_get_invisible),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_menu_refill_health"),
        (multiplayer_send_int_to_server, client_event_admin_action, admin_action_refill_health),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_menu_become_godlike"),
        (multiplayer_send_int_to_server, client_event_admin_action, admin_action_become_godlike),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_menu_admin_horse"),
        (multiplayer_send_int_to_server, client_event_admin_action, admin_action_get_horse),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_menu_remove_horses"),
        (multiplayer_send_int_to_server, client_event_admin_action, admin_action_remove_horses),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_menu_remove_stray_horses"),
        (multiplayer_send_int_to_server, client_event_admin_action, admin_action_remove_stray_horses),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_menu_teleport_to_ships"),
        (multiplayer_send_int_to_server, client_event_admin_action, admin_action_teleport_to_ships),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_menu_reset_ships"),
        (multiplayer_send_int_to_server, client_event_admin_action, admin_action_reset_ships),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_menu_lock_faction"),
        (multiplayer_send_int_to_server, client_event_admin_action, admin_action_lock_faction),
      (try_end),
      (gt, ":action", -1),
      (presentation_set_duration, 0),
      (try_begin),
        (player_is_active, "$g_target_player_id"),
        (player_slot_eq, "$g_target_player_id", slot_player_list_button_id, -1),
        (multiplayer_send_2_int_to_server, client_event_admin_action, ":action", "$g_target_player_id"),
      (else_try),
        (assign, "$g_list_players_event", client_event_admin_action),
        (assign, "$g_list_players_event_value", ":action"),
        (assign, "$g_list_players_return_presentation", "prsnt_admin_menu"),
        (start_presentation, "prsnt_list_players"),
      (try_end),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":cur_time"),
      (try_begin),
        (key_clicked, key_escape),
        (gt, ":cur_time", 200),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    ]),

  ("faction_admin_menu", prsntf_manual_end_only, 0,
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),

      (create_mesh_overlay, reg0, "mesh_mp_ingame_menu"),
      (position_set_x, pos1, 250),
      (position_set_y, pos1, 80),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos1, 1000),
      (position_set_y, pos1, 1000),
      (overlay_set_size, reg0, pos1),

      (str_clear, s0),
      (create_text_overlay, reg0, s0, tf_scrollable_style_2),
      (position_set_x, pos1, 285),
      (position_set_y, pos1, 125),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos1, 405),
      (position_set_y, pos1, 500),
      (overlay_set_area_size, reg0, pos1),
      (set_container_overlay, reg0),

      (init_position, pos2),
      (position_set_x, pos2, 900),
      (position_set_y, pos2, 900),
      (assign, ":cur_y", 10),
      (position_set_x, pos1, 200),

      (create_button_overlay, "$g_presentation_obj_faction_admin_relation_peaceful", "str_offer_faction_peace", tf_center_justify),
      (overlay_set_color, "$g_presentation_obj_faction_admin_relation_peaceful", 0xFFFFFF),
      (overlay_set_size, "$g_presentation_obj_faction_admin_relation_peaceful", pos2),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_faction_admin_relation_peaceful", pos1),
      (val_add, ":cur_y", escape_menu_item_height),

      (create_button_overlay, "$g_presentation_obj_faction_admin_relation_hostile", "str_declare_faction_hostile", tf_center_justify),
      (overlay_set_color, "$g_presentation_obj_faction_admin_relation_hostile", 0xFFFFFF),
      (overlay_set_size, "$g_presentation_obj_faction_admin_relation_hostile", pos2),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_faction_admin_relation_hostile", pos1),
      (val_add, ":cur_y", escape_menu_item_height),

      (create_button_overlay, "$g_presentation_obj_faction_admin_manage_announcers", "str_manage_announcers", tf_center_justify),
      (overlay_set_color, "$g_presentation_obj_faction_admin_manage_announcers", 0xFFFFFF),
      (overlay_set_size, "$g_presentation_obj_faction_admin_manage_announcers", pos2),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_faction_admin_manage_announcers", pos1),
      (val_add, ":cur_y", escape_menu_item_height),

      (create_button_overlay, "$g_presentation_obj_faction_admin_manage_item_keys", "str_manage_item_chest_keys", tf_center_justify),
      (overlay_set_color, "$g_presentation_obj_faction_admin_manage_item_keys", 0xFFFFFF),
      (overlay_set_size, "$g_presentation_obj_faction_admin_manage_item_keys", pos2),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_faction_admin_manage_item_keys", pos1),
      (val_add, ":cur_y", escape_menu_item_height),

      (create_button_overlay, "$g_presentation_obj_faction_admin_manage_money_keys", "str_manage_money_chest_keys", tf_center_justify),
      (overlay_set_color, "$g_presentation_obj_faction_admin_manage_money_keys", 0xFFFFFF),
      (overlay_set_size, "$g_presentation_obj_faction_admin_manage_money_keys", pos2),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_faction_admin_manage_money_keys", pos1),
      (val_add, ":cur_y", escape_menu_item_height),

      (create_button_overlay, "$g_presentation_obj_faction_admin_manage_door_keys", "str_manage_door_keys", tf_center_justify),
      (overlay_set_color, "$g_presentation_obj_faction_admin_manage_door_keys", 0xFFFFFF),
      (overlay_set_size, "$g_presentation_obj_faction_admin_manage_door_keys", pos2),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_faction_admin_manage_door_keys", pos1),
      (val_add, ":cur_y", escape_menu_item_height),

      (create_button_overlay, "$g_presentation_obj_faction_admin_mute_player", "str_mute_player", tf_center_justify),
      (overlay_set_color, "$g_presentation_obj_faction_admin_mute_player", 0xFFFFFF),
      (overlay_set_size, "$g_presentation_obj_faction_admin_mute_player", pos2),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_faction_admin_mute_player", pos1),
      (val_add, ":cur_y", escape_menu_item_height),

      (assign, reg0, 0),
      (try_begin),
        (neq, "$g_game_type", "mt_no_money"),
        (assign, reg0, faction_cost_outlaw_player),
      (try_end),
      (str_store_string, s0, "str_outlaw_player"),
      (create_button_overlay, "$g_presentation_obj_faction_admin_outlaw_player", "str_s0__reg0_", tf_center_justify),
      (overlay_set_color, "$g_presentation_obj_faction_admin_outlaw_player", 0xFFFFFF),
      (overlay_set_size, "$g_presentation_obj_faction_admin_outlaw_player", pos2),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_faction_admin_outlaw_player", pos1),
      (val_add, ":cur_y", escape_menu_item_height),

      (try_begin),
        (neq, "$g_game_type", "mt_no_money"),
        (assign, reg0, faction_cost_kick_player),
      (try_end),
      (str_store_string, s0, "str_kick_player_from_faction"),
      (create_button_overlay, "$g_presentation_obj_faction_admin_kick_player", "str_s0__reg0_", tf_center_justify),
      (overlay_set_color, "$g_presentation_obj_faction_admin_kick_player", 0xFFFFFF),
      (overlay_set_size, "$g_presentation_obj_faction_admin_kick_player", pos2),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_faction_admin_kick_player", pos1),
      (val_add, ":cur_y", escape_menu_item_height),

      (try_begin),
        (neq, "$g_game_type", "mt_no_money"),
        (assign, reg0, faction_cost_change_name),
      (try_end),
      (str_store_string, s0, "str_change_faction_name"),
      (create_button_overlay, "$g_presentation_obj_faction_admin_change_name", "str_s0__reg0_", tf_center_justify),
      (overlay_set_color, "$g_presentation_obj_faction_admin_change_name", 0xFFFFFF),
      (overlay_set_size, "$g_presentation_obj_faction_admin_change_name", pos2),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_faction_admin_change_name", pos1),
      (val_add, ":cur_y", escape_menu_item_height),

      (try_begin),
        (neq, "$g_game_type", "mt_no_money"),
        (assign, reg0, faction_cost_change_banner),
      (try_end),
      (str_store_string, s0, "str_change_faction_banner"),
      (create_button_overlay, "$g_presentation_obj_faction_admin_change_banner", "str_s0__reg0_", tf_center_justify),
      (overlay_set_color, "$g_presentation_obj_faction_admin_change_banner", 0xFFFFFF),
      (overlay_set_size, "$g_presentation_obj_faction_admin_change_banner", pos2),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_faction_admin_change_banner", pos1),
      (val_add, ":cur_y", escape_menu_item_height),

      (create_text_overlay, reg0, "str_choose_an_option", 0),
      (overlay_set_color, reg0, 0xFFFFFF),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, reg0, pos1),
      (overlay_set_size, reg0, pos2),

      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_event_state_change,
     [(store_trigger_param_1, ":object"),
      (try_begin),
        (eq, ":object", "$g_presentation_obj_faction_admin_change_banner"),
        (presentation_set_duration, 0),
        (start_presentation, "prsnt_faction_banner_selection"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_faction_admin_change_name"),
        (presentation_set_duration, 0),
        (assign, "$g_chat_box_string_id", "str_change_name_of_your_faction"),
        (assign, "$g_chat_box_event_type", chat_event_type_set_faction_name),
        (start_presentation, "prsnt_chat_box"),
      (else_try),
        (assign, ":found", 1),
        (try_begin),
          (eq, ":object", "$g_presentation_obj_faction_admin_kick_player"),
          (assign, "$g_list_players_event_value", faction_admin_action_kick_player),
          (assign, "$g_list_players_action_string_id", "str_kick"),
        (else_try),
          (eq, ":object", "$g_presentation_obj_faction_admin_outlaw_player"),
          (assign, "$g_list_players_event_value", faction_admin_action_outlaw_player),
          (assign, "$g_list_players_action_string_id", "str_outlaw"),
        (else_try),
          (assign, "$g_list_players_keep_open", 1),
          (eq, ":object", "$g_presentation_obj_faction_admin_mute_player"),
          (assign, "$g_list_players_event_value", faction_admin_action_mute_player),
          (assign, "$g_list_players_action_string_id", "str_mute"),
        (else_try),
          (eq, ":object", "$g_presentation_obj_faction_admin_manage_door_keys"),
          (assign, "$g_list_players_event_value", faction_admin_action_toggle_player_door_key),
          (assign, "$g_list_players_action_string_id", "str_give_take_door_key"),
        (else_try),
          (eq, ":object", "$g_presentation_obj_faction_admin_manage_money_keys"),
          (assign, "$g_list_players_event_value", faction_admin_action_toggle_player_money_key),
          (assign, "$g_list_players_action_string_id", "str_give_take_money_chest_key"),
        (else_try),
          (eq, ":object", "$g_presentation_obj_faction_admin_manage_item_keys"),
          (assign, "$g_list_players_event_value", faction_admin_action_toggle_player_item_key),
          (assign, "$g_list_players_action_string_id", "str_give_take_item_chest_key"),
        (else_try),
          (eq, ":object", "$g_presentation_obj_faction_admin_manage_announcers"),
          (assign, "$g_list_players_event_value", faction_admin_action_toggle_player_announce),
          (assign, "$g_list_players_action_string_id", "str_allow_disallow_announcing"),
        (else_try),
          (assign, ":found", 0),
        (try_end),
        (eq, ":found", 1),
        (presentation_set_duration, 0),
        (assign, "$g_list_players_event", client_event_faction_admin_action),
        (assign, "$g_list_players_return_presentation", "prsnt_faction_admin_menu"),
        (start_presentation, "prsnt_list_players"),
      (else_try),
        (assign, ":found", 1),
        (try_begin),
          (eq, ":object", "$g_presentation_obj_faction_admin_relation_hostile"),
          (assign, "$g_list_factions_event_value", faction_admin_action_set_relation_hostile),
        (else_try),
          (eq, ":object", "$g_presentation_obj_faction_admin_relation_peaceful"),
          (assign, "$g_list_factions_event_value", faction_admin_action_set_relation_peaceful),
        (else_try),
          (assign, ":found", 0),
        (try_end),
        (eq, ":found", 1),
        (presentation_set_duration, 0),
        (assign, "$g_list_factions_event", client_event_faction_admin_action),
        (assign, "$g_list_factions_return_presentation", "prsnt_faction_admin_menu"),
        (start_presentation, "prsnt_list_factions"),
      (try_end),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":cur_time"),
      (try_begin),
        (key_clicked, key_escape),
        (gt, ":cur_time", 200),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    ]),

  ("respawn_time_counter", prsntf_read_only|prsntf_manual_end_only, 0, # show seconds until respawn and allow requesting the next spawn point
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),
      (gt, "$g_respawn_start_time", 0),
      (eq, "$g_game_ended", 0),

      (assign, "$g_last_respawn_counter_value", -1),
      (str_clear, s0),
      (create_text_overlay, "$g_presentation_obj_respawn_counter", s0, tf_center_justify|tf_with_outline),
      (overlay_set_color, "$g_presentation_obj_respawn_counter", 0xFFFFFF),
      (position_set_x, pos1, 500),
      (position_set_y, pos1, 600),
      (overlay_set_position, "$g_presentation_obj_respawn_counter", pos1),
      (position_set_x, pos1, 2000),
      (position_set_y, pos1, 2000),
      (overlay_set_size, "$g_presentation_obj_respawn_counter", pos1),

      (create_text_overlay, "$g_presentation_obj_respawn_counter_2", "str_press_select_spawn_point", tf_center_justify|tf_with_outline),
      (overlay_set_color, "$g_presentation_obj_respawn_counter_2", 0xFFFFFF),
      (position_set_x, pos1, 500),
      (position_set_y, pos1, 570),
      (overlay_set_position, "$g_presentation_obj_respawn_counter_2", pos1),
      (position_set_x, pos1, 1400),
      (position_set_y, pos1, 1400),
      (overlay_set_size, "$g_presentation_obj_respawn_counter_2", pos1),

      (assign, "$g_presentation_obj_respawn_castle", -1),
      (assign, "$g_respawn_castle_selected", -1),

      (omit_key_once, key_1),
      (omit_key_once, key_2),
      (omit_key_once, key_3),
      (omit_key_once, key_4),
      (omit_key_once, key_5),
      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_run,
     [(set_fixed_point_multiplier, 1000),
      (try_begin),
        (eq, "$g_game_ended", 0),
        (store_mission_timer_a, ":current_time"),
        (store_add, ":respawn_remaining_time", "$g_respawn_start_time", "$g_respawn_period"),
        (val_sub, ":respawn_remaining_time", ":current_time"),
        (try_begin),
          (this_or_next|le, ":respawn_remaining_time", 0),
          (gt, ":respawn_remaining_time", "$g_respawn_period"),
          (assign, "$g_respawn_start_time", 0),
          (presentation_set_duration, 0),
        (else_try),
          (multiplayer_get_my_player, ":player_id"),
          (player_is_active, ":player_id"),
          (player_get_slot, ":faction_id", ":player_id", slot_player_faction_id),
          (try_begin), # check for valid castles to spawn at, displaying the next if that control is pressed
            (neq, "$g_game_type", "mt_permanent_death"),
            (is_between, ":faction_id", castle_factions_begin, factions_end),
            (this_or_next|eq, "$g_presentation_obj_respawn_castle", -1),
            (key_clicked, key_tilde),
            (assign, ":loop_end", slot_mission_data_castle_owner_faction_end + 1),
            (try_for_range, ":unused", slot_mission_data_castle_owner_faction_begin, ":loop_end"),
              (val_add, "$g_respawn_castle_selected", 1),
              (try_begin),
                (neg|is_between, "$g_respawn_castle_selected", slot_mission_data_castle_owner_faction_begin, slot_mission_data_castle_owner_faction_end + 1),
                (assign, "$g_respawn_castle_selected", slot_mission_data_castle_owner_faction_begin),
              (try_end),
              (try_begin),
                (eq, "$g_respawn_castle_selected", slot_mission_data_castle_owner_faction_end), # restarting as a peasant commoner
                (str_store_string, s1, "str_restart_as_peasant_commoner"),
                (assign, ":loop_end", -1),
              (else_try),
                (call_script, "script_cf_castle_is_active", "$g_respawn_castle_selected"),
                (troop_slot_eq, "trp_mission_data", "$g_respawn_castle_selected", ":faction_id"),
                (call_script, "script_str_store_castle_name", s1, "$g_respawn_castle_selected"),
                (assign, ":loop_end", -1),
              (try_end),
            (try_end),
            (try_begin),
              (eq, ":loop_end", -1),
              (try_begin),
                (le, "$g_presentation_obj_respawn_castle", -1),
                (create_text_overlay, "$g_presentation_obj_respawn_castle", "str_press_select_spawn_area", tf_center_justify|tf_with_outline),
                (overlay_set_color, "$g_presentation_obj_respawn_castle", 0xFFFFFF),
                (position_set_x, pos1, 500),
                (position_set_y, pos1, 540),
                (overlay_set_position, "$g_presentation_obj_respawn_castle", pos1),
                (position_set_x, pos1, 1400),
                (position_set_y, pos1, 1400),
                (overlay_set_size, "$g_presentation_obj_respawn_castle", pos1),
              (else_try),
                (overlay_set_text, "$g_presentation_obj_respawn_castle", "str_press_select_spawn_area"),
                (overlay_set_display, "$g_presentation_obj_respawn_castle", 1),
              (try_end),
            (else_try),
              (assign, "$g_respawn_castle_selected", -1),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$g_respawn_castle_selected", -1),
            (neg|is_between, ":faction_id", castle_factions_begin, factions_end),
            (gt, "$g_presentation_obj_respawn_castle", -1),
            (overlay_set_display, "$g_presentation_obj_respawn_castle", 0),
          (try_end),
          (assign, ":spawn_point_selected", 0),
          (try_begin),
            (key_clicked, key_1),
            (assign, ":spawn_point_selected", 1),
          (else_try),
            (key_clicked, key_2),
            (assign, ":spawn_point_selected", 2),
          (else_try),
            (key_clicked, key_3),
            (assign, ":spawn_point_selected", 3),
          (else_try),
            (key_clicked, key_4),
            (assign, ":spawn_point_selected", 4),
          (else_try),
            (key_clicked, key_5),
            (assign, ":spawn_point_selected", 5),
          (try_end),
          (try_begin),
            (is_between, ":spawn_point_selected", 1, 6),
            (clear_omitted_keys),
            (try_begin),
              (is_between, "$g_respawn_castle_selected", slot_mission_data_castle_owner_faction_begin, slot_mission_data_castle_owner_faction_end),
              (store_add, ":castle_entry_point_begin", "$g_respawn_castle_selected", castle_factions_begin),
              (val_mul, ":castle_entry_point_begin", 10),
              (val_add, ":spawn_point_selected", ":castle_entry_point_begin"),
            (try_end),
            (try_begin),
              (eq, "$g_respawn_castle_selected", slot_mission_data_castle_owner_faction_end), # restarting as a peasant commoner
              (multiplayer_send_2_int_to_server, client_event_request_spawn_point, ":spawn_point_selected", 1),
            (else_try),
              (multiplayer_send_int_to_server, client_event_request_spawn_point, ":spawn_point_selected"),
            (try_end),
            (overlay_set_display, "$g_presentation_obj_respawn_counter_2", 0),
            (gt, "$g_presentation_obj_respawn_castle", -1),
            (overlay_set_display, "$g_presentation_obj_respawn_castle", 0),
          (try_end),
          (neq, "$g_last_respawn_counter_value", ":respawn_remaining_time"),
          (assign, "$g_last_respawn_counter_value", ":respawn_remaining_time"),
          (assign, reg0, ":respawn_remaining_time"),
          (overlay_set_text, "$g_presentation_obj_respawn_counter", "str_respawning_in_reg0_seconds"),
          (player_get_team_no, ":team", ":player_id"),
          (try_begin),
            (eq, ":team", team_spectators),
            (assign, ":display", 0),
          (else_try),
            (assign, ":display", 1),
          (try_end),
          (overlay_set_display, "$g_presentation_obj_respawn_counter", ":display"),
        (try_end),
      (else_try),
        (assign, "$g_respawn_start_time", 0),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    ]),

  ("tabbed_stats_chart", prsntf_manual_end_only, 0, # displays tab buttons marked with faction symbols to view lists of members and their stats
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),

      (multiplayer_get_my_player, ":my_player_id"),
      (player_is_active, ":my_player_id"),

      (create_mesh_overlay, reg1, "mesh_mp_score_b"),
      (position_set_x, pos1, 100),
      (position_set_y, pos1, 100),
      (overlay_set_position, reg1, pos1),
      (position_set_x, pos1, 1000),
      (position_set_y, pos1, 1000),
      (overlay_set_size, reg1, pos1),

      (assign, ":faction_count", 0),
      (assign, ":selected_button_x", 10), # calculate position of the frame for the selected faction button (10 = all players)
      (try_for_range, ":faction_id", factions_begin, factions_end),
        (faction_slot_eq, ":faction_id", slot_faction_is_active, 1),
        (try_begin),
          (eq, ":faction_id", "$g_stats_chart_selected_faction_id"),
          (assign, ":selected_button_x", ":faction_count"),
        (try_end),
        (val_add, ":faction_count", 1),
      (try_end),
      (try_begin),
        (eq, ":selected_button_x", 10),
        (assign, "$g_stats_chart_selected_faction_id", -1),
      (try_end),
      (create_mesh_overlay, reg1, "mesh_pw_stats_chart_selected"),
      (val_mul, ":selected_button_x", 67),
      (val_add, ":selected_button_x", 122),
      (position_set_x, pos1, ":selected_button_x"),
      (position_set_y, pos1, 567),
      (overlay_set_position, reg1, pos1),
      (position_set_x, pos10, 550),
      (position_set_y, pos10, 750),
      (overlay_set_size, reg1, pos10),

      (position_set_x, pos10, 500),
      (position_set_y, pos10, 500),
      (assign, ":x_pos", 158),
      (position_set_y, pos1, 575),
      (try_for_range, ":faction_id", factions_begin, factions_end), # create symbol buttons for all active factions in the scene
        (faction_slot_eq, ":faction_id", slot_faction_is_active, 1),
        (try_begin),
          (eq, ":faction_id", "fac_commoners"),
          (create_image_button_overlay, ":button_overlay_id", "mesh_pw_stats_chart_commoners", "mesh_pw_stats_chart_commoners"),
        (else_try),
          (eq, ":faction_id", "fac_outlaws"),
          (create_image_button_overlay, ":button_overlay_id", "mesh_pw_stats_chart_outlaws", "mesh_pw_stats_chart_outlaws"),
        (else_try),
          (faction_get_slot, ":banner_mesh", ":faction_id", slot_faction_banner_mesh),
          (try_begin),
            (gt, "$g_stats_chart_selected_faction_id", -1),
            (call_script, "script_cf_factions_are_hostile", "$g_stats_chart_selected_faction_id", ":faction_id"),
            (assign, ":tableau_id", "tableau_stats_chart_banner_war"),
          (else_try),
            (assign, ":tableau_id", "tableau_stats_chart_banner"),
          (try_end),
          (create_image_button_overlay_with_tableau_material, ":button_overlay_id", "mesh_pw_stats_chart_banner", ":tableau_id", ":banner_mesh"),
        (try_end),
        (position_set_x, pos1, ":x_pos"),
        (val_add, ":x_pos", 67),
        (overlay_set_position, ":button_overlay_id", pos1),
        (overlay_set_size, ":button_overlay_id", pos10),
      (try_end),
      (create_image_button_overlay, "$g_presentation_obj_stats_chart_all_factions", "mesh_pw_stats_chart_all", "mesh_pw_stats_chart_all"),
      (position_set_x, pos1, 828),
      (position_set_y, pos1, 567),
      (overlay_set_position, "$g_presentation_obj_stats_chart_all_factions", pos1),
      (overlay_set_size, "$g_presentation_obj_stats_chart_all_factions", pos10),
      (store_sub, "$g_presentation_obj_stats_chart_faction_begin", "$g_presentation_obj_stats_chart_all_factions", ":faction_count"),

      (assign, ":faction_id", "$g_stats_chart_selected_faction_id"),
      (player_get_slot, ":my_faction_id", ":my_player_id", slot_player_faction_id),
      (get_max_players, ":max_players"),
      (assign, ":player_count", 0),
      (assign, ":player_total", 0),
      (try_for_range, ":player_id", 1, ":max_players"),
        (player_is_active, ":player_id"),
        (val_add, ":player_total", 1),
        (this_or_next|eq, ":faction_id", -1),
        (player_slot_eq, ":player_id", slot_player_faction_id, ":faction_id"),
        (try_begin),
          (eq, ":faction_id", -1), # when displaying all players, don't list in any particular order
          (assign, ":player_ranking", ":player_id"),
        (else_try),
          (try_begin), # when listing a single faction, order by troop type if a castle owning faction, then by score
            (eq, ":faction_id", ":my_faction_id"),
            (ge, ":faction_id", castle_factions_begin),
            (player_get_agent_id, ":agent_id", ":player_id"),
            (try_begin),
              (agent_is_active, ":agent_id"),
              (agent_is_alive, ":agent_id"),
              (agent_get_troop_id, ":troop_id", ":agent_id"),
            (else_try),
              (player_get_troop_id, ":troop_id", ":player_id"),
            (try_end),
            (troop_get_slot, ":player_ranking", ":troop_id", slot_troop_ranking),
            (val_clamp, ":player_ranking", 1, 101),
          (else_try),
            (assign, ":player_ranking", 1),
          (try_end),
          (player_get_score, ":player_score", ":player_id"),
          (val_add, ":player_score", stats_chart_score_max / 2),
          (val_clamp, ":player_score", 0, stats_chart_score_max),
          (val_lshift, ":player_score", stats_chart_score_shift),
          (val_lshift, ":player_ranking", stats_chart_ranking_shift), # score troop ranking in the highest bits (most priority)
          (val_or, ":player_ranking", ":player_score"), # store score in the middle bits (lower priority)
          (val_or, ":player_ranking", ":player_id"), # store player id in the lowest bits (tiebreaker only if above values are identical)
        (try_end),
        (troop_set_slot, "trp_temp_array", ":player_count", ":player_ranking"),
        (val_add, ":player_count", 1),
      (try_end),

      (try_begin),
        (neq, ":faction_id", -1), # insertion sort of players to be listed, by calculated ranking
        (try_for_range, ":current_index", 1, ":player_count"),
          (troop_get_slot, ":current_value", "trp_temp_array", ":current_index"),
          (assign, ":end_loop", 0),
          (try_for_range_backwards, ":compare_index", ":end_loop", ":current_index"),
            (troop_get_slot, ":compare_value", "trp_temp_array", ":compare_index"),
            (store_add, ":write_index", ":compare_index", 1),
            (try_begin),
              (lt, ":current_value", ":compare_value"),
              (troop_set_slot, "trp_temp_array", ":write_index", ":compare_value"),
              (try_begin),
                (eq, ":compare_index", 0),
                (troop_set_slot, "trp_temp_array", 0, ":current_value"),
              (try_end),
            (else_try),
              (assign, ":end_loop", ":compare_index"),
              (troop_set_slot, "trp_temp_array", ":write_index", ":current_value"),
            (try_end),
          (try_end),
        (try_end),

        (str_store_faction_name, s1, ":faction_id"),
        (faction_get_color, ":title_color", ":faction_id"),
      (else_try),
        (str_store_string, s1, "str_all_players"),
        (assign, ":title_color", 0xFFFFFF),
      (try_end),
      (create_text_overlay, reg1, s1),
      (overlay_set_color, reg1, ":title_color"),
      (position_set_x, pos0, 120),
      (position_set_y, pos0, 520),
      (overlay_set_position, reg1, pos0),
      (position_set_x, pos10, 2000),
      (position_set_y, pos10, 2000),
      (overlay_set_size, reg1, pos10),

      (assign, reg0, ":player_count"),
      (try_begin),
        (neq, ":faction_id", -1),
        (assign, reg1, ":player_total"),
        (try_begin),
          (neq, ":player_count", 1),
          (assign, ":string_id", "str_reg0_players_of_reg1"),
        (else_try),
          (assign, ":string_id", "str_reg0_player_of_reg1"),
        (try_end),
      (else_try),
        (neq, ":player_count", 1),
        (assign, ":string_id", "str_reg0_players"),
      (else_try),
        (assign, ":string_id", "str_reg0_player"),
      (try_end),
      (create_text_overlay, reg2, ":string_id", tf_right_align),
      (overlay_set_color, reg2, 0xFFFFFF),
      (position_set_x, pos0, 860),
      (position_set_y, pos0, 525),
      (overlay_set_position, reg2, pos0),
      (position_set_x, pos10, 1000),
      (position_set_y, pos10, 1000),
      (overlay_set_size, reg2, pos10),

      (position_set_x, pos11, 750),
      (position_set_y, pos11, 750),

      (assign, ":castle_found", 0), # list castles owned by the faction
      (try_for_range, ":castle_owner_slot", slot_mission_data_castle_owner_faction_begin, slot_mission_data_castle_owner_faction_end),
        (troop_slot_eq, "trp_mission_data", ":castle_owner_slot", ":faction_id"),
        (call_script, "script_cf_castle_is_active", ":castle_owner_slot"),
        (call_script, "script_str_store_castle_name", s1, ":castle_owner_slot"),
        (try_begin),
          (eq, ":castle_found", 0),
          (assign, ":castle_found", 1),
          (str_store_string_reg, s0, s1),
        (else_try),
          (str_store_string, s0, "str_s0__s1"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":castle_found", 1),
        (create_text_overlay, reg1, s0),
        (overlay_set_color, reg1, ":title_color"),
        (position_set_x, pos0, 120),
        (position_set_y, pos0, 504),
        (overlay_set_position, reg1, pos0),
        (overlay_set_size, reg1, pos11),
      (try_end),

      (assign, ":cur_y", 480),
      (assign, ":start_x", 120),
      (position_set_x, pos1, ":start_x"),
      (store_add, ":class_x", ":start_x", 540),
      (position_set_x, pos2, ":class_x"),
      (store_add, ":kills_x", ":start_x", 600),
      (position_set_x, pos3, ":kills_x"),
      (store_add, ":deaths_x", ":start_x", 655),
      (position_set_x, pos4, ":deaths_x"),
      (store_add, ":ping_x", ":start_x", 710),
      (position_set_x, pos5, ":ping_x"),
      (position_set_y, pos1, ":cur_y"),
      (position_set_y, pos2, ":cur_y"),
      (position_set_y, pos3, ":cur_y"),
      (position_set_y, pos4, ":cur_y"),
      (position_set_y, pos5, ":cur_y"),

      (create_text_overlay, reg1, "str_player_name", 0),
      (overlay_set_color, reg1, 0xFFFFFF),
      (overlay_set_position, reg1, pos1),
      (overlay_set_size, reg1, pos11),

      (try_begin),
        (eq, ":faction_id", ":my_faction_id"),
        (ge, ":faction_id", castle_factions_begin),
        (create_text_overlay, reg1, "str_class", tf_center_justify),
        (overlay_set_color, reg1, 0xFFFFFF),
        (overlay_set_position, reg1, pos2),
        (overlay_set_size, reg1, pos11),
      (try_end),

      (create_text_overlay, reg1, "str_kills", tf_center_justify),
      (overlay_set_color, reg1, 0xFFFFFF),
      (overlay_set_position, reg1, pos3),
      (overlay_set_size, reg1, pos11),

      (create_text_overlay, reg1, "str_deaths", tf_center_justify),
      (overlay_set_color, reg1, 0xFFFFFF),
      (overlay_set_position, reg1, pos4),
      (overlay_set_size, reg1, pos11),

      (create_text_overlay, reg1, "str_ping", tf_center_justify),
      (overlay_set_color, reg1, 0xFFFFFF),
      (overlay_set_position, reg1, pos5),
      (overlay_set_size, reg1, pos11),

      (create_mesh_overlay, reg1, "mesh_white_plane"),
      (overlay_set_color, reg1, 0xFFFFFF),
      (overlay_set_alpha, reg1, 0xD0),
      (position_set_x, pos0, ":start_x"),
      (store_sub, ":separator_y", ":cur_y", 5),
      (position_set_y, pos0, ":separator_y"),
      (overlay_set_position, reg1, pos0),
      (position_set_x, pos10, 37350),
      (position_set_y, pos10, 50),
      (overlay_set_size, reg1, pos10),

      (str_clear, s0),
      (create_text_overlay, ":container", s0, tf_scrollable_style_2),
      (position_set_x, pos0, 100),
      (position_set_y, pos0, 125),
      (overlay_set_position, ":container", pos0),
      (position_set_x, pos0, 750),
      (position_set_y, pos0, 340),
      (overlay_set_area_size, ":container", pos0),
      (set_container_overlay, ":container"),

      (try_for_range, ":position_no", 1, 3),
        (position_get_x, ":temp_x", ":position_no"),
        (val_sub, ":temp_x", 100),
        (position_set_x, ":position_no", ":temp_x"),
      (try_end),
      (try_for_range, ":position_no", 3, 6),
        (position_get_x, ":temp_x", ":position_no"),
        (val_sub, ":temp_x", 91),
        (position_set_x, ":position_no", ":temp_x"),
      (try_end),
      (val_sub, ":start_x", 100),
      (store_mul, ":cur_y", ":player_count", player_list_item_height),

      (try_for_range_backwards, ":player_index", 0, ":player_count"),
        (troop_get_slot, ":player_id", "trp_temp_array", ":player_index"),
        (val_and, ":player_id", stats_chart_player_mask), # strip the upper ranking bits from the player id

        (val_sub, ":cur_y", player_list_item_height),
        (position_set_y, pos1, ":cur_y"),
        (position_set_y, pos2, ":cur_y"),
        (position_set_y, pos3, ":cur_y"),
        (position_set_y, pos4, ":cur_y"),
        (position_set_y, pos5, ":cur_y"),

        (try_begin),
          (eq, ":player_id", ":my_player_id"),
          (create_mesh_overlay, reg1, "mesh_white_plane"),
          (overlay_set_color, reg1, 0xFFFFFF),
          (overlay_set_alpha, reg1, 0x35),
          (overlay_set_position, reg1, pos1),
          (position_set_x, pos10, 37350),
          (position_set_y, pos10, 1000),
          (overlay_set_size, reg1, pos10),
        (try_end),

        (try_begin),
          (player_slot_eq, ":player_id", slot_player_is_lord, 1),
          (create_mesh_overlay, reg1, "mesh_white_plane"),
          (overlay_set_color, reg1, 0xFFEE55),
          (overlay_set_alpha, reg1, 0x35),
          (store_add, ":lord_x", ":start_x", 2),
          (position_set_x, pos0, ":lord_x"),
          (store_add, ":lord_y", ":cur_y", 2),
          (position_set_y, pos0, ":lord_y"),
          (overlay_set_position, reg1, pos0),
          (position_set_x, pos10, 36275),
          (position_set_y, pos10, 820),
          (overlay_set_size, reg1, pos10),
        (try_end),

        (try_begin),
          (eq, ":faction_id", -1),
          (player_get_slot, ":player_faction_id", ":player_id", slot_player_faction_id),
          (faction_get_color, ":player_color", ":player_faction_id"),
        (else_try),
          (player_get_agent_id, ":agent_id", ":player_id"),
          (agent_is_active, ":agent_id"),
          (agent_is_alive, ":agent_id"),
          (agent_get_troop_id, ":troop_id", ":agent_id"),
          (assign, ":player_color", 0xFFFFFF),
        (else_try),
          (player_get_troop_id, ":troop_id", ":player_id"),
          (assign, ":player_color", 0xFF0000),
        (try_end),

        (str_store_player_username, s1, ":player_id"),
        (create_text_overlay, reg1, s1, 0),
        (overlay_set_color, reg1, ":player_color"),
        (overlay_set_size, reg1, pos11),
        (overlay_set_position, reg1, pos1),

        (try_begin),
          (eq, ":faction_id", ":my_faction_id"),
          (is_between, ":faction_id", castle_factions_begin, factions_end),
          (str_store_troop_name, s1, ":troop_id"),
          (create_text_overlay, reg1, s1, tf_center_justify),
          (overlay_set_color, reg1, ":player_color"),
          (overlay_set_size, reg1, pos11),
          (overlay_set_position, reg1, pos2),
        (try_end),

        (player_get_kill_count, reg0, ":player_id"),
        (create_text_overlay, reg1, "str_reg0", tf_right_align),
        (overlay_set_color, reg1, ":player_color"),
        (overlay_set_size, reg1, pos11),
        (overlay_set_position, reg1, pos3),

        (player_get_death_count, reg0, ":player_id"),
        (create_text_overlay, reg1, "str_reg0", tf_right_align),
        (overlay_set_color, reg1, ":player_color"),
        (overlay_set_size, reg1, pos11),
        (overlay_set_position, reg1, pos4),

        (player_get_ping, reg0, ":player_id"),
        (create_text_overlay, reg1, "str_reg0", tf_right_align),
        (overlay_set_color, reg1, ":player_color"),
        (overlay_set_size, reg1, pos11),
        (overlay_set_position, reg1, pos5),
      (try_end),

      (store_mul, "$g_stats_chart_update_period", ":player_count", 100), # update less often when there are more players to sort
      (val_max, "$g_stats_chart_update_period", 1000),

      (omit_key_once, key_mouse_scroll_up),
      (omit_key_once, key_mouse_scroll_down),
      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_event_state_change,
     [(store_trigger_param_1, ":overlay_id"),
      (try_begin),
        (is_between, ":overlay_id", "$g_presentation_obj_stats_chart_faction_begin", "$g_presentation_obj_stats_chart_all_factions"),
        (store_sub, ":active_faction_no", ":overlay_id", "$g_presentation_obj_stats_chart_faction_begin"),
        (assign, ":test_faction_no", -1),
        (assign, ":loop_end", factions_end), # calculate the faction id of the tab clicked
        (try_for_range, ":faction_id", factions_begin, ":loop_end"),
          (faction_slot_eq, ":faction_id", slot_faction_is_active, 1),
          (val_add, ":test_faction_no", 1),
          (eq, ":test_faction_no", ":active_faction_no"),
          (assign, "$g_stats_chart_selected_faction_id", ":faction_id"),
          (assign, ":loop_end", 0),
        (try_end),
      (else_try),
        (eq, ":overlay_id", "$g_presentation_obj_stats_chart_all_factions"),
        (assign, "$g_stats_chart_selected_faction_id", -1),
      (try_end),
      (clear_omitted_keys),
      (presentation_set_duration, 0),
      (start_presentation, "prsnt_tabbed_stats_chart"),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":cur_time"),
      (try_begin),
        (this_or_next|key_clicked, key_mouse_scroll_up),
        (key_clicked, key_mouse_scroll_down),
        (omit_key_once, key_mouse_scroll_up),
        (omit_key_once, key_mouse_scroll_down),
      (try_end),
      (try_begin),
        (eq, "$g_stats_chart_opened_manually", 1),
        (neg|game_key_is_down, gk_stats_chart),
        (assign, "$g_stats_chart_opened_manually", 0),
        (clear_omitted_keys),
        (presentation_set_duration, 0),
      (else_try),
        (gt, ":cur_time", "$g_stats_chart_update_period"),
        (clear_omitted_keys),
        (presentation_set_duration, 0),
        (start_presentation, "prsnt_tabbed_stats_chart"),
      (try_end),
      ]),
    ]),

  ("preset_message_small", prsntf_read_only|prsntf_manual_end_only, 0,
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),
      (try_begin),
        (eq, "$g_preset_message_type", preset_message_small),
        (assign, "$g_preset_message_type", 0),
        # keep the same as in prsnt_preset_message_* and script_preset_message
        (try_begin),
          (eq, "$g_preset_message_params", preset_message_item),
          (is_between, "$g_preset_message_value_1", 1, all_items_end),
          (str_store_item_name, s1, "$g_preset_message_value_1"),
        (else_try),
          (eq, "$g_preset_message_params", preset_message_agent),
          (agent_is_active, "$g_preset_message_value_1"),
          (str_store_agent_name, s1, "$g_preset_message_value_1"),
        (else_try),
          (eq, "$g_preset_message_params", preset_message_player),
          (player_is_active, "$g_preset_message_value_1"),
          (str_store_player_username, s1, "$g_preset_message_value_1"),
        (else_try),
          (is_between, "$g_preset_message_params", preset_message_faction, preset_message_faction_castle + 1),
          (is_between, "$g_preset_message_value_1", factions_begin, factions_end),
          (str_store_faction_name, s1, "$g_preset_message_value_1"),
          (faction_get_color, "$g_preset_message_color", "$g_preset_message_value_1"),
          (eq, "$g_preset_message_params", preset_message_faction_castle),
          (call_script, "script_str_store_castle_name", s2, "$g_preset_message_value_2"),
        (else_try),
          (assign, reg1, "$g_preset_message_value_1"),
          (assign, reg2, "$g_preset_message_value_2"),
        (try_end),
        # end keep same
        (create_text_overlay, ":overlay_id", "$g_preset_message_string_id", tf_center_justify|tf_with_outline),
        (overlay_set_color, ":overlay_id", "$g_preset_message_color"),
        (position_set_x, pos1, 500),
        (position_set_y, pos1, 600),
        (overlay_set_position, ":overlay_id", pos1),
        (presentation_set_duration, 300),
      (else_try),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    ]),

  ("preset_message_big", prsntf_read_only|prsntf_manual_end_only, 0,
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),
      (try_begin),
        (eq, "$g_preset_message_type", preset_message_big),
        (assign, "$g_preset_message_type", 0),
        # keep the same as in prsnt_preset_message_* and script_preset_message
        (try_begin),
          (eq, "$g_preset_message_params", preset_message_item),
          (is_between, "$g_preset_message_value_1", 1, all_items_end),
          (str_store_item_name, s1, "$g_preset_message_value_1"),
        (else_try),
          (eq, "$g_preset_message_params", preset_message_agent),
          (agent_is_active, "$g_preset_message_value_1"),
          (str_store_agent_name, s1, "$g_preset_message_value_1"),
        (else_try),
          (eq, "$g_preset_message_params", preset_message_player),
          (player_is_active, "$g_preset_message_value_1"),
          (str_store_player_username, s1, "$g_preset_message_value_1"),
        (else_try),
          (is_between, "$g_preset_message_params", preset_message_faction, preset_message_faction_castle + 1),
          (is_between, "$g_preset_message_value_1", factions_begin, factions_end),
          (str_store_faction_name, s1, "$g_preset_message_value_1"),
          (faction_get_color, "$g_preset_message_color", "$g_preset_message_value_1"),
          (eq, "$g_preset_message_params", preset_message_faction_castle),
          (call_script, "script_str_store_castle_name", s2, "$g_preset_message_value_2"),
        (else_try),
          (assign, reg1, "$g_preset_message_value_1"),
          (assign, reg2, "$g_preset_message_value_2"),
        (try_end),
        # end keep same
        (create_text_overlay, ":overlay_id", "$g_preset_message_string_id", tf_center_justify|tf_with_outline),
        (overlay_set_color, ":overlay_id", "$g_preset_message_color"),
        (position_set_x, pos1, 500),
        (position_set_y, pos1, 500),
        (overlay_set_position, ":overlay_id", pos1),
        (position_set_x, pos1, 2000),
        (position_set_y, pos1, 2000),
        (overlay_set_size, ":overlay_id", pos1),
        (presentation_set_duration, 500),
      (else_try),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    ]),

  ("read_object", prsntf_manual_end_only, 0,
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),
      (try_begin),
        (eq, "$g_preset_message_type", preset_message_read_object),
        (assign, "$g_preset_message_type", 0),
        (create_mesh_overlay, reg0, "mesh_mp_ingame_menu"),
        (position_set_x, pos1, 250),
        (position_set_y, pos1, 80),
        (overlay_set_position, reg0, pos1),
        (create_text_overlay, reg0, "$g_preset_message_string_id", tf_scrollable),
        (position_set_x, pos1, 285),
        (position_set_y, pos1, 155),
        (overlay_set_position, reg0, pos1),
        (position_set_x, pos1, 900),
        (position_set_y, pos1, 900),
        (overlay_set_size, reg0, pos1),
        (position_set_x, pos1, 405),
        (position_set_y, pos1, 470),
        (overlay_set_area_size, reg0, pos1),
        (overlay_set_color, reg0, "$g_preset_message_color"),

        (create_button_overlay, reg0, "$g_presentation_read_object_button_string_id", tf_center_justify),
        (overlay_set_color, reg0, 0xFFFFFF),
        (position_set_x, pos1, 500),
        (position_set_y, pos1, 115),
        (overlay_set_position, reg0, pos1),

        (omit_key_once, key_escape),
        (presentation_set_duration, 999999),
      (else_try),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    (ti_on_presentation_event_state_change,
     [(clear_omitted_keys),
      (presentation_set_duration, 0),
      (eq, "$g_presentation_read_object_button_string_id", "str_join_game"),
      (multiplayer_send_message_to_server, client_event_request_spawn_point),
      (assign, "$g_player_has_spawned_after_connecting", 1),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":cur_time"),
      (try_begin),
        (key_clicked, key_escape),
        (gt, ":cur_time", 200),
        (clear_omitted_keys),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    ]),

  ("faction_lord_message", prsntf_read_only|prsntf_manual_end_only, 0,
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),
      (multiplayer_get_my_player, ":player_id"),
      (player_get_slot, ":faction_id", ":player_id", slot_player_faction_id),
      (faction_get_color, ":color", ":faction_id"),
      (create_text_overlay, ":overlay_id", s11, tf_center_justify|tf_with_outline),
      (overlay_set_color, ":overlay_id", ":color"),
      (position_set_x, pos1, 500),
      (position_set_y, pos1, 400),
      (overlay_set_position, ":overlay_id", pos1),
      (position_set_x, pos1, 1500),
      (position_set_y, pos1, 1500),
      (overlay_set_size, ":overlay_id", pos1),
      (presentation_set_duration, 500),
      ]),
    ]),

  ("admin_message", prsntf_read_only|prsntf_manual_end_only, 0,
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),
      (create_text_overlay, ":overlay_id", s12, tf_center_justify|tf_with_outline),
      (overlay_set_color, ":overlay_id", admin_chat_color),
      (position_set_x, pos1, 500),
      (position_set_y, pos1, 450),
      (overlay_set_position, ":overlay_id", pos1),
      (position_set_x, pos1, 1500),
      (position_set_y, pos1, 1500),
      (overlay_set_size, ":overlay_id", pos1),
      (presentation_set_duration, 500),
      ]),
    ]),

  ("display_agent_labels", prsntf_read_only|prsntf_manual_end_only, 0, # display player name and optionally faction name above the heads of nearby agents
   [(ti_on_presentation_load,
     [(assign, "$g_presentation_agent_labels_overlay_count", 0),
      (assign, "$g_presentation_agent_labels_update_time", 0),
      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":current_time"),
      (set_fixed_point_multiplier, 1000),
      (try_begin),
        (eq, "$g_display_agent_labels", 0),
        (presentation_set_duration, 0),
      (else_try),
        (gt, ":current_time", "$g_presentation_agent_labels_update_time"),
        (store_add, "$g_presentation_agent_labels_update_time", ":current_time", 20), # check and update all visible labels every 20 milliseconds
        (multiplayer_get_my_player, ":my_player"),
        (gt, ":my_player", -1),
        (str_clear, s0),
        (mission_cam_get_position, pos1),
        (assign, ":overlay_id", 0),
        (try_for_agents, ":agent_id"),
          (agent_is_human, ":agent_id"),
          (agent_is_alive, ":agent_id"),
          (agent_get_player_id, ":player_id", ":agent_id"),
          (neq, ":player_id", ":my_player"),
          (agent_get_item_slot, ":body_item_id", ":agent_id", ek_body),
          (neq, ":body_item_id", "itm_invisible_body"),
          (agent_get_position, pos2, ":agent_id"),
          (position_move_z, pos2, 160),
          (agent_get_horse, ":horse", ":agent_id"),
          (try_begin),
            (ge, ":horse", 0),
            (position_move_z, pos2, 80),
          (try_end),
          (get_sq_distance_between_positions, ":sq_distance", pos1, pos2),
          (le, ":sq_distance", sq(max_distance_to_see_labels)),
          (copy_position, pos3, pos2),
          (position_move_z, pos3, 50),
          (position_get_screen_projection, pos4, pos3), # get the 2D position on screen 50 above the 3D position of the agent
          (position_get_x, ":x_pos", pos4),
          (position_get_y, ":y_pos", pos4),
          (is_between, ":x_pos", -100, 1100), # check if inside the view boundaries or nearly so
          (is_between, ":y_pos", -100, 850),
          (position_has_line_of_sight_to_position, pos1, pos2),
          (try_begin), # create a new overlay if needed
            (ge, ":overlay_id", "$g_presentation_agent_labels_overlay_count"),
            (create_text_overlay, reg0, s0, tf_center_justify|tf_with_outline),
            (val_add, "$g_presentation_agent_labels_overlay_count", 1),
          (try_end),
          (try_begin),
            (try_begin),
              (player_is_active, ":player_id"),
              (str_store_player_username, s2, ":player_id"),
              (player_get_slot, ":player_faction_id", ":player_id", slot_player_faction_id),
              (try_begin),
                (eq, "$g_hide_faction_in_name_labels", 0),
                (str_store_faction_name, s3, ":player_faction_id"),
                (str_store_string, s2, "str_s2_s3"),
              (try_end),
              (faction_get_color, ":color", ":player_faction_id"),
            (else_try),
              (agent_get_troop_id, ":troop_id", ":agent_id"),
              (str_store_troop_name, s2, ":troop_id"),
              (assign, ":color", invalid_faction_color),
            (try_end),
            (overlay_set_text, ":overlay_id", s2),
            (overlay_set_color, ":overlay_id", ":color"),
            (overlay_set_position, ":overlay_id", pos4),
            (copy_position, pos5, pos3),
            (position_move_z, pos5, 200), # move the 3D position up by 200 and check the 2D distance moved, to get the appropriate text size (reducing with distance)
            (position_get_screen_projection, pos6, pos5),
            (position_get_y, ":y_pos_up", pos6),
            (store_sub, ":height", ":y_pos_up", ":y_pos"),
            (val_mul, ":height", 10),
            (val_min, ":height", 2000),
            (position_set_y, pos6, ":height"),
            (position_set_x, pos6, ":height"),
            (overlay_set_size, ":overlay_id", pos6),
            (overlay_set_display, ":overlay_id", 1),
          (try_end),
          (val_add, ":overlay_id", 1),
        (try_end),
        (try_begin),
          (store_sub, ":redraw_threshold", "$g_presentation_agent_labels_overlay_count", 10),
          (lt, ":overlay_id", ":redraw_threshold"),
          (presentation_set_duration, 0),
          (start_presentation, "prsnt_display_agent_labels"),
        (else_try),
          (try_for_range, ":unused_overlay_id", ":overlay_id", "$g_presentation_agent_labels_overlay_count"),
            (overlay_set_display, ":unused_overlay_id", 0),
          (try_end),
        (try_end),
      (try_end),
      ]),
    ]),

  ])

# Factor out a common part of show_inventory triggers: finding the affected slot.
def prsnt_generate_find_object_slot():
  find_object_slot_list = [(store_trigger_param_1, ":object_id"),
    (neq, ":object_id", "$g_show_inventory_obj_container"),
    (neq, ":object_id", "$g_show_inventory_obj_left_border"),
    (neq, ":object_id", "$g_show_inventory_obj_right_border"),
    (assign, ":found_obj_slot", -1),
    (prop_instance_is_valid, "$g_show_inventory_instance_id"),
    (scene_prop_get_slot, ":inventory_count", "$g_show_inventory_instance_id", slot_scene_prop_inventory_count),
    (store_add, ":inventory_obj_end", ":inventory_count", slot_scene_prop_inventory_obj_begin),
    (try_for_range, ":inventory_obj_slot", slot_scene_prop_inventory_obj_begin, ":inventory_obj_end"),
      (scene_prop_slot_eq, "$g_show_inventory_instance_id", ":inventory_obj_slot", ":object_id"),
      (assign, ":found_obj_slot", ":inventory_obj_slot"),
      (assign, ":inventory_obj_end", slot_scene_prop_inventory_obj_begin),
    (try_end),
    (try_begin),
      (eq, ":found_obj_slot", -1),
      (assign, ":inventory_obj_end", slot_scene_prop_inventory_obj_item_0 + ek_gloves + 1),
      (try_for_range, ":inventory_obj_slot", slot_scene_prop_inventory_obj_begin, ":inventory_obj_end"),
        (scene_prop_slot_eq, "$g_show_inventory_instance_id", ":inventory_obj_slot", ":object_id"),
        (assign, ":found_obj_slot", ":inventory_obj_slot"),
        (assign, ":inventory_obj_end", slot_scene_prop_inventory_obj_item_0),
      (try_end),
    (try_end),
    (gt, ":found_obj_slot", -1),
    ]
  return lazy.block(find_object_slot_list)

presentations.extend([

  ("show_inventory", prsntf_manual_end_only, 0,
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),

      (prop_instance_is_valid, "$g_show_inventory_instance_id"),
      (scene_prop_get_slot, ":inventory_count", "$g_show_inventory_instance_id", slot_scene_prop_inventory_count),
      (gt, ":inventory_count", 0),
      (str_clear, s1),
      (create_text_overlay, "$g_show_inventory_obj_container", s1, tf_scrollable_style_2),
      (position_set_x, pos1, inventory_container_x_offset),
      (position_set_y, pos1, inventory_container_y_offset),
      (overlay_set_position, "$g_show_inventory_obj_container", pos1),
      (position_set_x, pos1, inventory_slots_per_row * inventory_slot_spacing + 3),
      (position_set_y, pos1, 4 * inventory_slot_spacing + 3),
      (overlay_set_area_size, "$g_show_inventory_obj_container", pos1),
      (set_container_overlay, "$g_show_inventory_obj_container"),

      (position_set_x, pos11, 800),
      (position_set_y, pos11, 800),
      (assign, ":current_x", 0),
      (store_div, ":current_y", ":inventory_count", inventory_slots_per_row),
      (store_mod, ":partial_line", ":inventory_count", inventory_slots_per_row),
      (try_begin),
        (eq, ":partial_line", 0),
        (val_sub, ":current_y", 1),
      (try_end),
      (val_mul, ":current_y", inventory_slot_spacing),
      (val_sub, ":current_y", 1),
      (store_add, ":inventory_end", ":inventory_count", slot_scene_prop_inventory_begin),
      (try_for_range, ":inventory_slot", slot_scene_prop_inventory_begin, ":inventory_end"), # show inventory slots with items inside
        (create_image_button_overlay, reg1, "mesh_mp_inventory_choose", "mesh_mp_inventory_choose"),
        (overlay_set_size, reg1, pos11),
        (position_set_x, pos1, ":current_x"),
        (position_set_y, pos1, ":current_y"),
        (overlay_set_position, reg1, pos1),
        (store_add, ":inventory_obj_slot", ":inventory_slot", slot_scene_prop_inventory_obj_begin - slot_scene_prop_inventory_begin),
        (scene_prop_set_slot, "$g_show_inventory_instance_id", ":inventory_obj_slot", reg1),
        (scene_prop_get_slot, ":item_id", "$g_show_inventory_instance_id", ":inventory_slot"),
        (try_begin),
          (ge, ":item_id", all_items_begin),
          (create_mesh_overlay_with_item_id, reg2, ":item_id"),
          (store_add, ":item_x", ":current_x", inventory_mesh_offset),
          (store_add, ":item_y", ":current_y", inventory_mesh_offset),
          (position_set_x, pos2,  ":item_x"),
          (position_set_y, pos2,  ":item_y"),
          (overlay_set_position, reg2, pos2),
        (else_try),
          (assign, reg2, -1),
        (try_end),
        (store_add, ":inventory_mesh_slot", ":inventory_slot", slot_scene_prop_inventory_mesh_begin - slot_scene_prop_inventory_begin),
        (scene_prop_set_slot, "$g_show_inventory_instance_id", ":inventory_mesh_slot", reg2),
        (try_begin),
          (ge, ":current_x", (inventory_slots_per_row - 1) * inventory_slot_spacing),
          (val_sub, ":current_y", inventory_slot_spacing),
          (assign, ":current_x", 0),
        (else_try),
          (val_add, ":current_x", inventory_slot_spacing),
        (try_end),
      (try_end),

      (set_container_overlay, -1), # show the player equipment slots at the edge, outside the scrolling container
      (multiplayer_get_my_player, ":player_id"),
      (player_is_active, ":player_id"),
      (player_get_agent_id, ":agent_id", ":player_id"),
      (agent_is_active, ":agent_id"),
      (try_for_range, ":equip_slot", ek_item_0, ek_gloves + 1),
        (assign, ":mesh_id", "mesh_mp_inventory_slot_equip"),
        (try_begin),
          (eq, ":equip_slot", ek_item_0),
          (position_set_x, pos1, 900),
          (position_set_x, pos2, 900 + inventory_mesh_offset),
          (assign, ":slot_y", 475),
          (assign, ":item_y", 475 + inventory_mesh_offset),
        (else_try),
          (eq, ":equip_slot", ek_head),
          (position_set_x, pos1, 3),
          (position_set_x, pos2, 3 + inventory_mesh_offset),
          (assign, ":slot_y", 475),
          (assign, ":item_y", 475 + inventory_mesh_offset),
          (assign, ":mesh_id", "mesh_mp_inventory_slot_helmet"),
        (else_try),
          (eq, ":equip_slot", ek_body),
          (assign, ":mesh_id", "mesh_mp_inventory_slot_armor"),
        (else_try),
          (eq, ":equip_slot", ek_foot),
          (assign, ":mesh_id", "mesh_mp_inventory_slot_boot"),
        (else_try),
          (eq, ":equip_slot", ek_gloves),
          (assign, ":mesh_id", "mesh_mp_inventory_slot_glove"),
        (try_end),
        (create_image_button_overlay, reg1, ":mesh_id", ":mesh_id"),
        (overlay_set_size, reg1, pos11),
        (position_set_y, pos1, ":slot_y"),
        (overlay_set_position, reg1, pos1),
        (store_add, ":inventory_obj_slot", ":equip_slot", slot_scene_prop_inventory_obj_item_0 - ek_item_0),
        (scene_prop_set_slot, "$g_show_inventory_instance_id", ":inventory_obj_slot", reg1),
        (agent_get_item_slot, ":item_id", ":agent_id", ":equip_slot"),
        (store_add, ":inventory_slot", ":equip_slot", slot_scene_prop_inventory_item_0 - ek_item_0),
        (scene_prop_set_slot, "$g_show_inventory_instance_id", ":inventory_slot", ":item_id"),
        (try_begin),
          (ge, ":item_id", all_items_begin),
          (create_mesh_overlay_with_item_id, reg2, ":item_id"),
          (position_set_y, pos2, ":item_y"),
          (overlay_set_position, reg2, pos2),
        (else_try),
          (assign, reg2, -1),
        (try_end),
        (store_add, ":inventory_mesh_slot", ":equip_slot", slot_scene_prop_inventory_mesh_item_0 - ek_item_0),
        (scene_prop_set_slot, "$g_show_inventory_instance_id", ":inventory_mesh_slot", reg2),
        (val_sub, ":item_y", inventory_slot_spacing),
        (val_sub, ":slot_y", inventory_slot_spacing),
      (try_end),

      (create_mesh_overlay, "$g_show_inventory_obj_left_border", "mesh_mp_inventory_right"),
      (overlay_set_size, "$g_show_inventory_obj_left_border", pos11),
      (position_set_x, pos1, 106),
      (position_set_y, pos1, 685),
      (overlay_set_position, "$g_show_inventory_obj_left_border", pos1),
      (init_position, pos1),
      (position_rotate_z, pos1, 180),
      (overlay_set_mesh_rotation, "$g_show_inventory_obj_left_border", pos1),

      (create_mesh_overlay, "$g_show_inventory_obj_right_border", "mesh_mp_inventory_right"),
      (overlay_set_size, "$g_show_inventory_obj_right_border", pos11),
      (position_set_x, pos1, 894),
      (position_set_y, pos1, 65),
      (overlay_set_position, "$g_show_inventory_obj_right_border", pos1),

      (assign, "$g_show_inventory_selected_slot", -1),
      (assign, "$g_show_inventory_selected_mesh", -1),
      (assign, "$g_show_inventory_item_details", -1),
      (assign, "$g_show_inventory_update_needed", 0),
      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_event_state_change,
     [prsnt_generate_find_object_slot(),
      (set_fixed_point_multiplier, 1000),
      (store_add, ":target_mesh_slot", ":found_obj_slot", slot_scene_prop_inventory_mesh_begin - slot_scene_prop_inventory_obj_begin),
      (scene_prop_get_slot, ":target_mesh_object_id", "$g_show_inventory_instance_id", ":target_mesh_slot"),
      (store_add, ":target_inventory_slot", ":found_obj_slot", slot_scene_prop_inventory_begin - slot_scene_prop_inventory_obj_begin),
      (try_begin), # an item is already selected
        (gt, "$g_show_inventory_selected_slot", -1),
        (try_begin), # if the selected item was put back in its current slot, replace without sending a message to the server
          (eq, ":target_inventory_slot", "$g_show_inventory_selected_slot"),
          (scene_prop_get_slot, ":target_object_id", "$g_show_inventory_instance_id", ":found_obj_slot"),
          (try_begin), # if the target is inside the scrolling container, recalculate the slot position
            (is_between, "$g_show_inventory_selected_slot", slot_scene_prop_inventory_begin, slot_scene_prop_inventory_item_0),
            (overlay_set_container_overlay,  "$g_show_inventory_selected_mesh", "$g_show_inventory_obj_container"),
            (store_sub, ":target_slot_no", ":target_inventory_slot", slot_scene_prop_inventory_begin),
            (store_mod, ":target_mesh_x", ":target_slot_no", inventory_slots_per_row),
            (scene_prop_get_slot, ":inventory_count", "$g_show_inventory_instance_id", slot_scene_prop_inventory_count),
            (store_sub, ":target_mesh_y", ":inventory_count", ":target_slot_no"),
            (val_sub, ":target_mesh_y", 1),
            (val_div, ":target_mesh_y", inventory_slots_per_row),
            (store_mod, ":partial_line_count", ":inventory_count", inventory_slots_per_row),
            (try_begin),
              (ge, ":partial_line_count", 1),
              (ge, ":target_mesh_x", ":partial_line_count"),
              (val_add, ":target_mesh_y", 1),
            (try_end),
            (val_mul, ":target_mesh_x", inventory_slot_spacing),
            (val_mul, ":target_mesh_y", inventory_slot_spacing),
          (else_try), # for fixed equipment slots
            (overlay_get_position, pos1, ":target_object_id"),
            (position_get_x, ":target_mesh_x", pos1),
            (position_get_y, ":target_mesh_y", pos1),
          (try_end),
          (val_add, ":target_mesh_x", inventory_mesh_offset),
          (val_add, ":target_mesh_y", inventory_mesh_offset),
          (position_set_x, pos1, ":target_mesh_x"),
          (position_set_y, pos1, ":target_mesh_y"),
          (overlay_set_position, "$g_show_inventory_selected_mesh", pos1),
          (assign, "$g_show_inventory_selected_slot", -1),
          (assign, "$g_show_inventory_selected_mesh", -1),
        (else_try), # request the selected item be transferred to another slot
          (neg|scene_prop_slot_ge, "$g_show_inventory_instance_id", ":target_inventory_slot", all_items_begin),
          (scene_prop_get_slot, ":item_id", "$g_show_inventory_instance_id", "$g_show_inventory_selected_slot"),
          (ge, ":item_id", all_items_begin),
          (assign, ":error_string_id", "str_item_too_long_for_container"),
          (item_get_slot, ":length", ":item_id", slot_item_length),
          (try_begin),
            (this_or_next|ge, ":target_inventory_slot", slot_scene_prop_inventory_item_0),
            (scene_prop_slot_ge, "$g_show_inventory_instance_id", slot_scene_prop_inventory_max_length, ":length"),
            (assign, ":error_string_id", "str_cant_put_money_bag_in_container"),
            (this_or_next|neq, ":item_id", "itm_money_bag"),
            (ge, ":target_inventory_slot", slot_scene_prop_inventory_item_0),
            (multiplayer_send_4_int_to_server, client_event_transfer_inventory, "$g_show_inventory_instance_id", "$g_show_inventory_selected_slot", ":target_inventory_slot", ":item_id"),
          (else_try),
            (call_script, "script_preset_message", ":error_string_id", preset_message_error, 0, 0),
          (try_end),
        (try_end),
      (else_try), # select an item from a slot
        (le, "$g_show_inventory_selected_slot", -1),
        (gt, ":target_mesh_object_id", -1),
        (store_add, "$g_show_inventory_selected_slot", ":found_obj_slot", slot_scene_prop_inventory_begin - slot_scene_prop_inventory_obj_begin),
        (assign, "$g_show_inventory_selected_mesh", ":target_mesh_object_id"),
        (overlay_set_container_overlay,  "$g_show_inventory_selected_mesh", -1),
      (try_end),
      ]),
    (ti_on_presentation_mouse_enter_leave,
     [prsnt_generate_find_object_slot(),
      (store_trigger_param_2, ":leave"),
      (set_fixed_point_multiplier, 1000),
      (try_begin),
        (eq, ":leave", 1),
        (eq, "$g_show_inventory_item_details", ":found_obj_slot"),
        (assign, "$g_show_inventory_item_details", -1),
        (close_item_details),
      (else_try),
        (eq, ":leave", 0),
        (try_begin),
          (is_between, ":found_obj_slot", slot_scene_prop_inventory_obj_item_0, slot_scene_prop_inventory_mesh_begin),
          (store_sub, ":equip_slot", ":found_obj_slot", slot_scene_prop_inventory_obj_item_0 - ek_item_0),
          (multiplayer_get_my_player, ":player_id"),
          (try_begin),
            (player_is_active, ":player_id"),
            (player_get_agent_id, ":agent_id", ":player_id"),
            (agent_is_active, ":agent_id"),
            (agent_get_item_slot, ":item_id", ":agent_id", ":equip_slot"),
          (else_try),
            (assign, ":item_id", -1),
          (try_end),
        (else_try),
          (store_sub, ":inventory_slot", ":found_obj_slot", slot_scene_prop_inventory_obj_begin - slot_scene_prop_inventory_begin),
          (scene_prop_get_slot, ":item_id", "$g_show_inventory_instance_id", ":inventory_slot"),
        (try_end),
        (ge, ":item_id", all_items_begin),
        (try_begin),
          (gt, "$g_show_inventory_item_details", -1),
          (close_item_details),
        (try_end),
        (assign, "$g_show_inventory_item_details", ":found_obj_slot"),
        (overlay_get_position, pos1, ":object_id"),
        (show_item_details, ":item_id", pos1, 100),
      (try_end),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":cur_time"),
      (set_fixed_point_multiplier, 1000),
      (try_begin), # move the selected item with the mouse
        (gt, "$g_show_inventory_selected_mesh", -1),
        (mouse_get_position, pos1),
        (overlay_set_position, "$g_show_inventory_selected_mesh", pos1),
      (try_end),
      (try_begin),
        (key_clicked, key_escape),
        (gt, ":cur_time", 200),
        (assign, "$g_show_inventory_instance_id", 0),
        (multiplayer_send_message_to_server, client_event_transfer_inventory), # tell the server not to send any more updates for this inventory
        (presentation_set_duration, 0),
      (else_try), # end if the server signals or the item prop instance has been removed
        (this_or_next|eq, "$g_show_inventory_update_needed", -1),
        (this_or_next|neg|prop_instance_is_valid, "$g_show_inventory_instance_id"),
        (neg|scene_prop_slot_eq, "$g_show_inventory_instance_id", slot_scene_prop_inventory_unique_id, "$g_last_inventory_unique_id"),
        (assign, "$g_show_inventory_instance_id", 0),
        (presentation_set_duration, 0),
      (else_try), # if an update is signalled as necessary, check the inventory mod slots for changes
        (eq, "$g_show_inventory_update_needed", 1),
        (assign, "$g_show_inventory_update_needed", 0),
        (multiplayer_get_my_player, ":player_id"),
        (player_is_active, ":player_id"),
        (player_get_agent_id, ":agent_id", ":player_id"),
        (agent_is_active, ":agent_id"),
        (try_for_range, ":equip_slot", ek_item_0, ek_gloves + 1), # check and update the agent equipment slots
          (agent_get_item_slot, ":item_id", ":agent_id", ":equip_slot"),
          (store_add, ":inventory_slot", ":equip_slot", slot_scene_prop_inventory_item_0 - ek_item_0),
          (neg|scene_prop_slot_eq, "$g_show_inventory_instance_id", ":inventory_slot", ":item_id"),
          (store_add, ":inventory_mod_slot", ":equip_slot", slot_scene_prop_inventory_mod_item_0 - ek_item_0),
          (scene_prop_set_slot, "$g_show_inventory_instance_id", ":inventory_mod_slot", ":item_id"),
        (try_end),
        (try_for_range, ":added_mod_slot", slot_scene_prop_inventory_mod_begin, slot_scene_prop_inventory_mod_end), # check for items added to slots
          (scene_prop_get_slot, ":added_item_id", "$g_show_inventory_instance_id", ":added_mod_slot"),
          (ge, ":added_item_id", all_items_begin),
          (store_add, ":added_inventory_slot", ":added_mod_slot", slot_scene_prop_inventory_begin - slot_scene_prop_inventory_mod_begin),
          (scene_prop_set_slot, "$g_show_inventory_instance_id", ":added_inventory_slot", ":added_item_id"),
          (assign, ":mesh_object_id", -1),
          (assign, ":loop_end", slot_scene_prop_inventory_mod_end),
          (try_for_range, ":removed_mod_slot", slot_scene_prop_inventory_mod_begin, ":loop_end"), # check the removed slots for item meshes to reuse
            (scene_prop_slot_eq, "$g_show_inventory_instance_id", ":removed_mod_slot", -1),
            (store_add, ":removed_inventory_slot", ":removed_mod_slot", slot_scene_prop_inventory_begin - slot_scene_prop_inventory_mod_begin),
            (scene_prop_slot_eq, "$g_show_inventory_instance_id", ":removed_inventory_slot", ":added_item_id"),
            (assign, ":loop_end", -1),
            (scene_prop_set_slot, "$g_show_inventory_instance_id", ":removed_inventory_slot", -1),
            (scene_prop_set_slot, "$g_show_inventory_instance_id", ":removed_mod_slot", 0),
            (store_add, ":removed_mesh_slot", ":removed_mod_slot", slot_scene_prop_inventory_mesh_begin - slot_scene_prop_inventory_mod_begin),
            (scene_prop_get_slot, ":mesh_object_id", "$g_show_inventory_instance_id", ":removed_mesh_slot"),
            (scene_prop_set_slot, "$g_show_inventory_instance_id", ":removed_mesh_slot", -1),
          (try_end),
          (try_begin), # otherwise if an existing mesh for a removed item was not found, create a new one
            (le, ":mesh_object_id", -1),
            (create_mesh_overlay_with_item_id, ":mesh_object_id", ":added_item_id"),
          (try_end),
          (store_add, ":added_mesh_slot", ":added_mod_slot", slot_scene_prop_inventory_mesh_begin - slot_scene_prop_inventory_mod_begin),
          (scene_prop_set_slot, "$g_show_inventory_instance_id", ":added_mesh_slot", ":mesh_object_id"),
          (store_add, ":added_obj_slot", ":added_mod_slot", slot_scene_prop_inventory_obj_begin - slot_scene_prop_inventory_mod_begin),
          (scene_prop_get_slot, ":added_object_id", "$g_show_inventory_instance_id", ":added_obj_slot"),
          (overlay_set_display, ":mesh_object_id", 0),
          (try_begin), # if transferring into the scrollable container, calculate the slot position
            (is_between, ":added_inventory_slot", slot_scene_prop_inventory_begin, slot_scene_prop_inventory_item_0),
            (overlay_set_container_overlay,  ":mesh_object_id", "$g_show_inventory_obj_container"),
            (store_sub, ":added_slot_no", ":added_inventory_slot", slot_scene_prop_inventory_begin),
            (store_mod, ":added_mesh_x", ":added_slot_no", inventory_slots_per_row),
            (scene_prop_get_slot, ":inventory_count", "$g_show_inventory_instance_id", slot_scene_prop_inventory_count),
            (store_sub, ":added_mesh_y", ":inventory_count", ":added_slot_no"),
            (val_sub, ":added_mesh_y", 1),
            (val_div, ":added_mesh_y", inventory_slots_per_row),
            (store_mod, ":partial_line_count", ":inventory_count", inventory_slots_per_row),
            (try_begin),
              (ge, ":partial_line_count", 1),
              (ge, ":added_mesh_x", ":partial_line_count"),
              (val_add, ":added_mesh_y", 1),
            (try_end),
            (val_mul, ":added_mesh_x", inventory_slot_spacing),
            (val_mul, ":added_mesh_y", inventory_slot_spacing),
          (else_try), # transferring into agent equipment slots
            (overlay_set_container_overlay,  ":mesh_object_id", -1),
            (overlay_get_position, pos1, ":added_object_id"),
            (position_get_x, ":added_mesh_x", pos1),
            (position_get_y, ":added_mesh_y", pos1),
          (try_end),
          (val_add, ":added_mesh_x", inventory_mesh_offset),
          (val_add, ":added_mesh_y", inventory_mesh_offset),
          (position_set_x, pos1, ":added_mesh_x"),
          (position_set_y, pos1, ":added_mesh_y"),
          (overlay_set_position, ":mesh_object_id", pos1),
          (overlay_set_display, ":mesh_object_id", 1),
          (try_begin), # if the currently selected mesh was moved, drop it
            (this_or_next|eq, ":mesh_object_id", "$g_show_inventory_selected_mesh"),
            (is_between, ":added_mod_slot", slot_scene_prop_inventory_mod_item_0, slot_scene_prop_inventory_mod_end),
            (assign, "$g_show_inventory_selected_slot", -1),
            (assign, "$g_show_inventory_selected_mesh", -1),
          (try_end),
        (try_end),
        (try_for_range, ":removed_mod_slot", slot_scene_prop_inventory_mod_begin, slot_scene_prop_inventory_mod_end), # hide any unused meshes for removed items
          (scene_prop_get_slot, ":removed_mod", "$g_show_inventory_instance_id", ":removed_mod_slot"),
          (scene_prop_set_slot, "$g_show_inventory_instance_id", ":removed_mod_slot", 0),
          (eq, ":removed_mod", -1),
          (store_add, ":removed_inventory_slot", ":removed_mod_slot", slot_scene_prop_inventory_begin - slot_scene_prop_inventory_mod_begin),
          (scene_prop_set_slot, "$g_show_inventory_instance_id", ":removed_inventory_slot", -1),
          (scene_prop_set_slot, "$g_show_inventory_instance_id", ":removed_mod_slot", 0),
          (store_add, ":removed_mesh_slot", ":removed_mod_slot", slot_scene_prop_inventory_mesh_begin - slot_scene_prop_inventory_mod_begin),
          (scene_prop_get_slot, ":mesh_object_id", "$g_show_inventory_instance_id", ":removed_mesh_slot"),
          (scene_prop_set_slot, "$g_show_inventory_instance_id", ":removed_mesh_slot", -1),
          (gt, ":mesh_object_id", -1),
          (overlay_set_display, ":mesh_object_id", 0),
          (overlay_set_container_overlay,  ":mesh_object_id", -1),
        (try_end),
      (try_end),
      ]),
    ]),

  # $g_chat_box_string_id:
  # $g_chat_box_player_string_id: the prompt string to display above the text box if a player is targeted - s1 is replaced with the target's name
  # $g_target_player_id: the player name is inserted in the prompt string and sent with the network message to the server
  # $g_chat_box_event_type: network event number to send to the server associated with the string
  ("chat_box", prsntf_manual_end_only, 0, # text entry box for custom chat message types, emulating the look of the hard coded one
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),

      (try_begin),
        (gt, "$g_chat_box_player_string_id", 0),
        (gt, "$g_target_player_id", 0),
        (try_begin),
          (player_is_active, "$g_target_player_id"),
          (player_slot_eq, "$g_target_player_id", slot_player_list_button_id, "$g_target_player_overlay_id"),
        (else_try),
          (assign, "$g_target_player_id", 0),
        (try_end),
        (gt, "$g_target_player_id", 0),
        (str_store_player_username, s1, "$g_target_player_id"),
        (assign, ":title_string_id", "$g_chat_box_player_string_id"),
      (else_try),
        (assign, ":title_string_id", "$g_chat_box_string_id"),
      (try_end),
      (create_text_overlay, "$g_presentation_obj_chat_box_title", ":title_string_id"),
      (overlay_set_color, "$g_presentation_obj_chat_box_title", 0xFFFFFFFF),
      (position_set_x, pos1, 200),
      (position_set_y, pos1, 530),
      (overlay_set_position, "$g_presentation_obj_chat_box_title", pos1),
      (position_set_x, pos1, 1000),
      (position_set_y, pos1, 980),
      (overlay_set_size, "$g_presentation_obj_chat_box_title", pos1),

      (create_simple_text_box_overlay, "$g_presentation_obj_chat_box"),
      (position_set_x, pos1, 200),
      (position_set_y, pos1, 500),
      (overlay_set_position, "$g_presentation_obj_chat_box", pos1),
      (position_set_x, pos1, 600),
      (position_set_y, pos1, 1000),
      (overlay_set_size, "$g_presentation_obj_chat_box", pos1),
      (overlay_obtain_focus, "$g_presentation_obj_chat_box"),

      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_event_state_change,
     [(store_trigger_param_1, ":object"),
      (try_begin),
        (eq, ":object", "$g_presentation_obj_chat_box"),
        (try_begin),
          (neg|key_clicked, key_left_mouse_button),
          (neg|key_clicked, key_escape),
          (neg|str_is_empty, s0),
          (try_begin),
            (key_is_down, key_right_shift),
            (val_add, "$g_chat_box_event_type", 1),
          (try_end),
          (troop_get_slot, ":last_event", "trp_last_chat_message", slot_last_chat_message_event_type),
          (call_script, "script_chat_event_increment", ":last_event"), # increment the network event number sent from a looped range, to try detect missed and duplicated messages
          (assign, ":event", reg0),
          (val_min, "$g_chat_box_event_type", net_chat_event_mask),
          (assign, ":event_type", "$g_chat_box_event_type"),
          (val_lshift, ":event_type", net_chat_type_shift),
          (val_or, ":event", ":event_type"),
          (assign, ":continue", 1),
          (try_begin),
            (le, "$g_chat_box_player_string_id", 0),
          (else_try),
            (le, "$g_target_player_id", 0),
          (else_try),
            (player_is_active, "$g_target_player_id"),
            (player_slot_eq, "$g_target_player_id", slot_player_list_button_id, "$g_target_player_overlay_id"),
            (assign, ":target_player_id", "$g_target_player_id"),
            (val_lshift, ":target_player_id", net_chat_param_1_shift),
            (is_between, ":target_player_id", 0, net_value_upper_bound),
            (val_or, ":event", ":target_player_id"), # store target player id in upper bits of the event number
          (else_try),
            (assign, ":continue", 0),
          (try_end),
          (eq, ":continue", 1),
          (troop_set_slot, "trp_last_chat_message", slot_last_chat_message_event_type, ":event"),
          (troop_set_slot, "trp_last_chat_message", slot_last_chat_message_not_recieved, 1),
          (troop_set_name, "trp_last_chat_message", s0),
          (try_begin),
            (gt, ":event", net_chat_event_mask),
            (multiplayer_send_int_to_server, client_event_chat_message_type, ":event"),
          (try_end),
          (val_and, ":event", net_chat_event_mask),
          (multiplayer_send_string_to_server, ":event", s0),
        (try_end),
        (assign, "$g_chat_box_string_id", 0),
        (assign, "$g_chat_box_player_string_id", 0),
        (assign, "$g_chat_box_event_type", 0),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":cur_time"),
      (try_begin),
        (key_clicked, key_escape),
        (gt, ":cur_time", 200),
        (assign, "$g_chat_box_string_id", 0),
        (assign, "$g_chat_box_player_string_id", 0),
        (assign, "$g_chat_box_event_type", 0),
        (presentation_set_duration, 0),
      (else_try),
        (gt, "$g_chat_box_player_string_id", 0),
        (key_clicked, key_f11), # select player to target from a list
        (assign, "$g_list_players_event", -1),
        (assign, "$g_list_players_action_string_id", "str_send_message_to"),
        (assign, "$g_list_players_return_presentation", "prsnt_chat_box"),
        (start_presentation, "prsnt_list_players"),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    ]),

  ("chat_overlay", prsntf_read_only|prsntf_manual_end_only, 0, # displays recent lines of local or faction chat, to keep track of longer conversations
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),

      (create_mesh_overlay, reg1, "mesh_white_plane"),
      (overlay_set_color, reg1, 0x000000),
      (overlay_set_alpha, reg1, 0xCC),
      (position_set_x, pos1, 5),
      (position_set_y, pos1, 553),
      (overlay_set_position, reg1, pos1),
      (position_set_x, pos1, 42000),
      (position_set_y, pos1, 9500),
      (overlay_set_size, reg1, pos1),

      (create_text_overlay, reg1, "str_empty_string", tf_scrollable_style_2),
      (position_set_x, pos1, 0),
      (position_set_y, pos1, 553),
      (overlay_set_position, reg1, pos1),
      (position_set_x, pos1, 825),
      (position_set_y, pos1, 186),
      (overlay_set_area_size, reg1, pos1),
      (set_container_overlay, reg1),

      (store_add, "$g_presentation_obj_chat_overlay_begin", reg1, 1),
      (val_clamp, "$g_chat_overlay_local_buffer_stored", chat_overlay_ring_buffer_begin, chat_overlay_ring_buffer_end),
      (val_clamp, "$g_chat_overlay_faction_buffer_stored", chat_overlay_ring_buffer_begin, chat_overlay_ring_buffer_end),
      (assign, "$g_chat_overlay_ring_buffer_displayed", -1),
      (position_set_x, pos11, 750),
      (position_set_y, pos11, 750),
      (position_set_x, pos1, 0),
      (assign, ":current_y", 0),
      (try_for_range, ":unused", 0, chat_overlay_ring_buffer_size),
        (create_text_overlay, reg1, "str_empty_string", tf_with_outline),
        (overlay_set_size, reg1, pos11),
        (position_set_y, pos1, ":current_y"),
        (overlay_set_position, reg1, pos1),
        (val_add, ":current_y", chat_overlay_item_height),
      (try_end),

      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_run,
     [(try_begin),
        (eq, "$g_display_chat_overlay", 0),
        (presentation_set_duration, 0),
      (else_try),
        (assign, ":stored_buffer", -1),
        (try_begin),
          (eq, "$g_chat_overlay_type_selected", 0),
          (neq, "$g_chat_overlay_ring_buffer_displayed", "$g_chat_overlay_local_buffer_stored"),
          (assign, ":stored_buffer", "$g_chat_overlay_local_buffer_stored"),
        (else_try),
          (neq, "$g_chat_overlay_type_selected", 0),
          (neq, "$g_chat_overlay_ring_buffer_displayed", "$g_chat_overlay_faction_buffer_stored"),
          (assign, ":stored_buffer", "$g_chat_overlay_faction_buffer_stored"),
        (try_end),
        (gt, ":stored_buffer", -1),
        (assign, "$g_chat_overlay_ring_buffer_displayed", ":stored_buffer"),
        (assign, ":overlay_id", "$g_presentation_obj_chat_overlay_begin"),
        (try_for_range, ":chat_line_no", 0, chat_overlay_ring_buffer_size), # lines are stored in a ring buffer (of dummy troop names), overwriting the oldest first
          (store_sub, ":overlay_troop_id", ":stored_buffer", ":chat_line_no"),
          (try_begin),
            (lt, ":overlay_troop_id", chat_overlay_ring_buffer_begin),
            (val_add, ":overlay_troop_id", chat_overlay_ring_buffer_size),
          (try_end),
          (try_begin),
            (eq, "$g_chat_overlay_type_selected", 0),
            (str_store_troop_name, s0, ":overlay_troop_id"),
            (troop_get_slot, ":color", ":overlay_troop_id", slot_chat_overlay_local_color),
          (else_try),
            (str_store_troop_name_plural, s0, ":overlay_troop_id"),
            (troop_get_slot, ":color", ":overlay_troop_id", slot_chat_overlay_faction_color),
          (try_end),
          (overlay_set_text, ":overlay_id", s0),
          (overlay_set_color, ":overlay_id", ":color"),
          (val_add, ":overlay_id", 1),
        (try_end),
      (try_end),
      ]),
    ]),

  ("faction_banner_selection", prsntf_manual_end_only, 0, # display faction banners 16 at a time, redrawing the presentation for page changes
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),

      (create_text_overlay, reg1, "str_choose_faction_banner", tf_center_justify|tf_with_outline),
      (position_set_x, pos1, 500),
      (position_set_y, pos1, 600),
      (overlay_set_position, reg1, pos1),
      (overlay_set_color, reg1, 0xFFFFFF),

      (create_button_overlay, "$g_presentation_obj_faction_banner_next", "str_next", tf_center_justify|tf_with_outline),
      (position_set_x, pos1, 700),
      (position_set_y, pos1, 50),
      (overlay_set_position, "$g_presentation_obj_faction_banner_next", pos1),
      (overlay_set_color, "$g_presentation_obj_faction_banner_next", 0xFFFFFF),

      (create_button_overlay, "$g_presentation_obj_faction_banner_prev", "str_previous", tf_center_justify|tf_with_outline),
      (position_set_x, pos1, 300),
      (position_set_y, pos1, 50),
      (overlay_set_position, "$g_presentation_obj_faction_banner_prev", pos1),
      (overlay_set_color, "$g_presentation_obj_faction_banner_prev", 0xFFFFFF),

      (assign, ":x_pos", 150),
      (assign, ":y_pos", 575),
      (position_set_x, pos2, 100),
      (position_set_y, pos2, 100),
      (store_add, "$g_presentation_banner_start", "$g_presentation_obj_faction_banner_prev", 1),
      (store_mul, ":page_banners_begin", 16, "$g_presentation_faction_banner_page_no"),
      (val_add, ":page_banners_begin", banner_meshes_begin),
      (store_add, ":page_banners_end", ":page_banners_begin", 16),
      (val_min, ":page_banners_end", banner_meshes_end),
      (try_for_range, ":banner_mesh", ":page_banners_begin", ":page_banners_end"),
        (create_image_button_overlay, reg1, ":banner_mesh", ":banner_mesh"),
        (position_set_x, pos1, ":x_pos"),
        (position_set_y, pos1, ":y_pos"),
        (overlay_set_position, reg1, pos1),
        (overlay_set_size, reg1, pos2),
        (try_begin),
          (ge, ":x_pos", 800),
          (assign, ":x_pos", 150),
          (val_sub, ":y_pos", 250),
        (else_try),
          (val_add, ":x_pos", 100),
        (try_end),
      (try_end),

      (store_sub, "$g_presentation_faction_banner_page_count", banner_meshes_end, banner_meshes_begin),
      (store_mod, ":remainder", "$g_presentation_faction_banner_page_count", 16),
      (val_div, "$g_presentation_faction_banner_page_count", 16),
      (try_begin),
        (gt, ":remainder", 0),
        (val_add, "$g_presentation_faction_banner_page_count", 1),
      (try_end),
      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_event_state_change,
     [(store_trigger_param_1, ":object"),
      (try_begin),
        (eq, ":object", "$g_presentation_obj_faction_banner_next"),
        (val_add, "$g_presentation_faction_banner_page_no", 1),
        (val_mod, "$g_presentation_faction_banner_page_no", "$g_presentation_faction_banner_page_count"),
        (presentation_set_duration, 0),
        (start_presentation, "prsnt_faction_banner_selection"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_faction_banner_prev"),
        (val_sub, "$g_presentation_faction_banner_page_no", 1),
        (try_begin),
          (lt, "$g_presentation_faction_banner_page_no", 0),
          (store_sub, "$g_presentation_faction_banner_page_no", "$g_presentation_faction_banner_page_count", 1),
        (try_end),
        (presentation_set_duration, 0),
        (start_presentation, "prsnt_faction_banner_selection"),
      (else_try),
        (store_sub, ":selected_banner", ":object", "$g_presentation_banner_start"),
        (store_mul, ":page_offset", 16, "$g_presentation_faction_banner_page_no"),
        (val_add, ":selected_banner", ":page_offset"),
        (val_add, ":selected_banner", banner_meshes_begin),
        (try_begin),
          (is_between, ":selected_banner", banner_meshes_begin, banner_meshes_end),
          (multiplayer_send_2_int_to_server, client_event_faction_admin_action, faction_admin_action_change_banner, ":selected_banner"),
        (try_end),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":current_time"),
      (try_begin),
        (gt, ":current_time", 200),
        (key_clicked, key_escape),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    ]),

  ("money_bag", prsntf_manual_end_only, 0, # allows dropping money bags on the ground, and depositing to or withdrawing from nearby money chests
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),
      (neq, "$g_game_type", "mt_no_money"),

      (create_mesh_overlay, reg0, "mesh_mp_ui_welcome_panel"),
      (position_set_x, pos1, 260),
      (position_set_y, pos1, 300),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos2, 800),
      (position_set_y, pos2, 800),
      (overlay_set_size, reg0, pos2),

      (position_set_x, pos2, 900),
      (position_set_y, pos2, 900),

      (create_button_overlay, "$g_presentation_obj_money_bag_drop", "str_drop_money_bag"),
      (overlay_set_color, "$g_presentation_obj_money_bag_drop", 0xFFFFFF),
      (position_set_x, pos1, 280),
      (position_set_y, pos1, 416),
      (overlay_set_position, "$g_presentation_obj_money_bag_drop", pos1),
      (overlay_set_size, "$g_presentation_obj_money_bag_drop", pos2),

      (create_number_box_overlay, "$g_presentation_obj_money_bag_amount", 1, max_possible_gold),
      (position_set_x, pos1, 650),
      (position_set_y, pos1, 380),
      (overlay_set_position, "$g_presentation_obj_money_bag_amount", pos1),
      (overlay_set_size, "$g_presentation_obj_money_bag_amount", pos2),
      (multiplayer_get_my_player, ":my_player_id"),
      (try_begin),
        (le, "$g_presentation_money_bag_amount", 0),
        (player_get_gold, ":my_gold", ":my_player_id"),
        (assign, "$g_presentation_money_bag_amount", ":my_gold"),
      (try_end),
      (overlay_set_val, "$g_presentation_obj_money_bag_amount", "$g_presentation_money_bag_amount"),

      (create_button_overlay, "$g_presentation_obj_money_chest_deposit", "str_deposit_money_chest"),
      (overlay_set_color, "$g_presentation_obj_money_chest_deposit", 0xFFFFFF),
      (position_set_x, pos1, 280),
      (position_set_y, pos1, 392),
      (overlay_set_position, "$g_presentation_obj_money_chest_deposit", pos1),
      (overlay_set_size, "$g_presentation_obj_money_chest_deposit", pos2),

      (create_button_overlay, "$g_presentation_obj_money_chest_withdraw", "str_withdraw_money_chest"),
      (overlay_set_color, "$g_presentation_obj_money_chest_withdraw", 0xFFFFFF),
      (position_set_x, pos1, 280),
      (position_set_y, pos1, 368),
      (overlay_set_position, "$g_presentation_obj_money_chest_withdraw", pos1),
      (overlay_set_size, "$g_presentation_obj_money_chest_withdraw", pos2),

      (try_begin),
        (player_is_admin, ":my_player_id"),
        (player_slot_eq, ":my_player_id", slot_player_admin_no_gold, 0),
        (create_button_overlay, "$g_presentation_obj_money_bag_admin_cheat", "str_admin_cheat_money"),
        (overlay_set_color, "$g_presentation_obj_money_bag_admin_cheat", 0xFFFFFF),
        (position_set_x, pos1, 280),
        (position_set_y, pos1, 344),
        (overlay_set_position, "$g_presentation_obj_money_bag_admin_cheat", pos1),
        (overlay_set_size, "$g_presentation_obj_money_bag_admin_cheat", pos2),
      (else_try),
        (assign, "$g_presentation_obj_money_bag_admin_cheat", -1),
      (try_end),

      (create_button_overlay, "$g_presentation_obj_money_bag_done", "str_done"),
      (overlay_set_color, "$g_presentation_obj_money_bag_done", 0xFFFFFF),
      (position_set_x, pos1, 670),
      (position_set_y, pos1, 320),
      (overlay_set_position, "$g_presentation_obj_money_bag_done", pos1),
      (overlay_set_size, "$g_presentation_obj_money_bag_done", pos2),

      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_event_state_change,
     [(store_trigger_param_1, ":object"),
      (try_begin),
        (eq, ":object", "$g_presentation_obj_money_bag_amount"),
        (store_trigger_param_2, "$g_presentation_money_bag_amount"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_money_bag_drop"),
        (gt, "$g_presentation_money_bag_amount", 0),
        (try_begin),
          (gt, "$g_overflow_gold_value", max_correctly_displayed_gold),
          (assign, ":my_gold", "$g_overflow_gold_value"),
        (else_try),
          (multiplayer_get_my_player, ":my_player_id"),
          (player_get_gold, ":my_gold", ":my_player_id"),
        (try_end),
        (try_begin),
          (le, "$g_presentation_money_bag_amount", ":my_gold"),
          (multiplayer_send_int_to_server, client_event_drop_money_bag, "$g_presentation_money_bag_amount"),
        (else_try),
          (call_script, "script_preset_message", "str_dont_have_enough_money", preset_message_yellow|preset_message_fail_sound, 0, 0),
        (try_end),
      (else_try),
        (try_begin),
          (eq, ":object", "$g_presentation_obj_money_chest_deposit"),
          (assign, ":chest_transfer_gold", "$g_presentation_money_bag_amount"),
        (else_try),
          (eq, ":object", "$g_presentation_obj_money_chest_withdraw"),
          (store_mul, ":chest_transfer_gold", "$g_presentation_money_bag_amount", -1),
        (else_try),
          (assign, ":chest_transfer_gold", 0),
        (try_end),
        (neq, ":chest_transfer_gold", 0),
        (multiplayer_get_my_player, ":my_player_id"),
        (assign, ":fail_message", 0),
        (scene_prop_get_num_instances, ":chest_count", "spr_pw_castle_money_chest"),
        (try_for_range, ":chest_no", 0, ":chest_count"),
          (scene_prop_get_instance, ":instance_id", "spr_pw_castle_money_chest", ":chest_no"),
          (try_begin),
            (call_script, "script_cf_use_castle_money_chest", ":my_player_id", ":instance_id", ":chest_transfer_gold"),
            (assign, ":chest_count", -1),
          (else_try),
            (this_or_next|eq, ":fail_message", 0),
            (neq, reg0, "str_no_money_chest_nearby"),
            (assign, ":fail_message", reg0),
          (try_end),
        (try_end),
        (try_begin),
          (neq, ":chest_count", -1),
          (gt, ":fail_message", 0),
          (call_script, "script_preset_message", ":fail_message", preset_message_error, 0, 0),
        (try_end),
      (else_try),
        (eq, ":object", "$g_presentation_obj_money_bag_admin_cheat"),
        (store_mul, ":admin_cheat_amount", "$g_presentation_money_bag_amount", -1), # requesting to drop negative values = admin spawning money
        (multiplayer_send_int_to_server, client_event_drop_money_bag, ":admin_cheat_amount"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_money_bag_done"),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":current_time"),
      (try_begin),
        (gt, ":current_time", 200),
        (key_clicked, key_escape),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    ]),

  ("gold", prsntf_read_only|prsntf_manual_end_only, 0, # display the player's gold, using the correct value when the engine value has been corrupted by overflow
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),
      (neq, "$g_game_type", "mt_no_money"),

      (create_text_overlay, reg1, "str_empty_string", tf_right_align|tf_with_outline),
      (overlay_set_color, reg1, 0xFFDDD855),
      (position_set_x, pos1, 965),
      (position_set_y, pos1, 651),
      (overlay_set_position, reg1, pos1),
      (position_set_x, pos1, 1200),
      (position_set_y, pos1, 1200),
      (overlay_set_size, reg1, pos1),

      (assign, "$g_presentation_gold_current_value", -1),
      (presentation_set_duration, 9999999),
      ]),
    (ti_on_presentation_run,
     [(try_begin),
        (le, "$g_overflow_gold_value", max_correctly_displayed_gold),
        (multiplayer_get_my_player, ":player_id"),
        (player_is_active, ":player_id"),
        (player_get_gold, reg0, ":player_id"),
        (overlay_set_text, 0, "str_reg0"),
        (assign, "$g_presentation_gold_current_value", reg0),
      (else_try),
        (neq, "$g_presentation_gold_current_value", "$g_overflow_gold_value"),
        (assign, "$g_presentation_gold_current_value", "$g_overflow_gold_value"),
        (assign, reg0, "$g_overflow_gold_value"),
        (overlay_set_text, 0, "str_reg0"),
      (try_end),
      ]),
    ]),

  ("admin_item_select", prsntf_manual_end_only, 0, # allow admins to spawn any item for themselves
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),

      (create_mesh_overlay, reg0, "mesh_mp_ui_welcome_panel"),
      (position_set_x, pos1, 260),
      (position_set_y, pos1, 300),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos2, 800),
      (position_set_y, pos2, 800),
      (overlay_set_size, reg0, pos2),

      (position_set_x, pos2, 900),
      (position_set_y, pos2, 900),

      (create_text_overlay, reg1, "str_item_id"),
      (overlay_set_color, reg1, 0xFFFFFF),
      (position_set_x, pos1, 425),
      (position_set_y, pos1, 400),
      (overlay_set_position, reg1, pos1),
      (overlay_set_size, reg1, pos2),

      (create_number_box_overlay, "$g_presentation_obj_admin_item_select", all_items_begin, all_items_end),
      (position_set_x, pos1, 525),
      (position_set_y, pos1, 400),
      (overlay_set_position, "$g_presentation_obj_admin_item_select", pos1),
      (overlay_set_size, "$g_presentation_obj_admin_item_select", pos2),
      (val_clamp, "$g_presentation_admin_item_id", all_items_begin, all_items_end),
      (overlay_set_val, "$g_presentation_obj_admin_item_select", "$g_presentation_admin_item_id"),

      (str_store_item_name, s1, "$g_presentation_admin_item_id"),
      (create_button_overlay, "$g_presentation_obj_admin_item_equip", "str_spawn_s1", tf_center_justify),
      (overlay_set_color, "$g_presentation_obj_admin_item_equip", 0xFFFFFF),
      (position_set_x, pos1, 450),
      (position_set_y, pos1, 360),
      (overlay_set_position, "$g_presentation_obj_admin_item_equip", pos1),
      (position_set_x, pos1, 1200),
      (position_set_y, pos1, 1200),
      (overlay_set_size, "$g_presentation_obj_admin_item_equip", pos1),

      (create_button_overlay, "$g_presentation_obj_admin_item_done", "str_done"),
      (overlay_set_color, "$g_presentation_obj_admin_item_done", 0xFFFFFF),
      (position_set_x, pos1, 670),
      (position_set_y, pos1, 320),
      (overlay_set_position, "$g_presentation_obj_admin_item_done", pos1),
      (overlay_set_size, "$g_presentation_obj_admin_item_done", pos2),

      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_event_state_change,
     [(store_trigger_param_1, ":object"),
      (try_begin),
        (eq, ":object", "$g_presentation_obj_admin_item_select"),
        (store_trigger_param_2, "$g_presentation_admin_item_id"),
        (str_store_item_name, s1, "$g_presentation_admin_item_id"),
        (overlay_set_text, "$g_presentation_obj_admin_item_equip", "str_spawn_s1"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_item_equip"),
        (is_between, "$g_presentation_admin_item_id", all_items_begin, all_items_end),
        (multiplayer_send_int_to_server, client_event_admin_equip_item, "$g_presentation_admin_item_id"),
      (else_try),
        (eq, ":object", "$g_presentation_obj_admin_item_done"),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":current_time"),
      (try_begin),
        (gt, ":current_time", 200),
        (key_clicked, key_escape),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    ]),

  ("target_agent_name", prsntf_read_only|prsntf_manual_end_only, 0, # display the name of the currently targeted player or bot troop in the corner of the screen
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),
      (create_text_overlay, "$g_presentation_obj_target_agent_name", "str_empty_string", tf_right_align|tf_with_outline),
      (position_set_x, pos1, 990),
      (position_set_y, pos1, 700),
      (overlay_set_position, "$g_presentation_obj_target_agent_name", pos1),
      (position_set_x, pos1, 900),
      (position_set_y, pos1, 900),
      (overlay_set_size, "$g_presentation_obj_target_agent_name", pos1),
      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_run,
     [(try_begin),
        (agent_is_active, "$g_target_agent_id"),
        (agent_slot_eq, "$g_target_agent_id", slot_agent_is_targeted, 1),
        (try_begin),
          (neq, "$g_target_agent_id", "$g_last_target_agent_id"),
          (assign, "$g_last_target_agent_id", "$g_target_agent_id"),
          (try_begin),
            (agent_get_player_id, ":player_id", "$g_target_agent_id"),
            (player_is_active, ":player_id"),
            (str_store_player_username, s0, ":player_id"),
            (player_get_slot, ":player_faction_id", ":player_id", slot_player_faction_id),
            (faction_get_color, ":color", ":player_faction_id"),
          (else_try),
            (agent_get_troop_id, ":troop_id", "$g_target_agent_id"),
            (str_store_troop_name, s0, ":troop_id"),
            (assign, ":color", invalid_faction_color),
          (try_end),
          (overlay_set_color, "$g_presentation_obj_target_agent_name", ":color"),
          (overlay_set_text, "$g_presentation_obj_target_agent_name", "str_s0"),
        (try_end),
      (else_try),
        (assign, "$g_last_target_agent_id", -1),
        (game_key_is_down, gk_target_agent),
        (overlay_set_text, "$g_presentation_obj_target_agent_name", "str_empty_string"),
      (else_try),
        (presentation_set_duration, 0),
      (try_end),
      ]),
    ]),

  ("action_menu", prsntf_manual_end_only, 0, # quick menu for selecting various player actions and toggling some settings
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),

      (create_mesh_overlay, reg0, "mesh_mp_score_a"),
      (position_set_x, pos1, 655),
      (position_set_y, pos1, 125),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos1, 850),
      (position_set_y, pos1, 850),
      (overlay_set_size, reg0, pos1),

      (str_clear, s0),
      (create_text_overlay, reg0, s0, tf_scrollable_style_2),
      (position_set_x, pos1, 675),
      (position_set_y, pos1, 153),
      (overlay_set_position, reg0, pos1),
      (position_set_x, pos1, 270),
      (position_set_y, pos1, 445),
      (overlay_set_area_size, reg0, pos1),
      (set_container_overlay, reg0),

      (init_position, pos2),
      (position_set_x, pos2, 800),
      (position_set_y, pos2, 800),
      (assign, ":cur_y", 5),
      (position_set_x, pos1, 0),

      (str_store_string, s0, "str_confirmation"),
      (try_begin),
        (eq, "$g_action_menu_confirm", -1),
        (str_store_string, s0, "str_enable_s0"),
      (else_try),
        (str_store_string, s0, "str_disable_s0"),
      (try_end),
      (create_button_overlay, "$g_presentation_obj_action_menu_toggle_confirm", s0),
      (overlay_set_color, "$g_presentation_obj_action_menu_toggle_confirm", 0xFFFFFF),
      (overlay_set_size, "$g_presentation_obj_action_menu_toggle_confirm", pos2),
      (position_set_y, pos1, ":cur_y"),
      (overlay_set_position, "$g_presentation_obj_action_menu_toggle_confirm", pos1),
      (val_add, ":cur_y", action_menu_item_height),
      (val_clamp, "$g_action_menu_confirm", -1, 1),
      (assign, "$g_action_menu_confirm_overlay_id", -1),

      (try_for_range_backwards, ":string_id", action_menu_strings_begin, action_menu_strings_end),
        (create_button_overlay, reg0, ":string_id"),
        (overlay_set_color, reg0, 0xFFFFFF),
        (overlay_set_size, reg0, pos2),
        (position_set_y, pos1, ":cur_y"),
        (overlay_set_position, reg0, pos1),
        (val_add, ":cur_y", action_menu_item_height),
      (try_end),

      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_event_state_change,
     [(store_trigger_param_1, ":overlay_id"),
      (store_sub, ":string_id", action_menu_strings_end, ":overlay_id"),
      (val_add, ":string_id", "$g_presentation_obj_action_menu_toggle_confirm"),
      (assign, ":ask_confirm", 0),
      (try_begin),
        (eq, ":string_id", "str_toggle_name_labels"),
        (try_begin),
          (neg|is_presentation_active, "prsnt_display_agent_labels"),
          (assign, "$g_display_agent_labels", 1),
          (start_presentation, "prsnt_display_agent_labels"),
        (else_try),
          (assign, "$g_display_agent_labels", 0),
        (try_end),
      (else_try),
        (eq, ":string_id", "str_toggle_faction_in_name_labels"),
        (val_add, "$g_hide_faction_in_name_labels", 1),
        (val_mod, "$g_hide_faction_in_name_labels", 2),
      (else_try),
        (eq, ":string_id", "str_toggle_chat_overlay"),
        (try_begin),
          (neg|is_presentation_active, "prsnt_chat_overlay"),
          (assign, "$g_display_chat_overlay", 1),
          (start_presentation, "prsnt_chat_overlay"),
        (else_try),
          (assign, "$g_display_chat_overlay", 0),
        (try_end),
      (else_try),
        (eq, ":string_id", "str_toggle_local_faction_chat"),
        (assign, "$g_chat_overlay_ring_buffer_displayed", -1),
        (val_add, "$g_chat_overlay_type_selected", 1),
        (val_mod, "$g_chat_overlay_type_selected", 2),
      (else_try),
        (eq, ":string_id", "str_attach_cart_pack"),
        (try_begin),
          (multiplayer_get_my_player, ":my_player_id"),
          (player_is_active, ":my_player_id"),
          (player_get_agent_id, ":my_agent_id", ":my_player_id"),
          (agent_is_active, ":my_agent_id"),
          (agent_is_alive, ":my_agent_id"),
          (agent_get_wielded_item, ":weapon", ":my_agent_id", 0),
          (eq, ":weapon", -1),
          (agent_get_wielded_item, ":shield", ":my_agent_id", 1),
          (eq, ":shield", -1),
          (agent_get_attached_scene_prop, ":instance_id", ":my_agent_id"),
          (le, ":instance_id", 0),
          (set_fixed_point_multiplier, 100),
          (agent_get_position, pos1, ":my_agent_id"),
          (try_begin), # allow admins in special armor to attach carts from long distances, to retrieve them from inaccessible locations
            (player_is_admin, ":my_player_id"),
            (agent_get_item_slot, ":body_item_id", ":my_agent_id", ek_body),
            (this_or_next|eq, ":body_item_id", "itm_invisible_body"),
            (eq, ":body_item_id", "itm_black_armor"),
            (assign, ":maximum_sq_distance", sq(1000000)),
          (else_try),
            (assign, ":maximum_sq_distance", sq(max_distance_to_use)),
          (try_end),
          (assign, ":closest_sq_distance", ":maximum_sq_distance"),
          (troop_get_slot, ":loop_end", "trp_cart_array", slot_array_count),
          (val_add, ":loop_end", 1),
          (try_for_range, ":slot", slot_array_begin, ":loop_end"), # search for the nearest unattached cart
            (troop_get_slot, ":test_instance_id", "trp_cart_array", ":slot"),
            (scene_prop_get_slot, ":attached_agent_id", ":test_instance_id", slot_scene_prop_attached_to_agent),
            (try_begin),
              (agent_is_active, ":attached_agent_id"),
              (agent_get_attached_scene_prop, ":attached_instance_id", ":attached_agent_id"),
              (eq, ":attached_instance_id", ":test_instance_id"),
              (assign, ":test_instance_id", -1),
            (try_end),
            (prop_instance_is_valid, ":test_instance_id"),
            (prop_instance_get_position, pos2, ":test_instance_id"),
            (get_sq_distance_between_positions, ":sq_distance", pos1, pos2),
            (lt, ":sq_distance", ":closest_sq_distance"),
            (assign, ":closest_sq_distance", ":sq_distance"),
            (assign, ":instance_id", ":test_instance_id"),
          (try_end),
          (lt, ":closest_sq_distance", ":maximum_sq_distance"),
          (multiplayer_send_int_to_server, client_event_attach_scene_prop, ":instance_id"),
        (try_end),
      (else_try),
        (eq, ":string_id", "str_detach_cart_pack"),
        (try_begin),
          (multiplayer_get_my_player, ":my_player_id"),
          (player_is_active, ":my_player_id"),
          (player_get_agent_id, ":my_agent_id", ":my_player_id"),
          (agent_get_wielded_item, ":weapon", ":my_agent_id", 0),
          (eq, ":weapon", -1),
          (agent_get_wielded_item, ":shield", ":my_agent_id", 1),
          (eq, ":shield", -1),
          (multiplayer_send_message_to_server, client_event_attach_scene_prop),
        (try_end),
      (else_try),
        (eq, ":string_id", "str_toggle_head"),
        (multiplayer_send_int_to_server, client_event_toggle_drop_armor, ek_head),
      (else_try),
        (this_or_next|eq, ":string_id", "str_discard_body"),
        (eq, ":string_id", "str_discard_foot"),
        (try_begin),
          (neq, "$g_action_menu_confirm", -1),
          (neq, "$g_action_menu_confirm", ":string_id"),
          (assign, ":ask_confirm", 1),
        (else_try),
          (store_sub, ":equip_slot", ":string_id", "str_discard_body"),
          (val_add, ":equip_slot", ek_body),
          (multiplayer_send_int_to_server, client_event_toggle_drop_armor, ":equip_slot"),
        (try_end),
      (else_try),
        (eq, ":string_id", "str_toggle_hand"),
        (multiplayer_send_int_to_server, client_event_toggle_drop_armor, ek_gloves),
      (else_try),
        (eq, ":string_id", "str_reveal_money_pouch_to_target"),
        (multiplayer_get_my_player, ":my_player_id"),
        (assign, ":error_string_id", -1),
        (try_begin),
          (neq, "$g_game_type", "mt_no_money"),
          (player_is_active, ":my_player_id"),
          (player_get_agent_id, ":my_agent_id", ":my_player_id"),
          (agent_is_active, ":my_agent_id"),
          (agent_is_alive, ":my_agent_id"),
          (assign, ":error_string_id", "str_no_target_selected"),
          (agent_is_active, "$g_target_agent_id"),
          (agent_is_alive, "$g_target_agent_id"),
          (agent_slot_eq, "$g_target_agent_id", slot_agent_is_targeted, 1),
          (agent_get_player_id, ":target_player_id", "$g_target_agent_id"),
          (player_is_active, ":target_player_id"),
          (agent_get_position, pos1, ":my_agent_id"),
          (agent_get_position, pos2, "$g_target_agent_id"),
          (get_sq_distance_between_positions, ":sq_distance", pos1, pos2),
          (assign, ":error_string_id", "str_your_target_too_far_away"),
          (lt, ":sq_distance", sq(max_distance_to_use)),
          (multiplayer_send_int_to_server, client_event_reveal_money_pouch, "$g_target_agent_id"),
        (else_try),
          (gt, ":error_string_id", -1),
          (call_script, "script_preset_message", ":error_string_id", preset_message_error, 0, 0),
        (try_end),
      (else_try),
        (eq, ":string_id", "str_toggle_clickable_animation_menu"),
        (val_add, "$g_animation_menu_no_mouse_grab", 1),
        (val_mod, "$g_animation_menu_no_mouse_grab", 2),
      (else_try),
        (eq, ":string_id", "str_toggle_muting_global_chat"),
        (val_add, "$g_mute_global_chat", 1),
        (val_mod, "$g_mute_global_chat", 2),
        (get_max_players, ":max_players"),
        (try_for_range, ":other_player_id", 1, ":max_players"),
          (player_is_active, ":other_player_id"),
          (player_set_is_muted, ":other_player_id", "$g_mute_global_chat"),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, "$g_action_menu_confirm", action_menu_strings_begin, action_menu_strings_end),
        (overlay_set_text, "$g_action_menu_confirm_overlay_id", "$g_action_menu_confirm"),
        (assign, "$g_action_menu_confirm", 0),
        (assign, "$g_action_menu_confirm_overlay_id", -1),
      (try_end),
      (try_begin),
        (eq, ":overlay_id", "$g_presentation_obj_action_menu_toggle_confirm"),
        (str_store_string, s0, "str_confirmation"),
        (try_begin),
          (le, "$g_action_menu_confirm", -1),
          (assign, "$g_action_menu_confirm", 0),
          (assign, ":confirm_string_id", "str_disable_s0"),
        (else_try),
          (assign, "$g_action_menu_confirm", -1),
          (assign, ":confirm_string_id", "str_enable_s0"),
        (try_end),
        (overlay_set_text, ":overlay_id", ":confirm_string_id"),
      (try_end),
      (try_begin),
        (eq, ":ask_confirm", 1),
        (assign, "$g_action_menu_confirm", ":string_id"),
        (assign, "$g_action_menu_confirm_overlay_id", ":overlay_id"),
        (str_store_string, s0, ":string_id"),
        (overlay_set_text, ":overlay_id", "str_s0_are_you_sure"),
      (try_end),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":current_time"),
      (try_begin),
        (gt, ":current_time", 200),
        (neg|game_key_is_down, gk_action_menu),
        (presentation_set_duration, 0),
        (val_min, "$g_action_menu_confirm", 0),
      (try_end),
      ]),
    ]),

  ("food_bar", prsntf_read_only|prsntf_manual_end_only, 0, # bar showing the player agent's current food amount, below the health bar
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 10000),

      (create_mesh_overlay, "$g_presentation_obj_food_bar", "mesh_pw_status_food_bar"),
      (position_set_x, pos1, 8603),
      (position_set_y, pos1, 681),
      (overlay_set_position, "$g_presentation_obj_food_bar", pos1),
      (overlay_set_display, "$g_presentation_obj_food_bar", 0),
      (assign, "$g_presentation_food_bar_current_amount", -1),

      (create_mesh_overlay, "$g_presentation_obj_food_bar_background", "mesh_pw_status_background_player"),
      (overlay_set_position, "$g_presentation_obj_food_bar_background", pos1),
      (overlay_set_display, "$g_presentation_obj_food_bar_background", 0),

      (presentation_set_duration, 9999999),
      ]),
    (ti_on_presentation_run,
     [(set_fixed_point_multiplier, max_food_amount),
      (multiplayer_get_my_player, ":player_id"),
      (try_begin),
        (player_is_active, ":player_id"),
        (player_get_agent_id, ":agent_id", ":player_id"),
        (agent_is_active, ":agent_id"),
        (agent_is_alive, ":agent_id"),
        (agent_get_slot, ":food_amount", ":agent_id", slot_agent_food_amount),
        (try_begin),
          (neq, "$g_presentation_food_bar_current_amount", ":food_amount"),
          (assign, "$g_presentation_food_bar_current_amount", ":food_amount"),
          (val_max, ":food_amount", 1),
          (position_set_x, pos1, ":food_amount"),
          (position_set_y, pos1, max_food_amount),
          (overlay_set_size, "$g_presentation_obj_food_bar", pos1),
          (overlay_set_display, "$g_presentation_obj_food_bar", 1),
          (overlay_set_display, "$g_presentation_obj_food_bar_background", 1),
        (try_end),
      (else_try),
        (gt, "$g_presentation_food_bar_current_amount", -1),
        (assign, "$g_presentation_food_bar_current_amount", -1),
        (overlay_set_display, "$g_presentation_obj_food_bar", 0),
        (overlay_set_display, "$g_presentation_obj_food_bar_background", 0),
      (try_end),
      ]),
    ]),

  ("scene_prop_hit_points_bar", prsntf_read_only|prsntf_manual_end_only, 0, # bar showing the targeted scene prop's current hit points
   [(ti_on_presentation_load,
     [(set_fixed_point_multiplier, 10000),

      (create_mesh_overlay, "$g_presentation_scene_prop_hit_points_bar", "mesh_pw_progress_bar"),
      (position_set_x, pos1, 3000),
      (position_set_y, pos1, 2700),
      (overlay_set_position, "$g_presentation_scene_prop_hit_points_bar", pos1),
      (position_set_x, pos1, scene_prop_hit_points_bar_scale_x),
      (position_set_y, pos1, scene_prop_hit_points_bar_scale_y),
      (overlay_set_size, "$g_presentation_scene_prop_hit_points_bar", pos1),
      (overlay_set_display, "$g_presentation_scene_prop_hit_points_bar", 0),

      (create_mesh_overlay, "$g_presentation_scene_prop_hit_points_bar_fill", "mesh_pw_progress_bar_fill"),
      (position_set_x, pos1, 3000),
      (position_set_y, pos1, 2700),
      (overlay_set_position, "$g_presentation_scene_prop_hit_points_bar_fill", pos1),
      (position_set_x, pos1, scene_prop_hit_points_bar_scale_x),
      (position_set_y, pos1, scene_prop_hit_points_bar_scale_y),
      (overlay_set_size, "$g_presentation_scene_prop_hit_points_bar_fill", pos1),
      (overlay_set_display, "$g_presentation_scene_prop_hit_points_bar_fill", 0),

      (presentation_set_duration, 9999999),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":current_time"),
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (gt, "$g_scene_prop_full_hit_points", 0),
        (store_mul, ":hit_points_value", "$g_scene_prop_hit_points", scene_prop_hit_points_bar_scale_x),
        (val_div, ":hit_points_value", "$g_scene_prop_full_hit_points"),
        (val_clamp, ":hit_points_value", 1, scene_prop_hit_points_bar_scale_x),
        (position_set_x, pos1, ":hit_points_value"),
        (position_set_y, pos1, scene_prop_hit_points_bar_scale_y),
        (overlay_set_size, "$g_presentation_scene_prop_hit_points_bar_fill", pos1),
        (overlay_set_display, "$g_presentation_scene_prop_hit_points_bar", 1),
        (overlay_set_display, "$g_presentation_scene_prop_hit_points_bar_fill", 1),
        (assign, "$g_scene_prop_full_hit_points", 0),
        (store_add, "$g_scene_prop_hit_points_bar_hide_time", ":current_time", 200),
      (else_try),
        (gt, "$g_show_hit_points_instance_id", -1),
        (gt, ":current_time", "$g_scene_prop_hit_points_bar_hide_time"),
        (overlay_set_display, "$g_presentation_scene_prop_hit_points_bar", 0),
        (overlay_set_display, "$g_presentation_scene_prop_hit_points_bar_fill", 0),
        (assign, "$g_show_hit_points_instance_id", -1),
      (try_end),
      ]),
    ]),

  ])

prsnt_animation_menu_triggers = [ # common triggers for the animation menu presentations below
    (ti_on_presentation_load,
     [(set_fixed_point_multiplier, 1000),

      (troop_get_slot, ":begin_string_id", "trp_animation_menu_strings", "$g_animation_menu_selected"),
      (store_add, ":end_slot", "$g_animation_menu_selected", animation_menu_end_offset),
      (troop_get_slot, ":end_string_id", "trp_animation_menu_strings", ":end_slot"),
      (store_sub, ":menu_items_count", ":end_string_id", ":begin_string_id"),
      (try_begin), # end if the current sub menu selected has no entries
        (le, ":menu_items_count", 0),
        (assign, "$g_animation_menu_selected", 0),
        (assign, "$g_presentation_obj_animation_menu_begin", 0),
        (assign, "$g_presentation_obj_animation_menu_end", 0),
      (try_end),
      (gt, ":menu_items_count", 0),

      (position_set_x, pos10, 1000),
      (position_set_y, pos10, 800),
      (assign, ":y_pos", 500),
      (try_for_range, reg0, ":begin_string_id", ":end_string_id"),
        (create_mesh_overlay, reg1, "mesh_mp_ui_order_button"),
        (position_set_x, pos1, 5),
        (position_set_y, pos1, ":y_pos"),
        (overlay_set_position, reg1, pos1),
        (overlay_set_size, reg1, pos10),
        (val_sub, ":y_pos", animation_menu_item_height),
      (try_end),

      (position_set_x, pos10, 800),
      (store_add, "$g_presentation_obj_animation_menu_begin", reg1, 1),
      (assign, ":y_pos", 508),
      (assign, reg0, 1),
      (assign, ":key", key_1),
      (try_for_range, ":string_id", ":begin_string_id", ":end_string_id"), # create the buttons with consecutive overlay ids, after all frames
        (str_store_string, s0, ":string_id"),
        (create_button_overlay, reg1, "str_reg0__s0"),
        (overlay_set_color, reg1, 0xFFFFFF),
        (position_set_x, pos1, 10),
        (position_set_y, pos1, ":y_pos"),
        (overlay_set_position, reg1, pos1),
        (overlay_set_size, reg1, pos10),
        (val_sub, ":y_pos", animation_menu_item_height),
        (val_add, reg0, 1),
        (omit_key_once, ":key"),
        (val_add, ":key", 1),
      (try_end),
      (store_add, "$g_presentation_obj_animation_menu_end", reg1, 1),

      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_event_state_change,
     [(store_trigger_param_1, ":overlay_id"),
      (is_between, ":overlay_id", "$g_presentation_obj_animation_menu_begin", "$g_presentation_obj_animation_menu_end"),
      (store_sub, ":menu_item", ":overlay_id", "$g_presentation_obj_animation_menu_begin"),
      (try_begin), # main menu: show a sub menu
        (eq, "$g_animation_menu_selected", 0),
        (clear_omitted_keys),
        (presentation_set_duration, 0),
        (start_presentation, "prsnt_animation_menu"),
        (store_add, "$g_animation_menu_selected", ":menu_item", 1),
      (else_try), # animation entry clicked on
        (troop_get_slot, ":string_id", "trp_animation_menu_strings", "$g_animation_menu_selected"),
        (val_add, ":string_id", ":menu_item"),
        (multiplayer_get_my_player, ":my_player_id"),
        (player_is_active, ":my_player_id"),
        (call_script, "script_cf_try_execute_animation", ":my_player_id", ":string_id", 0),
        (clear_omitted_keys),
        (presentation_set_duration, 0),
        (assign, "$g_animation_menu_selected", 0),
      (try_end),
      ]),
    (ti_on_presentation_run,
     [(store_trigger_param_1, ":current_time"),
      (try_begin),
        (gt, ":current_time", 200),
        (key_clicked, key_escape),
        (clear_omitted_keys),
        (presentation_set_duration, 0),
        (assign, "$g_animation_menu_selected", 0),
      (else_try),
        (multiplayer_get_my_player, ":my_player_id"),
        (player_is_active, ":my_player_id"),
        (assign, ":key", key_1),
        (assign, ":loop_end", "$g_presentation_obj_animation_menu_end"),
        (try_for_range, ":overlay_id", "$g_presentation_obj_animation_menu_begin", ":loop_end"),
          (store_sub, ":menu_item", ":overlay_id", "$g_presentation_obj_animation_menu_begin"),
          (troop_get_slot, ":string_id", "trp_animation_menu_strings", "$g_animation_menu_selected"),
          (val_add, ":string_id", ":menu_item"),
          (try_begin), # check pressed number keys, to select menu entries
            (key_clicked, ":key"),
            (try_begin),
              (eq, "$g_animation_menu_selected", 0),
              (assign, ":loop_end", -1),
              (clear_omitted_keys),
              (presentation_set_duration, 0),
              (store_add, "$g_animation_menu_selected", ":menu_item", 1),
              (try_begin),
                (eq, "$g_animation_menu_no_mouse_grab", 1),
                (start_presentation, "prsnt_animation_menu_no_mouse_grab"),
              (else_try),
                (start_presentation, "prsnt_animation_menu"),
              (try_end),
            (else_try),
              (call_script, "script_cf_try_execute_animation", ":my_player_id", ":string_id", 0),
              (assign, ":loop_end", -1),
              (clear_omitted_keys),
              (presentation_set_duration, 0),
              (assign, "$g_animation_menu_selected", 0),
            (else_try),
              (omit_key_once, ":key"),
            (try_end),
          (try_end),
          (neq, ":loop_end", -1),
          (val_add, ":key", 1),
          (try_begin), # check if the animation can currently be played, coloring the text differently depending on the result
            (call_script, "script_cf_try_execute_animation", ":my_player_id", ":string_id", 1),
            (try_begin),
              (this_or_next|eq, "$g_animation_menu_selected", 0),
              (ge, reg0, 2),
              (overlay_set_color, ":overlay_id", 0xFFFFFF),
            (else_try),
              (ge, reg0, 1),
              (overlay_set_color, ":overlay_id", 0xCC5555),
            (else_try),
              (overlay_set_color, ":overlay_id", 0x888888),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      ]),
    ]

presentations.extend([

  ("animation_menu", prsntf_manual_end_only, 0, prsnt_animation_menu_triggers), # animation menu that grabs mouse input, and can be clicked on
  ("animation_menu_no_mouse_grab", prsntf_manual_end_only|prsntf_read_only, 0, prsnt_animation_menu_triggers), # animation menu that doesn't grab input, entries being selected with number keys

  ("dbg_overlay", prsntf_manual_end_only|prsntf_read_only, 0, # an overlay for repeatedly displaying values for debugging without cluttering up the chat log
   [(ti_on_presentation_load,
     [(assign, "$g_dbg_presentation_overlays_end", 0),
      (presentation_set_duration, 999999),
      ]),
    (ti_on_presentation_run,
     [(set_fixed_point_multiplier, 1000),
      (assign, ":overlay_id", 0),
      (try_for_range, ":string_register", dbg.register_begin, "$g_dbg_presentation_registers_end"),
        (str_store_string_reg, s0, ":string_register"),
        (try_begin),
          (lt, ":overlay_id", "$g_dbg_presentation_overlays_end"),
          (overlay_set_text, ":overlay_id", s0),
        (else_try),
          (create_text_overlay, reg0, s0, tf_right_align|tf_with_outline),
          (position_set_x, pos1, 990),
          (store_mul, ":height", ":overlay_id", 20),
          (val_add, ":height", 150),
          (position_set_y, pos1, ":height"),
          (overlay_set_position, reg0, pos1),
          (position_set_x, pos1, 900),
          (position_set_y, pos1, 900),
          (overlay_set_size, reg0, pos1),
          (overlay_set_color, reg0, 0xFFFFFFFF),
          (val_add, "$g_dbg_presentation_overlays_end", 1),
        (try_end),
        (val_add, ":overlay_id", 1),
      (try_end),
      (try_for_range, ":blank_overlay_id", ":overlay_id", "$g_dbg_presentation_overlays_end"),
        (overlay_set_text, ":blank_overlay_id", "str_no_string"),
      (try_end),
      ]),
    ]),

  ])
